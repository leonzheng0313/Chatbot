# ChatPersona - AI人格社交实验平台

## 🚀 快速开始

### 环境要求
- Python 3.8+
- pip 包管理器
- 网络连接（用于API调用）

### 安装与启动

1. **进入项目目录**
```bash
cd d:\工作\WPS\AI\trae\Chatbot
```

2. **安装依赖**
```bash
pip install -r requirements.txt
```

3. **启动应用**
```bash
python app.py
```

4. **访问应用**
- 打开浏览器访问：http://localhost:5001

## 📖 产品简介

ChatPersona 是一个基于大模型的多角色对话应用，专为Z世代年轻人设计的AI人格社交实验平台。用户可以创建具有独特性格的AI角色，并与多个角色进行群聊互动，同时支持多种创新玩法。

## ✨ 产品亮点

### 🧠 智能人格创建器（Persona Maker）
- **标签式配置**：通过选择性格关键词、语言风格、角色类型自动生成角色提示词
- **自定义Prompt**：手动填写完整的系统提示词，享受更高的自由度
- **实时预览**：支持角色效果预览功能
- **默认角色保护**：内置角色不可编辑，确保体验一致性

### 👥 多角色群聊（Multi-Agent Role Chat）
- **多角色互动**：可邀请多个AI角色组成聊天室
- **实时对话**：支持轮流发言，模拟真实群聊体验
- **动画效果**：头像跳动、"正在输入..."动画等丰富的视觉反馈
- **角色记忆**：AI角色能记住对话历史，保持人格一致性

### 🎮 创新游戏模式
- **谁是卧底**：AI角色参与的推理游戏，每个角色保持独特性格进行描述和投票
- **心灵小屋**：情感治愈空间，提供心理支持和正能量内容
- **词库管理**：支持自定义游戏词汇，AI智能生成词汇对

### 🔐 安全与管理
- **API Key 管理**：支持用户自填阿里云百炼API Key，安全存储
- **用户权限系统**：管理员和普通用户分级管理
- **内容安全检测**：智能识别和拦截不当内容
- **提示词注入防护**：防止恶意提示词攻击

### ⚠️ 智能风险控制
- **话题锚定**：监控对话是否偏离原始主题
- **人格一致性**：确保AI角色保持设定的性格特征
- **实时安全检测**：多层安全防护机制

## 🛠️ 技术架构

- **后端框架**：Flask + SQLite
- **前端技术**：HTML + Tailwind CSS + JavaScript
- **AI服务**：阿里云百炼·千问大模型（qwen-plus）
- **数据库**：SQLite（轻量级，易部署）
- **安全检测**：DeepSeek-V3（提示词注入检测）
- **图像生成**：阿里云百炼万相（wanx2.1-t2i-turbo）

## 🔧 ToolUse 功能

### AI工具调用能力
ChatPersona 集成了多种AI工具调用功能，提供丰富的交互体验：

#### 🎨 图像生成工具
- **模型**：阿里云百炼万相（wanx2.1-t2i-turbo）
- **功能**：根据文本描述生成高质量图像
- **应用场景**：心灵小屋的治愈图像生成
- **参数配置**：支持1024x1024分辨率，可自定义生成参数

#### 🛡️ 安全检测工具
- **模型**：DeepSeek-V3
- **功能**：实时检测提示词注入攻击
- **检测范围**：用户输入、角色创建、游戏词汇
- **响应机制**：自动拦截并提示用户修改

#### 🤖 智能生成工具
- **词汇对生成**：AI自动生成"谁是卧底"游戏词汇对
- **角色提示词生成**：基于标签自动生成角色系统提示词
- **内容优化**：智能优化对话内容和角色表现

#### 📊 分析评估工具
- **话题相似度分析**：检测对话是否偏离主题
- **人格一致性评估**：确保AI角色保持性格特征
- **风险评分**：实时评估内容安全等级

### 工具调用流程
1. **输入处理**：接收用户请求和上下文信息
2. **工具选择**：根据任务类型自动选择合适的AI工具
3. **参数构建**：构建工具调用所需的参数
4. **结果处理**：处理工具返回结果并整合到应用中
5. **错误处理**：提供完善的错误处理和重试机制

## 使用指南

### 1. 创建AI角色

#### 标签式创建
1. 点击"创建新角色"
2. 选择"标签式配置"
3. 从预设标签中选择性格、语言风格、角色类型
4. 系统自动生成角色提示词
5. 点击"创建角色"

#### 自定义Prompt创建
1. 选择"自定义Prompt"
2. 在文本框中输入详细的角色设定
3. 可点击"预览效果"查看角色表现
4. 确认后创建角色

### 2. 开始群聊
1. 在首页点击"开始聊天"
2. 点击"选择角色"选择参与聊天的AI角色
3. 输入话题或问题
4. 观看AI角色们的精彩互动

### 3. API Key设置
1. 点击导航栏的"API设置"
2. 输入你的阿里云百炼API Key
3. 保存设置

## 默认角色介绍

应用内置了三个示例角色：

| 角色 | 性格特点 | 简介 |
|------|----------|------|
| 吉伊 | 敏感、胆小、善良 | 努力想变强，时常哭但很可爱 |
| 小八 | 搞笑、机灵、温和 | 反应快，是气氛担当 |
| 乌萨奇 | 热血、冲动、自信 | 喜欢冒险和主导谈话 |

## 📡 API接口文档

### 角色管理 API
- `GET /api/characters` - 获取所有角色列表（包含is_default字段）
- `POST /api/create-character` - 创建新角色（支持标签式和自定义）
- `POST /api/generate-preview` - 生成角色预览
- `PUT /api/update-character/<id>` - 更新角色信息（默认角色受保护）
- `DELETE /api/delete-character/<id>` - 删除角色
- `POST /api/generate-character-prompt` - 基于标签生成角色提示词

### 聊天功能 API
- `POST /api/chat` - 发送消息并获取AI回复
- `POST /api/set-api-key` - 设置API Key
- `GET /api/chat-history/<session_id>` - 获取聊天历史
- `DELETE /api/clear-chat/<session_id>` - 清除聊天记录

### 游戏功能 API
- `POST /api/game/start` - 开始谁是卧底游戏
- `POST /api/game/generate-description` - 生成角色描述
- `POST /api/game/ai-vote` - AI角色投票
- `POST /api/game/vote` - 玩家投票
- `GET /api/game/words` - 获取游戏词库
- `POST /api/game/words` - 添加词汇对
- `POST /api/game/words/generate` - AI生成词汇对
- `DELETE /api/game/words/<id>` - 删除词汇对

### 心灵小屋功能 API
- `POST /api/sanctuary/generate-image` - 生成治愈图像
- `POST /api/sanctuary/chat` - 心灵小屋模式对话

### 安全检测 API
- `POST /api/topic-anchor-check` - 检查话题偏离度
- `POST /api/persona-score` - 评估人格一致性
- `POST /api/security-check` - 提示词注入检测

### 用户管理 API
- `POST /api/login` - 用户登录
- `POST /api/logout` - 用户登出
- `GET /api/user/profile` - 获取用户信息
- `PUT /api/user/profile` - 更新用户信息

## 项目结构

```
Chatbot/
├── app.py                 # Flask主应用
├── requirements.txt       # Python依赖
├── README.md             # 项目文档
├── chatpersona.db        # SQLite数据库（运行时生成）
└── templates/            # HTML模板
    ├── index.html        # 首页 - 角色列表
    ├── create.html       # 创建角色页面
    └── chat.html         # 群聊界面
```

## 开发说明

### 数据库结构

#### characters 表
- `id`: 角色ID（主键）
- `name`: 角色名称
- `personality`: 性格标签
- `description`: 角色描述
- `system_prompt`: 系统提示词
- `avatar_url`: 头像URL（预留）
- `created_at`: 创建时间

#### chat_history 表
- `id`: 消息ID（主键）
- `session_id`: 会话ID
- `character_id`: 角色ID
- `message`: 消息内容
- `sender`: 发送者
- `timestamp`: 时间戳

#### api_config 表
- `id`: 配置ID（主键）
- `user_session`: 用户会话
- `api_key`: API密钥
- `model_name`: 模型名称
- `created_at`: 创建时间

### 自定义配置

可以通过修改以下变量来自定义应用：

```python
# app.py 中的配置
app.secret_key = 'your_secret_key'  # 会话密钥
DEFAULT_API_KEY = 'your_default_api_key'  # 默认API Key
DEFAULT_MODEL = 'qwen-plus'  # 默认模型
```

## 注意事项

1. **API Key安全**：请妥善保管你的阿里云API Key，不要在代码中硬编码
2. **模型限制**：请注意阿里云百炼的API调用限制和费用
3. **数据备份**：重要的角色和聊天记录请及时备份
4. **网络环境**：确保网络能够访问阿里云API服务

## 故障排除

### 常见问题

**Q: API调用失败怎么办？**
A: 检查API Key是否正确，网络是否正常，API额度是否充足

**Q: 角色回复不符合预期？**
A: 尝试优化角色的系统提示词，使其更加详细和具体

**Q: 数据库错误？**
A: 删除 `chatpersona.db` 文件，重启应用会自动重新创建

**Q: 页面样式异常？**
A: 检查网络连接，确保能够加载Tailwind CSS CDN

## 🎮 游戏玩法详解

### 谁是卧底模式
1. **游戏设置**：选择3-6个AI角色参与游戏
2. **词汇分配**：系统随机分配平民词和卧底词
3. **描述回合**：每个AI角色用自己的性格风格描述词汇
4. **投票淘汰**：根据描述投票选出最可疑的角色
5. **胜负判定**：卧底存活到最后2人则胜利

### 心灵小屋治愈模式
1. **情感支持**：提供心理安慰和正能量内容
2. **图像生成**：根据用户情绪生成治愈系图像
3. **个性化回应**：AI角色提供温暖的陪伴和建议

## 🔧 配置说明

### API Key 配置
- **环境变量**：设置 `QWEN_API_KEY` 环境变量
- **界面配置**：在应用中通过"API设置"页面配置
- **默认支持**：提供默认API Key供体验使用

### 模型配置
- **对话模型**：qwen-plus（主要对话生成）
- **安全模型**：deepseek-v3（内容安全检测）
- **图像模型**：wanx2.1-t2i-turbo（图像生成）

## 📊 性能优化

### 缓存机制
- **API缓存**：5分钟API响应缓存
- **安全检测缓存**：1小时安全检测结果缓存
- **会话管理**：7天会话有效期

### 并发控制
- **最大角色数**：单次聊天最多10个角色
- **历史记录**：最多保存100条聊天记录
- **文件上传**：最大16MB文件大小限制

## 🛡️ 安全特性

### 多层安全防护
1. **输入验证**：严格的用户输入验证
2. **提示词注入检测**：AI驱动的安全检测
3. **内容过滤**：实时内容安全监控
4. **访问控制**：用户权限分级管理
5. **会话安全**：安全的会话令牌管理

### 隐私保护
- **本地存储**：所有数据存储在本地SQLite数据库
- **API Key加密**：安全存储用户API密钥
- **会话隔离**：用户会话完全隔离

## 📈 更新日志

### v2.0.0 (2024-12)
- ✨ 新增谁是卧底游戏模式
- ✨ 新增心灵小屋治愈模式
- ✨ 新增用户权限系统
- ✨ 新增默认角色保护机制
- 🛡️ 增强安全检测功能
- 🎨 优化UI界面和用户体验
- 🔧 完善API接口文档

### v1.0.0 (2024-01)
- 🎉 初始版本发布
- 👥 支持角色创建和多角色群聊
- 🔗 集成阿里云百炼API
- ⚠️ 实现基础的风险控制机制

## 🤝 贡献指南

欢迎提交Issue和Pull Request来改进项目！

### 开发环境搭建
1. Fork 项目到你的GitHub账户
2. 克隆项目到本地
3. 安装开发依赖
4. 创建功能分支
5. 提交代码并创建Pull Request

## 📄 许可证

本项目采用 MIT 许可证。详见 [LICENSE](LICENSE) 文件。

## 📞 技术支持

如有问题或建议，请通过以下方式联系：
- 🐛 **Bug报告**：提交GitHub Issue
- 💡 **功能建议**：提交GitHub Issue
- 📧 **技术咨询**：[leonzhengwork@163.com]
- 📚 **文档问题**：查看项目Wiki

---

**🎭 开始你的AI人格社交之旅吧！** ✨

> ChatPersona - 让每个AI都有独特的灵魂 💫