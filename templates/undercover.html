<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Persona Undercover - è°æ˜¯å§åº•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'bounce-slow': 'bounce 2s infinite',
                        'pulse-slow': 'pulse 3s infinite',
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'typing': 'typing 1.5s ease-in-out infinite',
                        'bounce-gentle': 'bounce 1s ease-in-out 3'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        },
                        typing: {
                            '0%, 60%, 100%': { opacity: '1' },
                            '30%': { opacity: '0.4' }
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gradient-to-br from-red-50 to-orange-100 min-h-screen">
    <!-- å¯¼èˆªæ  -->
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 bg-gradient-to-r from-red-500 to-orange-600 rounded-full flex items-center justify-center">
                        <span class="text-white font-bold text-sm">ğŸ•µï¸</span>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-800">Persona Undercover</h1>
                </div>
                <div class="flex space-x-4">
                    <a href="/" class="bg-gray-100 hover:bg-gray-200 px-3 sm:px-4 py-2 rounded-lg text-xs sm:text-sm font-medium transition text-center">
                        â† è¿”å›é¦–é¡µ
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="max-w-6xl mx-auto px-4 py-8">
        <!-- æ¸¸æˆæ ‡é¢˜ -->
        <div class="text-center mb-8">
            <h2 class="text-4xl font-bold text-gray-800 mb-4">ğŸ­ è°æ˜¯å§åº•</h2>
            <p class="text-gray-600 text-lg">AIäººæ ¼æ¨ç†æ¸¸æˆ - å‘ç°éšè—åœ¨äººç¾¤ä¸­çš„å§åº•</p>
        </div>

        <!-- æ¸¸æˆè®¾ç½®åŒºåŸŸ -->
        <div id="gameSetup" class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h3 class="text-2xl font-bold text-gray-800 mb-6">ğŸ® æ¸¸æˆè®¾ç½®</h3>
            
            <!-- è§’è‰²é€‰æ‹© -->
            <div class="mb-6">
                <h4 class="text-lg font-semibold text-gray-700 mb-3">é€‰æ‹©å‚ä¸è§’è‰² (3-6ä¸ª)</h4>
                <div id="characterList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- è§’è‰²åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                </div>
                <div id="selectedCharacters" class="mt-4">
                    <p class="text-sm text-gray-600">å·²é€‰æ‹©è§’è‰²: <span id="selectedCount">0</span>/6</p>
                    <div id="selectedList" class="flex flex-wrap gap-2 mt-2"></div>
                </div>
            </div>

            <!-- è¯è¯­è®¾ç½® -->
            <div class="mb-6">
                <div class="flex justify-between items-center mb-3">
                    <h4 class="text-lg font-semibold text-gray-700">ğŸ“ è¯è¯­è®¾ç½®</h4>
                    <a href="/words" target="_blank" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center space-x-2">
                        <span>ğŸ“š</span>
                        <span>è¯åº“ç®¡ç†</span>
                    </a>
                </div>
                <div class="flex items-center space-x-4 mb-4">
                    <label class="flex items-center">
                        <input type="radio" name="wordMode" value="system" checked class="mr-2" onchange="toggleWordMode()">
                        <span class="text-sm font-medium text-gray-700">ä½¿ç”¨ç³»ç»Ÿè¯åº“</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="wordMode" value="custom" class="mr-2" onchange="toggleWordMode()">
                        <span class="text-sm font-medium text-gray-700">è‡ªå®šä¹‰è¯è¯­</span>
                    </label>
                </div>
                
                <!-- è‡ªå®šä¹‰è¯è¯­è¾“å…¥åŒºåŸŸ -->
                <div id="customWordArea" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 rounded-lg">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å¹³æ°‘è¯</label>
                            <input type="text" id="customPublicWord" placeholder="è¯·è¾“å…¥å¹³æ°‘è¯" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å§åº•è¯</label>
                            <input type="text" id="customUndercoverWord" placeholder="è¯·è¾“å…¥å§åº•è¯" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">ğŸ’¡ æç¤ºï¼šé€‰æ‹©ç›¸ä¼¼ä½†æœ‰åŒºåˆ«çš„è¯è¯­ï¼Œå¦‚"ç»ç’ƒæ¯"å’Œ"æ°´æ¯"</p>
                </div>
            </div>

            <!-- æ¸¸æˆè®¾ç½® -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div id="difficultySection">
                    <label class="block text-sm font-medium text-gray-700 mb-2">æ¸¸æˆéš¾åº¦</label>
                    <select id="difficulty" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                        <option value="easy">ç®€å•</option>
                        <option value="medium" selected>ä¸­ç­‰</option>
                        <option value="hard">å›°éš¾</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">æœ€å¤§å›åˆæ•°</label>
                    <select id="maxRounds" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                        <option value="2">2è½®</option>
                        <option value="3" selected>3è½®</option>
                        <option value="4">4è½®</option>
                        <option value="5">5è½®</option>
                    </select>
                </div>
            </div>

            <!-- å¼€å§‹æ¸¸æˆæŒ‰é’® -->
            <div class="text-center">
                <button id="startGameBtn" onclick="startGame()" class="bg-gradient-to-r from-red-500 to-orange-600 hover:from-red-600 hover:to-orange-700 text-white px-8 py-3 rounded-lg text-lg font-semibold transition transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                    ğŸš€ å¼€å§‹æ¸¸æˆ
                </button>
            </div>
        </div>

        <!-- æ¸¸æˆè¿›è¡ŒåŒºåŸŸ -->
        <div id="gameArea" class="hidden">
            <!-- æ¸¸æˆä¿¡æ¯å¡ç‰‡ -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold text-gray-800">ğŸ¯ æ¸¸æˆè¿›è¡Œä¸­</h3>
                    <div class="text-right">
                        <p class="text-sm text-gray-600">å½“å‰å›åˆ: <span id="currentRound">1</span>/<span id="totalRounds">3</span></p>
                        <p class="text-sm text-gray-600">å‰©ä½™è§’è‰²: <span id="remainingCount">0</span></p>
                    </div>
                </div>
                
                <!-- è¯æ±‡æç¤º (ä»…ç©å®¶å¯è§) -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4 mb-4">
                    <h4 class="font-semibold text-gray-700 mb-2">ğŸ“ è¯æ±‡ä¿¡æ¯ (ä»…ä½ å¯è§)</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-green-100 rounded-lg p-3">
                            <p class="text-sm text-gray-600">å…¬å…±è¯</p>
                            <p class="text-lg font-bold text-green-700" id="publicWord">-</p>
                        </div>
                        <div class="bg-red-100 rounded-lg p-3">
                            <p class="text-sm text-gray-600">å§åº•è¯</p>
                            <p class="text-lg font-bold text-red-700" id="undercoverWord">-</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä¸»è¦æ¸¸æˆå†…å®¹åŒºåŸŸ - 4:1å¸ƒå±€ -->
            <div class="flex gap-6 mb-6">
                <!-- å·¦ä¾§ï¼šè§’è‰²å‘è¨€å’ŒæŠ•ç¥¨åŒºåŸŸ (4/5) -->
                <div class="flex-1" style="flex: 4;">
                    <!-- è§’è‰²å‘è¨€åŒºåŸŸ -->
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <h4 class="text-xl font-bold text-gray-800 mb-4">ğŸ’¬ è§’è‰²å‘è¨€</h4>
                        <div id="characterDescriptions" class="space-y-4">
                            <!-- è§’è‰²å‘è¨€å°†åŠ¨æ€æ·»åŠ  -->
                        </div>
                        
                        <!-- ç”Ÿæˆæè¿°æŒ‰é’® -->
                        <div class="text-center mt-6">
                            <button id="generateDescBtn" onclick="generateAllDescriptions()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-medium transition hidden">
                                ğŸ­ ç”Ÿæˆæ‰€æœ‰è§’è‰²æè¿°
                            </button>
                        </div>
                    </div>

                    <!-- æŠ•ç¥¨åŒºåŸŸ -->
                    <div id="votingArea" class="bg-white rounded-xl shadow-lg p-6 hidden">
                        <h4 class="text-xl font-bold text-gray-800 mb-4">ğŸ—³ï¸ AIè§’è‰²æŠ•ç¥¨</h4>
                        <div id="votingOptions">
                            <!-- AIæŠ•ç¥¨å†…å®¹å°†åŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>

                <!-- å³ä¾§ï¼šæ¸¸æˆå†å²è®°å½• (1/5) -->
                <div class="flex-1" style="flex: 1;">
                    <div id="gameHistory" class="bg-white rounded-xl shadow-lg p-4 sticky top-4">
                        <h4 class="text-lg font-bold text-gray-800 mb-3">ğŸ“œ æ¸¸æˆå†å²</h4>
                        <div id="historyContent" class="space-y-2 max-h-96 overflow-y-auto text-sm">
                            <!-- æ¸¸æˆå†å²å°†åŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åŠ è½½æç¤º -->
    <div id="loadingModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-red-500 mx-auto mb-4"></div>
            <p class="text-gray-700">æ­£åœ¨ç”ŸæˆAIæè¿°...</p>
        </div>
    </div>

    <!-- æ¸¸æˆç»“æœå¼¹çª— -->
    <div id="gameResultModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4 transform transition-all">
            <div class="text-center">
                <h4 class="text-3xl font-bold mb-6" id="resultTitle">ğŸ‰ æ¸¸æˆç»“æŸ</h4>
                <div id="resultContent" class="text-lg text-gray-700 mb-8">
                    <!-- ç»“æœå†…å®¹å°†åŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div class="flex space-x-4 justify-center">
                    <button onclick="closeGameResult()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold transition">
                        ğŸ“Š æŸ¥çœ‹è¯¦æƒ…
                    </button>
                    <button onclick="resetGame()" class="bg-gradient-to-r from-green-500 to-blue-600 hover:from-green-600 hover:to-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition transform hover:scale-105">
                        ğŸ”„ é‡æ–°å¼€å§‹
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ç”Ÿæˆå¤´åƒHTML
        function generateAvatarHtml(character, sizeClass = 'w-10 h-10') {
            const avatarType = character.avatar_type || 'initial';
            const avatarValue = character.avatar_value;
            const textSize = sizeClass.includes('w-12') ? 'text-xl' : sizeClass.includes('w-8') ? 'text-sm' : 'text-base';
            const emojiSize = sizeClass.includes('w-12') ? 'text-xl' : sizeClass.includes('w-8') ? 'text-lg' : 'text-2xl';
            
            if (avatarType === 'emoji' && avatarValue) {
                return `<div class="${sizeClass} bg-gray-100 rounded-full flex items-center justify-center ${emojiSize}">${avatarValue}</div>`;
            } else if (avatarType === 'upload' && avatarValue) {
                return `<div class="${sizeClass} rounded-full overflow-hidden"><img src="${avatarValue}" alt="${character.name}" class="w-full h-full object-cover"></div>`;
            } else {
                // é»˜è®¤ä½¿ç”¨é¦–å­—æ¯å¤´åƒï¼ˆç»Ÿä¸€ä½¿ç”¨ç´«è‰²èƒŒæ™¯ï¼‰
                return `<div class="${sizeClass} bg-indigo-400 rounded-full flex items-center justify-center text-white ${textSize} font-bold">${character.name.charAt(0)}</div>`;
            }
        }

        let gameState = {
            sessionId: null,
            characters: [],
            selectedCharacters: [],
            currentRound: 1,
            maxRounds: 3,
            eliminated: [],
            gameOver: false,
            undercoverIndex: -1
        };

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadCharacters();
        });

        // åˆ‡æ¢è¯è¯­æ¨¡å¼
        function toggleWordMode() {
            const wordMode = document.querySelector('input[name="wordMode"]:checked').value;
            const customWordArea = document.getElementById('customWordArea');
            const difficultySection = document.getElementById('difficultySection');
            
            if (wordMode === 'custom') {
                customWordArea.classList.remove('hidden');
                difficultySection.classList.add('opacity-50');
                document.getElementById('difficulty').disabled = true;
            } else {
                customWordArea.classList.add('hidden');
                difficultySection.classList.remove('opacity-50');
                document.getElementById('difficulty').disabled = false;
            }
        }

        // åŠ è½½è§’è‰²åˆ—è¡¨
        async function loadCharacters() {
            try {
                const response = await fetch('/api/characters');
                const characters = await response.json();
                gameState.characters = characters;
                displayCharacters(characters);
            } catch (error) {
                console.error('åŠ è½½è§’è‰²å¤±è´¥:', error);
                alert('åŠ è½½è§’è‰²å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        }

        // æ˜¾ç¤ºè§’è‰²åˆ—è¡¨
        function displayCharacters(characters) {
            const container = document.getElementById('characterList');
            container.innerHTML = '';
            
            characters.forEach((character, index) => {
                const characterCard = document.createElement('div');
                characterCard.className = 'border border-gray-200 rounded-lg p-4 cursor-pointer hover:border-red-300 hover:bg-red-50 transition';
                characterCard.onclick = () => toggleCharacterSelection(character, characterCard);
                
                characterCard.innerHTML = `
                    <div class="flex items-center space-x-3">
                        ${generateAvatarHtml(character, 'w-12 h-12')}
                        <div class="flex-1">
                            <h5 class="font-semibold text-gray-800">${character.name}</h5>
                            <p class="text-sm text-gray-600">${character.personality}</p>
                        </div>
                        <div class="w-6 h-6 border-2 border-gray-300 rounded-full flex items-center justify-center">
                            <div class="w-3 h-3 bg-red-500 rounded-full hidden"></div>
                        </div>
                    </div>
                `;
                
                container.appendChild(characterCard);
            });
        }

        // åˆ‡æ¢è§’è‰²é€‰æ‹©
        function toggleCharacterSelection(character, cardElement) {
            const isSelected = gameState.selectedCharacters.some(c => c.id === character.id);
            
            if (isSelected) {
                // å–æ¶ˆé€‰æ‹©
                gameState.selectedCharacters = gameState.selectedCharacters.filter(c => c.id !== character.id);
                cardElement.classList.remove('border-red-500', 'bg-red-100');
                cardElement.querySelector('.w-3').classList.add('hidden');
            } else {
                // é€‰æ‹©è§’è‰²
                if (gameState.selectedCharacters.length >= 6) {
                    alert('æœ€å¤šåªèƒ½é€‰æ‹©6ä¸ªè§’è‰²');
                    return;
                }
                gameState.selectedCharacters.push(character);
                cardElement.classList.add('border-red-500', 'bg-red-100');
                cardElement.querySelector('.w-3').classList.remove('hidden');
            }
            
            updateSelectedDisplay();
        }

        // æ›´æ–°å·²é€‰æ‹©è§’è‰²æ˜¾ç¤º
        function updateSelectedDisplay() {
            const countElement = document.getElementById('selectedCount');
            const listElement = document.getElementById('selectedList');
            const startBtn = document.getElementById('startGameBtn');
            
            countElement.textContent = gameState.selectedCharacters.length;
            
            listElement.innerHTML = '';
            gameState.selectedCharacters.forEach(character => {
                const tag = document.createElement('span');
                tag.className = 'bg-red-100 text-red-800 px-2 py-1 rounded-full text-sm';
                tag.textContent = character.name;
                listElement.appendChild(tag);
            });
            
            // å¯ç”¨/ç¦ç”¨å¼€å§‹æŒ‰é’®
            startBtn.disabled = gameState.selectedCharacters.length < 3;
        }

        // å¼€å§‹æ¸¸æˆ
        async function startGame() {
            if (gameState.selectedCharacters.length < 3) {
                alert('è‡³å°‘éœ€è¦é€‰æ‹©3ä¸ªè§’è‰²');
                return;
            }
            
            const wordMode = document.querySelector('input[name="wordMode"]:checked').value;
            const difficulty = document.getElementById('difficulty').value;
            const maxRounds = parseInt(document.getElementById('maxRounds').value);
            
            let gameData = {
                characters: gameState.selectedCharacters,
                max_rounds: maxRounds
            };
            
            // æ£€æŸ¥è¯è¯­æ¨¡å¼
            if (wordMode === 'custom') {
                const publicWord = document.getElementById('customPublicWord').value.trim();
                const undercoverWord = document.getElementById('customUndercoverWord').value.trim();
                
                if (!publicWord || !undercoverWord) {
                    alert('è¯·è¾“å…¥å¹³æ°‘è¯å’Œå§åº•è¯');
                    return;
                }
                
                if (publicWord === undercoverWord) {
                    alert('å¹³æ°‘è¯å’Œå§åº•è¯ä¸èƒ½ç›¸åŒ');
                    return;
                }
                
                gameData.custom_words = {
                    public_word: publicWord,
                    undercover_word: undercoverWord
                };
            } else {
                gameData.difficulty = difficulty;
            }
            
            try {
                const response = await fetch('/api/game/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(gameData)
                });
                
                const result = await response.json();
                
                // æ£€æŸ¥æ˜¯å¦æœ‰å®‰å…¨è­¦å‘Š
                if (result.security_warning) {
                    alert(result.message || 'æ£€æµ‹åˆ°ä¸å®‰å…¨çš„è¾“å…¥å†…å®¹ï¼Œè¯·é‡æ–°è¾“å…¥');
                    return;
                }
                
                if (response.ok) {
                    gameState.sessionId = result.session_id;
                    gameState.currentRound = result.current_round;
                    gameState.maxRounds = result.max_rounds;
                    gameState.undercoverIndex = result.undercover_index;
                    
                    // æ·»åŠ æ¸¸æˆå¼€å§‹æµå¼æ¶ˆæ¯
                    addGameFlowMessage('ğŸ® æ¸¸æˆå¼€å§‹ï¼');
                    addGameFlowMessage(`ğŸ“ æœ¬è½®è¯è¯­ï¼šå¹³æ°‘è¯ã€Œ${result.public_word}ã€ï¼Œå§åº•è¯ã€Œ${result.undercover_word}ã€`);
                    addGameFlowMessage(`ğŸ‘¥ ${gameState.selectedCharacters.length}ä¸ªè§’è‰²å‚ä¸æ¸¸æˆï¼Œå…¶ä¸­${gameState.selectedCharacters[result.undercover_index].name}æ˜¯å§åº•`);
                    
                    // æ˜¾ç¤ºæ¸¸æˆåŒºåŸŸ
                    document.getElementById('gameSetup').classList.add('hidden');
                    document.getElementById('gameArea').classList.remove('hidden');
                    document.getElementById('gameHistory').classList.remove('hidden');
                    
                    // æ›´æ–°æ¸¸æˆä¿¡æ¯
                    document.getElementById('currentRound').textContent = result.current_round;
                    document.getElementById('totalRounds').textContent = result.max_rounds;
                    document.getElementById('remainingCount').textContent = gameState.selectedCharacters.length;
                    document.getElementById('publicWord').textContent = result.public_word;
                    document.getElementById('undercoverWord').textContent = result.undercover_word;
                    
                    // åˆå§‹åŒ–è§’è‰²æè¿°åŒºåŸŸ
                    initializeDescriptionArea();
                    
                    // è‡ªåŠ¨å¼€å§‹ç”Ÿæˆæè¿°
                    setTimeout(() => {
                        generateAllDescriptions();
                    }, 1000);
                } else {
                    alert(result.error || 'å¼€å§‹æ¸¸æˆå¤±è´¥');
                }
            } catch (error) {
                console.error('å¼€å§‹æ¸¸æˆå¤±è´¥:', error);
                alert('å¼€å§‹æ¸¸æˆå¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // åˆå§‹åŒ–æè¿°åŒºåŸŸ
        function initializeDescriptionArea() {
            const container = document.getElementById('characterDescriptions');
            container.innerHTML = '';
            
            gameState.selectedCharacters.forEach((character, index) => {
                const descCard = document.createElement('div');
                descCard.className = 'border border-gray-200 rounded-lg p-4';
                descCard.id = `desc-${index}`;
                
                const isEliminated = gameState.eliminated.includes(index);
                const eliminatedClass = isEliminated ? 'opacity-50 bg-gray-100' : '';
                
                descCard.innerHTML = `
                    <div class="flex items-center space-x-3 mb-3 ${eliminatedClass}">
                        ${generateAvatarHtml(character, 'w-10 h-10')}
                        <div class="flex-1">
                            <h5 class="font-semibold text-gray-800">${character.name}</h5>
                            <p class="text-sm text-gray-600">${character.personality}</p>
                        </div>
                        ${isEliminated ? '<span class="text-red-500 font-bold">å·²æ·˜æ±°</span>' : ''}
                    </div>
                    <div class="bg-gray-50 rounded-lg p-3">
                        <p class="text-gray-600" id="desc-text-${index}">ç­‰å¾…ç”Ÿæˆæè¿°...</p>
                    </div>
                `;
                
                container.appendChild(descCard);
            });
        }

        // ç”Ÿæˆæ‰€æœ‰è§’è‰²æè¿°
        async function generateAllDescriptions() {
            // æ·»åŠ æµå¼æç¤º
            addGameFlowMessage(`ğŸ­ ç¬¬ ${gameState.currentRound} è½®å¼€å§‹ï¼Œè§’è‰²ä»¬æ­£åœ¨æ€è€ƒæè¿°...`);
            
            document.getElementById('generateDescBtn').disabled = true;
            
            let successCount = 0;
            let totalCount = gameState.selectedCharacters.filter((_, i) => !gameState.eliminated.includes(i)).length;
            
            for (let i = 0; i < gameState.selectedCharacters.length; i++) {
                if (!gameState.eliminated.includes(i)) {
                    const character = gameState.selectedCharacters[i];
                    addGameFlowMessage(`ğŸ’­ ${character.name} æ­£åœ¨æ€è€ƒ...`);
                    
                    try {
                        await generateCharacterDescription(i);
                        addGameFlowMessage(`ğŸ’¬ ${character.name} å®Œæˆäº†æè¿°`);
                        successCount++;
                    } catch (error) {
                        console.error(`è§’è‰²${i}ç”Ÿæˆå¤±è´¥:`, error);
                        // é”™è¯¯å·²åœ¨generateCharacterDescriptionä¸­å¤„ç†
                    }
                    
                    // æ·»åŠ å»¶è¿Ÿé¿å…APIè°ƒç”¨è¿‡å¿«ï¼Œå¹¶è®©ç”¨æˆ·çœ‹åˆ°æµç¨‹
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            if (successCount > 0) {
                addGameFlowMessage(`ğŸ“Š ${successCount}/${totalCount} è§’è‰²æè¿°å®Œæˆï¼Œå‡†å¤‡å¼€å§‹AIæŠ•ç¥¨...`);
                
                // å»¶è¿Ÿæ˜¾ç¤ºæŠ•ç¥¨åŒºåŸŸï¼Œè®©ç”¨æˆ·æœ‰æ—¶é—´é˜…è¯»æè¿°
                setTimeout(() => {
                    showVotingArea();
                }, 2000);
            } else {
                addGameFlowMessage(`âŒ æ‰€æœ‰è§’è‰²æè¿°ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–APIé…ç½®`);
                alert('æ‰€æœ‰è§’è‰²æè¿°ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
            }
            
            document.getElementById('generateDescBtn').disabled = false;
        }

        // ç”Ÿæˆå•ä¸ªè§’è‰²æè¿°
        async function generateCharacterDescription(characterIndex, retryCount = 0) {
            const textElement = document.getElementById(`desc-text-${characterIndex}`);
            const maxRetries = 2;
            
            // æ˜¾ç¤ºç”Ÿæˆä¸­çš„åŠ¨ç”»
            textElement.innerHTML = `
                <div class="flex items-center space-x-2">
                    <span>æ­£åœ¨ç”Ÿæˆæè¿°${retryCount > 0 ? ` (é‡è¯•${retryCount})` : ''}</span>
                    <div class="flex space-x-1">
                        <div class="w-2 h-2 bg-blue-400 rounded-full animate-typing"></div>
                        <div class="w-2 h-2 bg-blue-400 rounded-full animate-typing" style="animation-delay: 0.2s"></div>
                        <div class="w-2 h-2 bg-blue-400 rounded-full animate-typing" style="animation-delay: 0.4s"></div>
                    </div>
                </div>
            `;
            textElement.className = 'text-blue-600';
            
            try {
                const response = await fetch('/api/game/describe', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session_id: gameState.sessionId,
                        character_index: characterIndex
                    })
                });
                
                const result = await response.json();
                
                // æ£€æŸ¥æ˜¯å¦æœ‰å®‰å…¨è­¦å‘Š
                if (result.security_warning) {
                    textElement.textContent = result.message || 'æ£€æµ‹åˆ°ä¸å®‰å…¨çš„å†…å®¹';
                    textElement.className = 'text-red-500';
                    addGameFlowMessage(`âš ï¸ ${gameState.selectedCharacters[characterIndex].name} å†…å®¹ä¸å®‰å…¨`);
                    throw new Error('å®‰å…¨è­¦å‘Š');
                }
                
                if (response.ok && result.description && result.description.trim()) {
                    textElement.textContent = result.description;
                    textElement.className = 'text-gray-800 animate-fade-in';
                } else {
                    throw new Error(result.error || 'ç”Ÿæˆæè¿°å¤±è´¥æˆ–å†…å®¹ä¸ºç©º');
                }
            } catch (error) {
                console.error(`è§’è‰²${characterIndex}æè¿°ç”Ÿæˆå¤±è´¥:`, error);
                
                // é‡è¯•æœºåˆ¶
                if (retryCount < maxRetries) {
                    addGameFlowMessage(`âš ï¸ ${gameState.selectedCharacters[characterIndex].name} ç”Ÿæˆå¤±è´¥ï¼Œæ­£åœ¨é‡è¯•...`);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    return await generateCharacterDescription(characterIndex, retryCount + 1);
                } else {
                    textElement.textContent = 'ç”Ÿæˆå¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°';
                    textElement.className = 'text-red-500';
                    addGameFlowMessage(`âŒ ${gameState.selectedCharacters[characterIndex].name} ç”Ÿæˆå¤±è´¥`);
                    throw error;
                }
            }
        }

        // æ˜¾ç¤ºæŠ•ç¥¨åŒºåŸŸ
        function showVotingArea() {
            const votingArea = document.getElementById('votingArea');
            const votingOptions = document.getElementById('votingOptions');
            
            votingOptions.innerHTML = `
                <div class="text-center py-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ—³ï¸ AIè§’è‰²æŠ•ç¥¨ç¯èŠ‚</h3>
                    <p class="text-gray-600 mb-6">AIè§’è‰²ä»¬æ­£åœ¨åˆ†æå‘è¨€ï¼Œå‡†å¤‡è¿›è¡ŒæŠ•ç¥¨...</p>
                    <button onclick="startAIVoting()" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-lg font-medium transition">
                        å¼€å§‹AIæŠ•ç¥¨
                    </button>
                </div>
            `;
            
            votingArea.classList.remove('hidden');
        }

        // å¼€å§‹AIæŠ•ç¥¨
        async function startAIVoting() {
            const votingOptions = document.getElementById('votingOptions');
            
            // æ·»åŠ æµå¼æ¶ˆæ¯
            addGameFlowMessage('ğŸ—³ï¸ å¼€å§‹AIæŠ•ç¥¨é˜¶æ®µ...');
            addGameFlowMessage('ğŸ¤” AIè§’è‰²ä»¬æ­£åœ¨åˆ†ææ‰€æœ‰å‘è¨€...');
            
            // æ˜¾ç¤ºæŠ•ç¥¨è¿›è¡Œä¸­çš„ç•Œé¢
            votingOptions.innerHTML = `
                <div class="text-center py-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ—³ï¸ AIè§’è‰²æŠ•ç¥¨ä¸­...</h3>
                    <div class="flex justify-center items-center space-x-2 mb-6">
                        <div class="w-3 h-3 bg-red-400 rounded-full animate-bounce"></div>
                        <div class="w-3 h-3 bg-red-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                        <div class="w-3 h-3 bg-red-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
                    </div>
                    <p class="text-gray-600">AIè§’è‰²ä»¬æ­£åœ¨åˆ†æå‘è¨€å¹¶è¿›è¡ŒæŠ•ç¥¨...</p>
                </div>
            `;
            
            try {
                // è·å–AIæŠ•ç¥¨ç»“æœ
                const voteResponse = await fetch('/api/game/ai-vote', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session_id: gameState.sessionId
                    })
                });
                
                const voteResult = await voteResponse.json();
                
                // æ£€æŸ¥æ˜¯å¦æœ‰å®‰å…¨è­¦å‘Š
                if (voteResult.security_warning) {
                    addGameFlowMessage('âš ï¸ æ£€æµ‹åˆ°ä¸å®‰å…¨çš„å†…å®¹ï¼ŒæŠ•ç¥¨ç»ˆæ­¢');
                    votingOptions.innerHTML = `
                        <div class="text-center py-8">
                            <h3 class="text-xl font-bold text-red-600 mb-4">âš ï¸ å®‰å…¨è­¦å‘Š</h3>
                            <p class="text-gray-600">${voteResult.message || 'æ£€æµ‹åˆ°ä¸å®‰å…¨çš„å†…å®¹'}</p>
                        </div>
                    `;
                    return;
                }
                
                if (voteResponse.ok) {
                    addGameFlowMessage('âœ… AIæŠ•ç¥¨å®Œæˆï¼Œæ­£åœ¨ç»Ÿè®¡ç»“æœ...');
                    
                    // æ˜¾ç¤ºæŠ•ç¥¨è¿‡ç¨‹
                    await showVotingProcess(voteResult.vote_results);
                    
                    addGameFlowMessage('ğŸ“Š æ­£åœ¨å¤„ç†æŠ•ç¥¨ç»“æœ...');
                    
                    // æ˜¾ç¤ºå¤„ç†æŠ•ç¥¨ç»“æœçš„ç­‰å¾…åŠ¨ç”»
                    votingOptions.innerHTML = `
                        <div class="text-center py-8">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ“Š ç»Ÿè®¡æŠ•ç¥¨ç»“æœä¸­...</h3>
                            <div class="flex justify-center items-center space-x-2 mb-6">
                                <div class="w-4 h-4 bg-blue-500 rounded-full animate-pulse"></div>
                                <div class="w-4 h-4 bg-green-500 rounded-full animate-pulse" style="animation-delay: 0.3s"></div>
                                <div class="w-4 h-4 bg-yellow-500 rounded-full animate-pulse" style="animation-delay: 0.6s"></div>
                                <div class="w-4 h-4 bg-red-500 rounded-full animate-pulse" style="animation-delay: 0.9s"></div>
                            </div>
                            <div class="space-y-2 text-sm text-gray-600">
                                <p class="animate-fade-in">ğŸ” åˆ†ææŠ•ç¥¨æ•°æ®...</p>
                                <p class="animate-fade-in" style="animation-delay: 1s">âš–ï¸ è®¡ç®—å¾—ç¥¨æ•°é‡...</p>
                                <p class="animate-fade-in" style="animation-delay: 2s">ğŸ­ ç”Ÿæˆè§’è‰²ååº”...</p>
                                <p class="animate-fade-in" style="animation-delay: 3s">ğŸ“‹ å‡†å¤‡ç»“æœå±•ç¤º...</p>
                            </div>
                        </div>
                    `;
                    
                    // å¤„ç†æŠ•ç¥¨ç»“æœ
                    const processResponse = await fetch('/api/game/process-ai-votes', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            session_id: gameState.sessionId,
                            vote_results: voteResult.vote_results
                        })
                    });
                    
                    const processResult = await processResponse.json();
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰å®‰å…¨è­¦å‘Š
                    if (processResult.security_warning) {
                        addGameFlowMessage('âš ï¸ æ£€æµ‹åˆ°ä¸å®‰å…¨çš„å†…å®¹ï¼Œç»“æœå¤„ç†ç»ˆæ­¢');
                        votingOptions.innerHTML = `
                            <div class="text-center py-8">
                                <h3 class="text-xl font-bold text-red-600 mb-4">âš ï¸ å®‰å…¨è­¦å‘Š</h3>
                                <p class="text-gray-600">${processResult.message || 'æ£€æµ‹åˆ°ä¸å®‰å…¨çš„å†…å®¹'}</p>
                            </div>
                        `;
                        return;
                    }
                    
                    if (processResponse.ok) {
                        const eliminatedCharacter = gameState.selectedCharacters[processResult.eliminated_character.index];
                        addGameFlowMessage(`ğŸ¯ æŠ•ç¥¨ç»“æœï¼š${eliminatedCharacter.name} è¢«æ·˜æ±°`);
                        
                        // æ˜¾ç¤ºæŠ•ç¥¨ç»“æœ
                        await showVotingResult(processResult);
                        
                        // æ›´æ–°æ¸¸æˆçŠ¶æ€
                        gameState.eliminated.push(processResult.eliminated_character.index);
                        gameState.gameOver = processResult.game_over;
                        gameState.currentRound = processResult.current_round;
                        
                        // æ›´æ–°æ˜¾ç¤º
                        updateGameDisplay();
                        
                        if (processResult.game_over) {
                            addGameFlowMessage(`ğŸ† æ¸¸æˆç»“æŸï¼${processResult.winner === 'undercover' ? 'å§åº•' : 'å¹³æ°‘'}è·èƒœ`);
                            setTimeout(() => {
                                showGameResult(processResult.winner, gameState.undercoverIndex);
                            }, 1500);
                        } else {
                            addGameFlowMessage(`â¡ï¸ è¿›å…¥ç¬¬ ${processResult.current_round} è½®`);
                            // ç»§ç»­ä¸‹ä¸€è½®
                            setTimeout(() => {
                                document.getElementById('currentRound').textContent = gameState.currentRound;
                                // ä¿æŒæŠ•ç¥¨åŒºåŸŸæ˜¾ç¤ºï¼Œä¸éšè—
                                initializeDescriptionArea();
                            }, 1500);
                        }
                    } else {
                        throw new Error(processResult.error || 'æŠ•ç¥¨å¤„ç†å¤±è´¥');
                    }
                } else {
                    throw new Error(voteResult.error || 'AIæŠ•ç¥¨å¤±è´¥');
                }
            } catch (error) {
                console.error('AIæŠ•ç¥¨å¤±è´¥:', error);
                addGameFlowMessage(`âŒ æŠ•ç¥¨å¤±è´¥: ${error.message}`);
                votingOptions.innerHTML = `
                    <div class="text-center py-8">
                        <h3 class="text-xl font-bold text-red-600 mb-4">âŒ æŠ•ç¥¨å¤±è´¥</h3>
                        <p class="text-gray-600 mb-6">${error.message}</p>
                        <button onclick="startAIVoting()" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-lg font-medium transition">
                            é‡æ–°æŠ•ç¥¨
                        </button>
                    </div>
                `;
            }
        }
        
        // æ˜¾ç¤ºæŠ•ç¥¨è¿‡ç¨‹
        async function showVotingProcess(voteResults) {
            const votingOptions = document.getElementById('votingOptions');
            
            votingOptions.innerHTML = `
                <div class="py-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-6 text-center">ğŸ—³ï¸ AIè§’è‰²æŠ•ç¥¨å‘è¨€</h3>
                    <div id="voteMessages" class="space-y-4 max-h-96 overflow-y-auto">
                    </div>
                </div>
            `;
            
            const voteMessages = document.getElementById('voteMessages');
            
            for (let i = 0; i < voteResults.length; i++) {
                const vote = voteResults[i];
                const character = gameState.selectedCharacters[vote.character_index];
                
                // æ·»åŠ æŠ•ç¥¨æ¶ˆæ¯
                const messageDiv = document.createElement('div');
                messageDiv.className = 'flex items-start space-x-3 p-4 bg-gray-50 rounded-lg';
                messageDiv.innerHTML = `
                    <div class="flex-shrink-0">
                        ${generateAvatarHtml(character, 'w-10 h-10 text-sm')}
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center space-x-2 mb-2">
                            <span class="font-semibold text-gray-800">${character.name}</span>
                            ${vote.is_undercover ? '<span class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded">å§åº•</span>' : '<span class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded">å¹³æ°‘</span>'}
                        </div>
                        <div class="text-gray-700 typing-animation" id="vote-text-${i}"></div>
                    </div>
                `;
                
                voteMessages.appendChild(messageDiv);
                
                // æ‰“å­—æœºæ•ˆæœæ˜¾ç¤ºæŠ•ç¥¨å†…å®¹
                await typeText(`vote-text-${i}`, vote.vote_response, 15);
                
                // ç­‰å¾…ä¸€ä¸‹å†æ˜¾ç¤ºä¸‹ä¸€ä¸ª
                await new Promise(resolve => setTimeout(resolve, 300));
            }
        }
        
        // æ˜¾ç¤ºæŠ•ç¥¨ç»“æœ
        async function showVotingResult(result) {
            const votingOptions = document.getElementById('votingOptions');
            
            // æ„å»ºæŠ•ç¥¨ç»Ÿè®¡è¯¦æƒ…
            let voteDetailsHtml = '';
            if (result.vote_details && result.vote_details.length > 0) {
                voteDetailsHtml = `
                    <div class="bg-gray-50 rounded-lg p-4 mb-6">
                        <h5 class="font-bold text-gray-700 mb-3">æŠ•ç¥¨è¯¦æƒ…ï¼š</h5>
                        <div class="space-y-2 text-sm">
                            ${result.vote_details.map(vote => 
                                `<div class="flex justify-between items-center">
                                    <span>${vote.voter} â†’ ${vote.voted_for}</span>
                                    <span class="text-gray-500">${vote.reason.split('ç†ç”±ï¼š')[1] || vote.reason}</span>
                                </div>`
                            ).join('')}
                        </div>
                    </div>
                `;
            }
            
            votingOptions.innerHTML = `
                <div class="py-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-6 text-center">ğŸ“Š æŠ•ç¥¨ç»“æœç»Ÿè®¡</h3>
                    ${voteDetailsHtml}
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 mb-6">
                        <div class="text-center">
                            <h4 class="text-lg font-bold text-red-600 mb-2">è¢«æ·˜æ±°è§’è‰²</h4>
                            <div class="flex justify-center items-center space-x-3 mb-4">
                                ${generateAvatarHtml(gameState.selectedCharacters[result.eliminated_character.index], 'w-16 h-16 text-xl')}
                                <div>
                                    <p class="font-bold text-xl">${result.eliminated_character.name}</p>
                                    <p class="text-gray-600">${result.eliminated_character.is_undercover ? 'å§åº•èº«ä»½' : 'å¹³æ°‘èº«ä»½'}</p>
                                </div>
                            </div>
                            ${result.eliminated_character.elimination_speech ? `
                            <div class="bg-white border-l-4 ${result.eliminated_character.is_undercover ? 'border-red-500' : 'border-blue-500'} rounded-lg p-4 mt-4">
                                <div class="flex items-start space-x-3">
                                    <div class="text-2xl">${result.eliminated_character.is_undercover ? 'ğŸ˜¤' : 'ğŸ˜¡'}</div>
                                    <div class="flex-1">
                                        <p class="text-sm text-gray-500 mb-1">${result.eliminated_character.name}çš„æœ€åè¯è¯­ï¼š</p>
                                        <p class="text-gray-800 font-medium italic">"${result.eliminated_character.elimination_speech}"</p>
                                    </div>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    <div class="text-center">
                        ${result.game_over ? 
                            `<div class="text-lg font-bold ${result.winner === 'undercover' ? 'text-red-600' : 'text-green-600'}">
                                ${result.winner === 'undercover' ? 'ğŸ­ å§åº•è·èƒœï¼' : 'ğŸ•µï¸ å¹³æ°‘è·èƒœï¼'}
                            </div>` : 
                            `<div class="text-gray-600 mb-4">æ¸¸æˆç»§ç»­ï¼Œè¿›å…¥ç¬¬ ${result.current_round} è½®</div>
                            <button onclick="generateAllDescriptions()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-medium transition">
                                ğŸ­ å¼€å§‹ç¬¬ ${result.current_round} è½®å‘è¨€
                            </button>`
                        }
                    </div>
                </div>
            `;
        }
        
        // æ‰“å­—æœºæ•ˆæœå‡½æ•°
        async function typeText(elementId, text, speed = 25) {
            const element = document.getElementById(elementId);
            element.textContent = '';
            
            for (let i = 0; i < text.length; i++) {
                element.textContent += text[i];
                await new Promise(resolve => setTimeout(resolve, speed));
            }
        }

        // æ›´æ–°æ¸¸æˆæ˜¾ç¤º
        function updateGameDisplay() {
            const remainingCount = gameState.selectedCharacters.length - gameState.eliminated.length;
            document.getElementById('remainingCount').textContent = remainingCount;
            
            // æ›´æ–°è§’è‰²æ˜¾ç¤ºçŠ¶æ€
            gameState.eliminated.forEach(index => {
                const descCard = document.getElementById(`desc-${index}`);
                if (descCard) {
                    descCard.classList.add('opacity-50', 'bg-gray-100');
                    const nameArea = descCard.querySelector('.flex');
                    if (!nameArea.querySelector('.text-red-500')) {
                        const eliminatedTag = document.createElement('span');
                        eliminatedTag.className = 'text-red-500 font-bold';
                        eliminatedTag.textContent = 'å·²æ·˜æ±°';
                        nameArea.appendChild(eliminatedTag);
                    }
                }
            });
        }

        // æ˜¾ç¤ºæ¸¸æˆç»“æœ
        function showGameResult(winner, undercoverIndex) {
            const resultModal = document.getElementById('gameResultModal');
            const resultTitle = document.getElementById('resultTitle');
            const resultContent = document.getElementById('resultContent');
            
            const undercoverCharacter = gameState.selectedCharacters[undercoverIndex];
            
            // æ·»åŠ åˆ°æ¸¸æˆå†å²
            addToGameHistory(winner, undercoverCharacter, gameState.currentRound);
            
            if (winner === 'undercover') {
                resultTitle.innerHTML = 'ğŸ­ å§åº•èƒœåˆ©ï¼';
                resultTitle.className = 'text-3xl font-bold mb-6 text-red-600';
                resultContent.innerHTML = `
                    <p class="mb-4">æ­å–œå§åº• <strong class="text-red-600">${undercoverCharacter.name}</strong> æˆåŠŸéšè—èº«ä»½ï¼</p>
                    <p class="text-gray-600">å§åº•æˆåŠŸå­˜æ´»åˆ°æœ€åï¼Œè·å¾—èƒœåˆ©ï¼</p>
                `;
            } else {
                resultTitle.innerHTML = 'ğŸ•µï¸ å¹³æ°‘èƒœåˆ©ï¼';
                resultTitle.className = 'text-3xl font-bold mb-6 text-green-600';
                resultContent.innerHTML = `
                    <p class="mb-4">æˆåŠŸè¯†ç ´å§åº• <strong class="text-red-600">${undercoverCharacter.name}</strong>ï¼</p>
                    <p class="text-gray-600">å¹³æ°‘ä»¬å›¢ç»“ä¸€è‡´ï¼ŒæˆåŠŸæ‰¾å‡ºäº†éšè—çš„å§åº•ï¼</p>
                `;
            }
            
            // æ˜¾ç¤ºå¼¹çª—è€Œä¸æ˜¯éšè—æŠ•ç¥¨åŒºåŸŸ
            resultModal.classList.remove('hidden');
        }
        
        // å…³é—­æ¸¸æˆç»“æœå¼¹çª—
        function closeGameResult() {
            document.getElementById('gameResultModal').classList.add('hidden');
            // æ˜¾ç¤ºæ¸¸æˆå†å²
            document.getElementById('gameHistory').classList.remove('hidden');
        }
        
        // æ·»åŠ åˆ°æ¸¸æˆå†å²
        function addToGameHistory(winner, undercoverCharacter, rounds) {
            const historyContent = document.getElementById('historyContent');
            const timestamp = new Date().toLocaleString();
            
            const historyItem = document.createElement('div');
            historyItem.className = 'bg-gray-50 rounded-lg p-4 border-l-4 ' + (winner === 'undercover' ? 'border-red-500' : 'border-green-500');
            historyItem.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <span class="font-bold ${winner === 'undercover' ? 'text-red-600' : 'text-green-600'}">
                        ${winner === 'undercover' ? 'ğŸ­ å§åº•èƒœåˆ©' : 'ğŸ•µï¸ å¹³æ°‘èƒœåˆ©'}
                    </span>
                    <span class="text-xs text-gray-500">${timestamp}</span>
                </div>
                <p class="text-sm text-gray-700">å§åº•: ${undercoverCharacter.name} | è½®æ•°: ${rounds}</p>
            `;
            
            historyContent.insertBefore(historyItem, historyContent.firstChild);
        }
        
        // æ·»åŠ æ¸¸æˆæµç¨‹æ¶ˆæ¯
        function addGameFlowMessage(message) {
            // ç¡®ä¿æ¸¸æˆå†å²åŒºåŸŸå¯è§
            const gameHistory = document.getElementById('gameHistory');
            if (gameHistory.classList.contains('hidden')) {
                gameHistory.classList.remove('hidden');
            }
            
            const historyContent = document.getElementById('historyContent');
            const timestamp = new Date().toLocaleTimeString();
            
            const flowItem = document.createElement('div');
            flowItem.className = 'bg-blue-50 rounded-lg p-3 border-l-4 border-blue-400 animate-fade-in';
            flowItem.innerHTML = `
                <div class="flex justify-between items-center">
                    <span class="text-blue-800 font-medium">${message}</span>
                    <span class="text-xs text-blue-500">${timestamp}</span>
                </div>
            `;
            
            historyContent.insertBefore(flowItem, historyContent.firstChild);
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
            historyContent.scrollTop = 0;
        }

        // é‡ç½®æ¸¸æˆ
        function resetGame() {
            gameState = {
                sessionId: null,
                characters: gameState.characters,
                selectedCharacters: [],
                currentRound: 1,
                maxRounds: 3,
                eliminated: [],
                gameOver: false,
                undercoverIndex: -1
            };
            
            // é‡ç½®UI
            document.getElementById('gameArea').classList.add('hidden');
            document.getElementById('gameSetup').classList.remove('hidden');
            document.getElementById('gameResultModal').classList.add('hidden');
            document.getElementById('gameHistory').classList.add('hidden');
            document.getElementById('votingArea').classList.add('hidden');
            document.getElementById('generateDescBtn').classList.add('hidden');
            
            // æ¸…ç©ºæ¸¸æˆå†å²å†…å®¹
            document.getElementById('historyContent').innerHTML = '';
            
            // é‡æ–°åŠ è½½è§’è‰²åˆ—è¡¨
            displayCharacters(gameState.characters);
            updateSelectedDisplay();
        }
    </script>
</body>
</html>