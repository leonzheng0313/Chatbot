<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIç¾¤èŠ - ChatPersona</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'bounce-gentle': 'bounce 1s ease-in-out 3',
                        'typing': 'typing 1.5s ease-in-out infinite',
                        'float': 'float 3s ease-in-out infinite'
                    },
                    keyframes: {
                        typing: {
                            '0%, 60%, 100%': { opacity: '1' },
                            '30%': { opacity: '0.4' }
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0px)' },
                            '50%': { transform: 'translateY(-10px)' }
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gradient-to-br from-purple-50 to-indigo-100 min-h-screen">
    <!-- å¯¼èˆªæ  -->
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-2 sm:px-4">
            <div class="flex justify-between items-center py-3 sm:py-4">
                <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-indigo-600 rounded-full flex items-center justify-center">
                        <span class="text-white font-bold text-sm">CP</span>
                    </div>
                    <h1 class="text-lg sm:text-2xl font-bold text-gray-800">ChatPersona</h1>
                </div>
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                    <a href="/" class="bg-gray-100 hover:bg-gray-200 px-3 sm:px-4 py-2 rounded-lg text-xs sm:text-sm font-medium transition text-center">
                        â† è¿”å›é¦–é¡µ
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»èŠå¤©åŒºåŸŸ -->
    <div class="max-w-6xl mx-auto px-2 sm:px-4 py-4 sm:py-6">
        <!-- å½“å‰å‚ä¸è§’è‰²æ˜¾ç¤º -->
        <div class="bg-white rounded-xl shadow-lg p-3 sm:p-4 mb-4 sm:mb-6">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-base sm:text-lg font-semibold text-gray-800">å½“å‰èŠå¤©è§’è‰²</h3>
                <button onclick="showCharacterSelector()" class="bg-indigo-100 hover:bg-indigo-200 text-indigo-700 px-3 sm:px-4 py-2 rounded-lg text-xs sm:text-sm font-medium transition">
                    ğŸ‘¥ é€‰æ‹©è§’è‰²
                </button>
            </div>
            <div id="selectedCharactersDisplay" class="flex flex-wrap gap-2 sm:gap-3">
                <div class="text-gray-500 text-sm">è¯·é€‰æ‹©è¦å‚ä¸èŠå¤©çš„è§’è‰²</div>
            </div>
        </div>

        <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
        <div class="bg-white rounded-xl shadow-lg mb-4 sm:mb-6 h-[60vh] sm:h-[500px]">
            <div class="p-3 sm:p-4 border-b border-gray-200">
                <h3 class="text-base sm:text-lg font-semibold text-gray-800">AIäººæ ¼ç¾¤èŠ</h3>
            </div>
            <div id="chatMessages" class="p-3 sm:p-4 h-[calc(60vh-60px)] sm:h-96 overflow-y-auto">
                <div id="welcomeMessage" class="text-center text-gray-500 text-sm py-8">
                    <div class="mb-4">
                        <div class="text-lg mb-2">ğŸ’¬ æ¬¢è¿æ¥åˆ°AIäººæ ¼ç¾¤èŠï¼</div>
                        <div class="text-gray-400 mb-4">é€‰æ‹©è§’è‰²åå¼€å§‹å¯¹è¯å§~</div>
                    </div>
                    <div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-lg p-4 mx-4 mb-4">
                        <div class="text-indigo-600 font-medium mb-2">ğŸ’¡ èŠå¤©å°è´´å£«</div>
                        <div class="text-xs text-gray-600 space-y-1">
                            <div>â€¢ ä¸çŸ¥é“æ€ä¹ˆå†³ç­–é—®é¢˜ï¼Ÿè¯•è¯•çœ‹é—®é—®ä½ çš„è§’è‰²ä»¬å§~</div>
                            <div>â€¢ æƒ³å¬å¬ä¸åŒè§‚ç‚¹ï¼Ÿè®©è§’è‰²ä»¬è®¨è®ºä¸€ä¸ªè¯é¢˜</div>
                            <div>â€¢ éœ€è¦åˆ›æ„çµæ„Ÿï¼Ÿè§’è‰²ä»¬ä¼šç»™ä½ æ„æƒ³ä¸åˆ°çš„æƒ³æ³•</div>
                            <div>â€¢ æƒ³è¦æƒ…æ„Ÿæ”¯æŒï¼Ÿè§’è‰²ä»¬ä¼šé™ªä¼´ä½ èŠå¤©è§£å¿§</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¾“å…¥åŒºåŸŸ -->
        <div class="bg-white rounded-xl shadow-lg p-3 sm:p-4">
            <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4">
                <input type="text" id="messageInput" placeholder="è¾“å…¥è¯é¢˜æˆ–èŠå¤©å†…å®¹..." class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm sm:text-base" onkeypress="handleKeyPress(event)">
                <button onclick="sendMessage()" id="sendButton" class="bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white px-4 sm:px-6 py-3 rounded-lg font-medium transition transform hover:scale-105 text-sm sm:text-base">
                    å‘é€
                </button>
            </div>
            <div class="mt-3 flex flex-wrap gap-2">
                <button onclick="clearChat()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded text-sm transition">
                    æ¸…ç©ºèŠå¤©
                </button>
                <button onclick="exportChat()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded text-sm transition">
                    å¯¼å‡ºè®°å½•
                </button>
            </div>
        </div>
    </div>

    <!-- è§’è‰²é€‰æ‹©æ¨¡æ€æ¡† -->
    <div id="characterSelectorModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-2 sm:p-4">
        <div class="bg-white rounded-xl p-4 sm:p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg sm:text-xl font-bold mb-4">é€‰æ‹©å‚ä¸èŠå¤©çš„è§’è‰²</h3>
            <div id="charactersList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4 mb-6">
                <!-- è§’è‰²åˆ—è¡¨å°†åŠ¨æ€åŠ è½½ -->
            </div>
            <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3">
                <button onclick="hideCharacterSelector()" class="flex-1 bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg transition text-sm sm:text-base">
                    å–æ¶ˆ
                </button>
                <button onclick="confirmCharacterSelection()" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition text-sm sm:text-base">
                    ç¡®è®¤é€‰æ‹©
                </button>
            </div>
        </div>
    </div>

    <!-- åŠ è½½æç¤º -->
    <div id="loadingSpinner" class="fixed inset-0 bg-white bg-opacity-80 flex items-center justify-center z-40 hidden">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
            <p class="text-gray-600">AIæ­£åœ¨æ€è€ƒä¸­...</p>
        </div>
    </div>

    <script>
        let allCharacters = [];
        let selectedCharacterIds = [];
        let chatHistory = [];
        let currentTopic = '';
        let isTyping = false;
        let sessionId = generateSessionId();

        // ç”Ÿæˆä¼šè¯ID
        function generateSessionId() {
            return 'chat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadCharacters();
            loadSelectedCharacters();
        });

        // åŠ è½½æ‰€æœ‰è§’è‰²
        async function loadCharacters() {
            try {
                const response = await fetch('/api/characters');
                allCharacters = await response.json();
            } catch (error) {
                console.error('åŠ è½½è§’è‰²å¤±è´¥:', error);
                showNotification('åŠ è½½è§’è‰²å¤±è´¥', 'error');
            }
        }

        // ä»sessionStorageåŠ è½½å·²é€‰æ‹©çš„è§’è‰²
        function loadSelectedCharacters() {
            const stored = sessionStorage.getItem('selectedCharacters');
            if (stored) {
                selectedCharacterIds = JSON.parse(stored);
                updateSelectedCharactersDisplay();
            }
        }

        // æ˜¾ç¤ºè§’è‰²é€‰æ‹©å™¨
        async function showCharacterSelector() {
            if (allCharacters.length === 0) {
                await loadCharacters();
            }
            
            const charactersList = document.getElementById('charactersList');
            charactersList.innerHTML = '';
            
            allCharacters.forEach(character => {
                const characterCard = createCharacterSelectorCard(character);
                charactersList.appendChild(characterCard);
            });
            
            document.getElementById('characterSelectorModal').classList.remove('hidden');
            document.getElementById('characterSelectorModal').classList.add('flex');
        }

        // ç”Ÿæˆå¤´åƒHTML
        function generateAvatarHtml(character, sizeClass = 'w-16 h-16') {
            const avatarType = character.avatar_type || 'initial';
            const avatarValue = character.avatar_value;
            const textSize = sizeClass.includes('w-12') ? 'text-xl' : sizeClass.includes('w-8') ? 'text-sm' : sizeClass.includes('w-6') ? 'text-xs' : 'text-base';
            const emojiSize = sizeClass.includes('w-12') ? 'text-xl' : sizeClass.includes('w-8') ? 'text-lg' : sizeClass.includes('w-6') ? 'text-sm' : 'text-2xl';
            const marginClass = sizeClass.includes('w-6') ? 'mb-0' : 'mb-2';
            
            if (avatarType === 'emoji' && avatarValue) {
                return `<div class="${sizeClass} bg-gray-100 rounded-full flex items-center justify-center mx-auto ${marginClass} ${emojiSize}">${avatarValue}</div>`;
            } else if (avatarType === 'upload' && avatarValue) {
                return `<div class="${sizeClass} rounded-full mx-auto ${marginClass} overflow-hidden"><img src="${avatarValue}" alt="${character.name}" class="w-full h-full object-cover"></div>`;
            } else {
                // é»˜è®¤ä½¿ç”¨é¦–å­—æ¯å¤´åƒï¼ˆç»Ÿä¸€ä½¿ç”¨ç´«è‰²èƒŒæ™¯ï¼‰
                return `<div class="${sizeClass} bg-indigo-400 rounded-full flex items-center justify-center mx-auto ${marginClass} text-white ${textSize} font-bold">${character.name.charAt(0)}</div>`;
            }
        }

        // åˆ›å»ºè§’è‰²é€‰æ‹©å¡ç‰‡
        function createCharacterSelectorCard(character) {
            const isSelected = selectedCharacterIds.includes(character.id);
            const card = document.createElement('div');
            card.className = `border-2 rounded-lg p-4 cursor-pointer transition ${
                isSelected ? 'border-indigo-500 bg-indigo-50' : 'border-gray-200 hover:border-indigo-300'
            }`;
            
            // ç”Ÿæˆå¤´åƒHTML
            const avatarHtml = generateAvatarHtml(character, 'w-12 h-12');
            
            card.innerHTML = `
                <div class="text-center">
                    ${avatarHtml}
                    <h4 class="font-semibold text-gray-800 whitespace-nowrap overflow-hidden text-ellipsis" title="${character.name}">${character.name}</h4>
                    <p class="text-sm text-indigo-600 mb-1 whitespace-nowrap overflow-hidden text-ellipsis" title="${character.personality}">${character.personality}</p>
                    <p class="text-xs text-gray-600 whitespace-nowrap overflow-hidden text-ellipsis" title="${character.description}">${character.description}</p>
                    ${isSelected ? '<div class="mt-2 text-indigo-600 text-sm">âœ“ å·²é€‰æ‹©</div>' : ''}
                </div>
            `;
            
            card.onclick = () => toggleCharacterSelection(character.id, card);
            return card;
        }

        // åˆ‡æ¢è§’è‰²é€‰æ‹©çŠ¶æ€
        function toggleCharacterSelection(characterId, cardElement) {
            const isSelected = selectedCharacterIds.includes(characterId);
            
            if (isSelected) {
                selectedCharacterIds = selectedCharacterIds.filter(id => id !== characterId);
                cardElement.className = 'border-2 rounded-lg p-4 cursor-pointer transition border-gray-200 hover:border-indigo-300';
                cardElement.querySelector('.mt-2')?.remove();
            } else {
                selectedCharacterIds.push(characterId);
                cardElement.className = 'border-2 rounded-lg p-4 cursor-pointer transition border-indigo-500 bg-indigo-50';
                const selectedDiv = document.createElement('div');
                selectedDiv.className = 'mt-2 text-indigo-600 text-sm';
                selectedDiv.textContent = 'âœ“ å·²é€‰æ‹©';
                cardElement.querySelector('.text-center').appendChild(selectedDiv);
            }
        }

        // ç¡®è®¤è§’è‰²é€‰æ‹©
        function confirmCharacterSelection() {
            if (selectedCharacterIds.length === 0) {
                showNotification('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè§’è‰²', 'error');
                return;
            }
            
            sessionStorage.setItem('selectedCharacters', JSON.stringify(selectedCharacterIds));
            updateSelectedCharactersDisplay();
            hideCharacterSelector();
        }

        // éšè—è§’è‰²é€‰æ‹©å™¨
        function hideCharacterSelector() {
            document.getElementById('characterSelectorModal').classList.add('hidden');
            document.getElementById('characterSelectorModal').classList.remove('flex');
        }

        // æ›´æ–°å·²é€‰æ‹©è§’è‰²æ˜¾ç¤º
        function updateSelectedCharactersDisplay() {
            const display = document.getElementById('selectedCharactersDisplay');
            
            if (selectedCharacterIds.length === 0) {
                display.innerHTML = '<div class="text-gray-500 text-sm">è¯·é€‰æ‹©è¦å‚ä¸èŠå¤©çš„è§’è‰²</div>';
                return;
            }
            
            display.innerHTML = '';
            selectedCharacterIds.forEach(id => {
                const character = allCharacters.find(c => c.id === id);
                if (character) {
                    const characterChip = document.createElement('div');
                    characterChip.className = 'flex items-center space-x-2 bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full text-sm';
                    
                    // ç”Ÿæˆå°å°ºå¯¸å¤´åƒ
                    const avatarHtml = generateAvatarHtml(character, 'w-6 h-6').replace('mb-2', 'mb-0');
                    
                    characterChip.innerHTML = `
                        ${avatarHtml}
                        <span class="whitespace-nowrap overflow-hidden text-ellipsis" title="${character.name}">${character.name}</span>
                    `;
                    display.appendChild(characterChip);
                }
            });
        }

        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) {
                showNotification('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹', 'error');
                return;
            }
            
            if (selectedCharacterIds.length === 0) {
                showNotification('è¯·å…ˆé€‰æ‹©å‚ä¸èŠå¤©çš„è§’è‰²', 'error');
                return;
            }
            
            if (isTyping) {
                showNotification('è¯·ç­‰å¾…AIå›å¤å®Œæˆ', 'error');
                return;
            }
            
            // è®¾ç½®å½“å‰è¯é¢˜
            if (!currentTopic) {
                currentTopic = message;
            }
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©è®°å½•
            addMessageToChat('ç”¨æˆ·', message, 'user');
            input.value = '';
            
            // æ˜¾ç¤ºAIæ­£åœ¨è¾“å…¥çŠ¶æ€
            isTyping = true;
            showTypingIndicators();
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        character_ids: selectedCharacterIds,
                        message: message,
                        topic: currentTopic,
                        session_id: sessionId
                    })
                });
                
                const result = await response.json();
                
                // æ£€æŸ¥æ˜¯å¦æœ‰å®‰å…¨è­¦å‘Š
                if (result.security_warning) {
                    // ç§»é™¤è¾“å…¥æŒ‡ç¤ºå™¨
                    removeTypingIndicators();
                    // æ˜¾ç¤ºå®‰å…¨è­¦å‘Šå¹¶æ¸…é™¤ç”¨æˆ·è¾“å…¥
                    showNotification(result.message || 'æ£€æµ‹åˆ°ä¸å®‰å…¨çš„è¾“å…¥å†…å®¹', 'error');
                    // ä»èŠå¤©è®°å½•ä¸­ç§»é™¤åˆšæ·»åŠ çš„ç”¨æˆ·æ¶ˆæ¯
                    const chatMessages = document.getElementById('chatMessages');
                    const lastMessage = chatMessages.lastElementChild;
                    if (lastMessage && lastMessage.querySelector('.bg-gradient-to-r.from-blue-500')) {
                        lastMessage.remove();
                    }
                    return;
                }
                
                if (result.responses) {
                    // é€ä¸ªæ˜¾ç¤ºè§’è‰²å›å¤ï¼Œå¢åŠ çœŸå®æ„Ÿ
                    for (let i = 0; i < result.responses.length; i++) {
                        const characterResponse = result.responses[i];
                        
                        // åœ¨æ˜¾ç¤ºç¬¬ä¸€ä¸ªå›å¤å‰ç§»é™¤typingæŒ‡ç¤ºå™¨
                        if (i === 0) {
                            removeTypingIndicators();
                        }
                        
                        // ç«‹å³æ˜¾ç¤ºç¬¬ä¸€ä¸ªå›å¤ï¼Œåç»­å›å¤æ·»åŠ è¾ƒçŸ­å»¶è¿Ÿ
                        if (i > 0) {
                            await new Promise(resolve => setTimeout(resolve, 500));
                        }
                        
                        addMessageToChat(
                            characterResponse.character_name,
                            characterResponse.message,
                            'character',
                            characterResponse.character_id
                        );
                    }
                } else {
                    // ç§»é™¤è¾“å…¥æŒ‡ç¤ºå™¨
                    removeTypingIndicators();
                    showNotification(result.error || 'AIå›å¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                }
            } catch (error) {
                console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                removeTypingIndicators();
                showNotification('å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            } finally {
                isTyping = false;
            }
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
        function addMessageToChat(sender, message, type, characterId = null) {
            const chatMessages = document.getElementById('chatMessages');
            
            // å¦‚æœæ˜¯ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼Œæ¸…é™¤æ¬¢è¿æ¶ˆæ¯
            const welcomeMessage = document.getElementById('welcomeMessage');
            if (welcomeMessage) {
                welcomeMessage.remove();
            }
            
            const messageDiv = document.createElement('div');
            
            if (type === 'user') {
                // ç”¨æˆ·æ¶ˆæ¯å³å¯¹é½
                messageDiv.className = 'flex items-start space-x-3 animate-fade-in justify-end mb-4';
                messageDiv.innerHTML = `
                    <div class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white p-3 rounded-lg max-w-xs sm:max-w-sm md:max-w-md lg:max-w-lg xl:max-w-xl order-1">
                        <div class="font-medium text-sm mb-1">${sender}</div>
                        <div class="break-words">${message}</div>
                    </div>
                    <div class="w-8 h-8 bg-gradient-to-r from-gray-400 to-gray-500 rounded-full flex items-center justify-center text-white text-sm font-bold order-2">
                        æˆ‘
                    </div>
                `;
            } else {
                // AIè§’è‰²æ¶ˆæ¯å·¦å¯¹é½
                messageDiv.className = 'flex items-start space-x-3 animate-fade-in mb-4';
                
                // æŸ¥æ‰¾è§’è‰²ä¿¡æ¯ä»¥è·å–æ­£ç¡®çš„å¤´åƒ
                const character = allCharacters.find(c => c.id === characterId);
                let avatarHtml;
                if (character) {
                    avatarHtml = generateAvatarHtml(character, 'w-8 h-8');
                } else {
                    // å¦‚æœæ‰¾ä¸åˆ°è§’è‰²ä¿¡æ¯ï¼Œåˆ›å»ºä¸´æ—¶è§’è‰²å¯¹è±¡ä½¿ç”¨é»˜è®¤å¤´åƒ
                    const tempCharacter = { name: sender, avatar_type: 'initial', avatar_value: null };
                    avatarHtml = generateAvatarHtml(tempCharacter, 'w-8 h-8');
                }
                
                messageDiv.innerHTML = `
                    <div class="flex-shrink-0">${avatarHtml}</div>
                    <div class="bg-white p-3 rounded-lg shadow max-w-xs sm:max-w-sm md:max-w-md lg:max-w-lg xl:max-w-xl">
                        <div class="font-medium text-sm mb-1 text-indigo-600">${sender}</div>
                        <div class="text-gray-800 break-words">${message}</div>
                    </div>
                `;
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // æ·»åŠ åˆ°èŠå¤©å†å²
            chatHistory.push({ sender, message, type, timestamp: new Date() });
        }

        // æ˜¾ç¤ºè¾“å…¥æŒ‡ç¤ºå™¨
        function showTypingIndicators() {
            selectedCharacterIds.forEach((id, index) => {
                const character = allCharacters.find(c => c.id === id);
                if (character) {
                    setTimeout(() => {
                        addTypingIndicator(character.name, id);
                    }, index * 500);
                }
            });
        }

        // æ·»åŠ è¾“å…¥æŒ‡ç¤ºå™¨
        function addTypingIndicator(characterName, characterId) {
            const chatMessages = document.getElementById('chatMessages');
            
            // æŸ¥æ‰¾è§’è‰²ä¿¡æ¯ä»¥è·å–æ­£ç¡®çš„å¤´åƒ
            const character = allCharacters.find(c => c.id === characterId);
            let avatarHtml;
            if (character) {
                avatarHtml = generateAvatarHtml(character, 'w-8 h-8');
            } else {
                // å¦‚æœæ‰¾ä¸åˆ°è§’è‰²ä¿¡æ¯ï¼Œåˆ›å»ºä¸´æ—¶è§’è‰²å¯¹è±¡ä½¿ç”¨é»˜è®¤å¤´åƒ
                const tempCharacter = { name: characterName, avatar_type: 'initial', avatar_value: null };
                avatarHtml = generateAvatarHtml(tempCharacter, 'w-8 h-8');
            }
            
            const typingDiv = document.createElement('div');
            typingDiv.className = 'flex items-center space-x-3 typing-indicator';
            typingDiv.innerHTML = `
                <div class="flex-shrink-0">${avatarHtml}</div>
                <div class="bg-gray-100 p-3 rounded-lg">
                    <div class="text-xs text-gray-500 mb-1">${characterName} æ­£åœ¨è¾“å…¥...</div>
                    <div class="flex space-x-1">
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-typing"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-typing" style="animation-delay: 0.2s"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-typing" style="animation-delay: 0.4s"></div>
                    </div>
                </div>
            `;
            
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // ç§»é™¤è¾“å…¥æŒ‡ç¤ºå™¨
        function removeTypingIndicators() {
            const indicators = document.querySelectorAll('.typing-indicator');
            indicators.forEach(indicator => indicator.remove());
        }

        // æ¸…ç©ºèŠå¤©
        function clearChat() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºèŠå¤©è®°å½•å—ï¼Ÿ')) {
                document.getElementById('chatMessages').innerHTML = '<div id="welcomeMessage" class="text-center text-gray-500 text-sm py-8"><div class="mb-4"><div class="text-lg mb-2">ğŸ’¬ æ¬¢è¿æ¥åˆ°AIäººæ ¼ç¾¤èŠï¼</div><div class="text-gray-400 mb-4">é€‰æ‹©è§’è‰²åå¼€å§‹å¯¹è¯å§~</div></div><div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-lg p-4 mx-4 mb-4"><div class="text-indigo-600 font-medium mb-2">ğŸ’¡ èŠå¤©å°è´´å£«</div><div class="text-xs text-gray-600 space-y-1"><div>â€¢ ä¸çŸ¥é“æ€ä¹ˆå†³ç­–é—®é¢˜ï¼Ÿè¯•è¯•çœ‹é—®é—®ä½ çš„è§’è‰²ä»¬å§~</div><div>â€¢ æƒ³å¬å¬ä¸åŒè§‚ç‚¹ï¼Ÿè®©è§’è‰²ä»¬è®¨è®ºä¸€ä¸ªè¯é¢˜</div><div>â€¢ éœ€è¦åˆ›æ„çµæ„Ÿï¼Ÿè§’è‰²ä»¬ä¼šç»™ä½ æ„æƒ³ä¸åˆ°çš„æƒ³æ³•</div><div>â€¢ æƒ³è¦æƒ…æ„Ÿæ”¯æŒï¼Ÿè§’è‰²ä»¬ä¼šé™ªä¼´ä½ èŠå¤©è§£å¿§</div></div></div></div>';
                chatHistory = [];
                currentTopic = '';
                sessionId = generateSessionId(); // é‡æ–°ç”Ÿæˆä¼šè¯IDï¼Œå¼€å§‹æ–°çš„å¯¹è¯ä¸Šä¸‹æ–‡
            }
        }

        // å¯¼å‡ºèŠå¤©è®°å½•
        function exportChat() {
            if (chatHistory.length === 0) {
                showNotification('æ²¡æœ‰èŠå¤©è®°å½•å¯å¯¼å‡º', 'error');
                return;
            }
            
            let exportText = 'ChatPersona èŠå¤©è®°å½•\n';
            exportText += 'å¯¼å‡ºæ—¶é—´: ' + new Date().toLocaleString() + '\n\n';
            
            chatHistory.forEach(msg => {
                exportText += `[${msg.timestamp.toLocaleTimeString()}] ${msg.sender}: ${msg.message}\n`;
            });
            
            const blob = new Blob([exportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ChatPersona_èŠå¤©è®°å½•_${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // é”®ç›˜äº‹ä»¶å¤„ç†
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // å·¥å…·å‡½æ•°
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            
            notification.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-transform duration-300 translate-x-full`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }
    </script>

    <style>
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-fade-in {
            animation: fade-in 0.3s ease-out;
        }
    </style>
</body>
</html>