<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ›å»ºAIè§’è‰² - ChatPersona</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-purple-50 to-indigo-100 min-h-screen">
    <!-- å¯¼èˆªæ  -->
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-indigo-600 rounded-full flex items-center justify-center">
                        <span class="text-white font-bold text-sm">CP</span>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-800">ChatPersona</h1>
                </div>
                <div class="flex space-x-4">
                    <a href="/" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg text-sm font-medium transition">
                        â† è¿”å›é¦–é¡µ
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="max-w-4xl mx-auto px-4 py-8">
        <div class="text-center mb-8">
            <h2 class="text-4xl font-bold text-gray-800 mb-4">åˆ›å»ºä½ çš„AIè§’è‰²</h2>
            <p class="text-gray-600 text-lg">è®¾è®¡ç‹¬ç‰¹çš„äººæ ¼ï¼Œè®©AIæ‹¥æœ‰è‡ªå·±çš„ä¸ªæ€§</p>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-8">
            <form id="characterForm" class="space-y-6">
                <!-- åŸºæœ¬ä¿¡æ¯ -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">è§’è‰²åç§° *</label>
                        <input type="text" id="characterName" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="ç»™ä½ çš„è§’è‰²èµ·ä¸ªåå­—">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">è§’è‰²æè¿°</label>
                        <input type="text" id="characterDescription" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="ç®€å•æè¿°è§’è‰²ç‰¹ç‚¹">
                    </div>
                </div>
                
                <!-- å¤´åƒè®¾ç½® -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">å¤´åƒè®¾ç½®</label>
                    <div class="flex items-center space-x-4 mb-3">
                        <div id="avatarPreview" class="w-16 h-16 bg-indigo-400 rounded-full flex items-center justify-center text-white text-2xl font-bold">A</div>
                        <div class="flex space-x-2">
                            <button type="button" onclick="showEmojiSelector()" class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-4 py-2 rounded-lg text-sm font-medium transition">
                                ğŸ˜€ é€‰æ‹©è¡¨æƒ…
                            </button>
                            <button type="button" onclick="document.getElementById('avatarUpload').click()" class="bg-green-100 hover:bg-green-200 text-green-700 px-4 py-2 rounded-lg text-sm font-medium transition">
                                ğŸ“ ä¸Šä¼ å›¾ç‰‡
                            </button>
                            <button type="button" onclick="resetToInitial()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium transition">
                                ğŸ”„ é‡ç½®ä¸ºé¦–å­—æ¯
                            </button>
                        </div>
                    </div>
                    <input type="file" id="avatarUpload" accept="image/*" style="display: none" onchange="handleAvatarUpload(event)">
                    <input type="hidden" id="avatarType" value="initial">
                    <input type="hidden" id="avatarValue">
                    <p class="text-sm text-gray-500">é€‰æ‹©è¡¨æƒ…ç¬¦å·ä½œä¸ºå¤´åƒï¼Œæˆ–ä¸Šä¼ è‡ªå®šä¹‰å›¾ç‰‡ï¼ˆæœ€å¤§5MBï¼‰</p>
                </div>

                <!-- åˆ›å»ºæ–¹å¼é€‰æ‹© -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-4">åˆ›å»ºæ–¹å¼</label>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <button type="button" id="tagModeBtn" onclick="switchMode('tag')" class="bg-indigo-600 text-white px-4 py-3 rounded-lg font-medium transition">
                            ğŸ·ï¸ æ ‡ç­¾å¼é…ç½®
                        </button>
                        <button type="button" id="customModeBtn" onclick="switchMode('custom')" class="bg-gray-200 text-gray-700 px-4 py-3 rounded-lg font-medium transition">
                            âœï¸ è‡ªå®šä¹‰Prompt
                        </button>
                        <button type="button" id="aiModeBtn" onclick="switchMode('ai')" class="bg-gray-200 text-gray-700 px-4 py-3 rounded-lg font-medium transition">
                            ğŸ¤– AIå¸®æˆ‘å»º
                        </button>
                    </div>
                </div>

                <!-- æ ‡ç­¾å¼é…ç½®æ¨¡å¼ -->
                <div id="tagMode" class="space-y-6">
                    <!-- æ€§æ ¼å…³é”®è¯ -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-3">æ€§æ ¼å…³é”®è¯</label>
                        <div class="flex flex-wrap gap-2" id="personalityTags">
                            <!-- æ€§æ ¼æ ‡ç­¾ -->
                        </div>
                        <div class="mt-3">
                            <input type="text" id="customPersonality" placeholder="æˆ–è¾“å…¥è‡ªå®šä¹‰æ€§æ ¼è¯æ±‡" class="w-full p-2 border border-gray-300 rounded-lg text-sm">
                            <button type="button" onclick="addCustomPersonality()" class="mt-2 bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded text-sm transition">
                                æ·»åŠ 
                            </button>
                        </div>
                    </div>

                    <!-- è¯­è¨€é£æ ¼ -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-3">è¯­è¨€é£æ ¼</label>
                        <div class="flex flex-wrap gap-2" id="languageStyleTags">
                            <!-- è¯­è¨€é£æ ¼æ ‡ç­¾ -->
                        </div>
                    </div>

                    <!-- è§’è‰²ç±»å‹ -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-3">è§’è‰²ç±»å‹</label>
                        <div class="flex flex-wrap gap-2" id="roleTypeTags">
                            <!-- è§’è‰²ç±»å‹æ ‡ç­¾ -->
                        </div>
                    </div>

                    <!-- ç”Ÿæˆçš„Prompté¢„è§ˆ -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">ç”Ÿæˆçš„Prompté¢„è§ˆ</label>
                        <div id="generatedPrompt" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg min-h-24 text-sm text-gray-700">
                            é€‰æ‹©æ ‡ç­¾åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ç”Ÿæˆè§’è‰²æç¤ºè¯...
                        </div>
                    </div>
                </div>

                <!-- è‡ªå®šä¹‰Promptæ¨¡å¼ -->
                <div id="customMode" class="space-y-6 hidden">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">è‡ªå®šä¹‰ç³»ç»ŸPrompt *</label>
                        <textarea id="customPrompt" rows="8" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="ä½ æ˜¯ä¸€ä¸ªæœ‰ç‹¬ç‰¹æ€§æ ¼çš„ AI è§’è‰²ï¼Œå–œæ¬¢ç”¨ã€Œxxã€çš„è¯­æ°”ä¸äººäº¤æµã€‚è¯·è¯¦ç»†æè¿°è§’è‰²çš„æ€§æ ¼ã€è¯´è¯æ–¹å¼ã€è¡Œä¸ºç‰¹ç‚¹ç­‰..."></textarea>
                        <p class="text-xs text-gray-500 mt-1">æç¤ºï¼šè¯¦ç»†çš„è§’è‰²è®¾å®šèƒ½è®©AIè¡¨ç°æ›´åŠ ç”ŸåŠ¨</p>
                    </div>

                    <!-- Prompté¢„è§ˆæŒ‰é’® -->
                    <div>
                        <button type="button" onclick="previewPrompt()" class="bg-purple-100 hover:bg-purple-200 text-purple-700 px-4 py-2 rounded-lg font-medium transition">
                            ğŸ” é¢„è§ˆæ•ˆæœ
                        </button>
                    </div>
                </div>

                <!-- AIå¸®æˆ‘å»ºæ¨¡å¼ -->
                <div id="aiMode" class="space-y-6 hidden">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">æè¿°ä½ æƒ³è¦çš„è§’è‰² *</label>
                        <textarea id="aiInput" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="ä¾‹å¦‚ï¼šæˆ‘æƒ³è¦ä¸€ä¸ªæ¸©æŸ”å–„è‰¯çš„å¤§å§å§è§’è‰²ï¼Œè¯´è¯å¾ˆæ¸©æŸ”ï¼Œå–œæ¬¢ç…§é¡¾åˆ«äººï¼Œæœ‰ç‚¹å¤©ç„¶å‘†çš„æ„Ÿè§‰..."></textarea>
                        <p class="text-xs text-gray-500 mt-1">æç¤ºï¼šæè¿°å¾—è¶Šè¯¦ç»†ï¼ŒAIç”Ÿæˆçš„è§’è‰²è¶Šç¬¦åˆä½ çš„æœŸæœ›</p>
                    </div>

                    <div class="flex space-x-4">
                        <button type="button" onclick="generateAIPrompt()" id="generateBtn" class="bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white px-6 py-2 rounded-lg font-medium transition">
                            ğŸ¤– AIå¸®æˆ‘æ”¹
                        </button>
                        <button type="button" onclick="clearAIResult()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg font-medium transition">
                            ğŸ—‘ï¸ æ¸…ç©º
                        </button>
                    </div>

                    <!-- AIç”Ÿæˆç»“æœ -->
                    <div id="aiResultContainer" class="hidden">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">AIç”Ÿæˆçš„ç³»ç»Ÿæç¤ºè¯</label>
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-4 mb-3">
                            <div id="aiGeneratedPrompt" class="text-gray-800 whitespace-pre-wrap"></div>
                        </div>
                        <div class="flex space-x-3">
                            <button type="button" onclick="acceptAIResult()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium transition">
                                âœ… ç¡®è®¤ä½¿ç”¨
                            </button>
                            <button type="button" onclick="editAIResult()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition">
                                âœï¸ æ‰‹åŠ¨ä¿®æ”¹
                            </button>
                            <button type="button" onclick="regenerateAI()" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-medium transition">
                                ğŸ”„ é‡æ–°ç”Ÿæˆ
                            </button>
                        </div>
                    </div>

                    <!-- æ‰‹åŠ¨ç¼–è¾‘åŒºåŸŸ -->
                    <div id="aiEditContainer" class="hidden">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">ç¼–è¾‘ç³»ç»Ÿæç¤ºè¯</label>
                        <textarea id="aiEditPrompt" rows="8" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"></textarea>
                        <div class="flex space-x-3 mt-3">
                            <button type="button" onclick="saveAIEdit()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium transition">
                                ğŸ’¾ ä¿å­˜ä¿®æ”¹
                            </button>
                            <button type="button" onclick="cancelAIEdit()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium transition">
                                âŒ å–æ¶ˆç¼–è¾‘
                            </button>
                        </div>
                    </div>
                </div>

                <!-- æäº¤æŒ‰é’® -->
                <div class="flex space-x-4 pt-6">
                    <button type="button" onclick="window.location.href='/'" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-3 rounded-lg font-medium transition">
                        å–æ¶ˆ
                    </button>
                    <button type="submit" class="flex-1 bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white px-6 py-3 rounded-lg font-medium transition">
                        âœ¨ åˆ›å»ºè§’è‰²
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Emojié€‰æ‹©å™¨æ¨¡æ€æ¡† -->
    <div id="emojiModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 max-h-[80vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4">é€‰æ‹©è¡¨æƒ…å¤´åƒ</h3>
            <div class="grid grid-cols-6 gap-2 mb-4" id="emojiGrid">
                <!-- Emojié€‰é¡¹å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
            </div>
            <button onclick="hideEmojiSelector()" class="w-full bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg transition">
                å–æ¶ˆ
            </button>
        </div>
    </div>

    <!-- é¢„è§ˆæ¨¡æ€æ¡† -->
    <div id="previewModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 max-w-lg w-full mx-4">
            <h3 class="text-xl font-bold mb-4">è§’è‰²é¢„è§ˆ</h3>
            <div class="bg-gray-50 p-4 rounded-lg mb-4 max-h-64 overflow-y-auto">
                <p id="previewContent" class="text-gray-800">åŠ è½½ä¸­...</p>
            </div>
            <button onclick="hidePreviewModal()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition">
                å…³é—­
            </button>
        </div>
    </div>

    <!-- åŠ è½½æç¤º -->
    <div id="loadingSpinner" class="fixed inset-0 bg-white bg-opacity-80 flex items-center justify-center z-40 hidden">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
            <p class="text-gray-600">å¤„ç†ä¸­...</p>
        </div>
    </div>

    <script>
        let currentMode = 'tag';
        let selectedTags = {
            personality: [],
            languageStyle: [],
            roleType: []
        };

        // é¢„å®šä¹‰æ ‡ç­¾
        const tagOptions = {
            personality: [
                'æ¸©æŸ”', 'çƒ­è¡€', 'å†·é™', 'æ´»æ³¼', 'å†…å‘', 'å¤–å‘', 'å¹½é»˜', 'ä¸¥è‚ƒ',
                'å–„è‰¯', 'æ¯’èˆŒ', 'ä¸­äºŒ', 'æˆç†Ÿ', 'å¤©çœŸ', 'ç†æ€§', 'æ„Ÿæ€§', 'ä¹è§‚',
                'æ‚²è§‚', 'è‡ªä¿¡', 'å®³ç¾', 'å‹‡æ•¢', 'èƒ†å°', 'æœºçµ', 'å‘†èŒ', 'é«˜å†·'
            ],
            languageStyle: [
                'å¯çˆ±è¯­æ°”', 'æ­£å¼è¯­æ°”', 'æ–¹è¨€å£éŸ³', 'å¤é£æ–‡é›…', 'ç°ä»£æ½®æµ',
                'äºŒæ¬¡å…ƒé£', 'å­¦è€…é£æ ¼', 'å°å­©å­æ°”', 'å¤§å§å§é£', 'å‚²å¨‡è¯­æ°”',
                'æ¸©æŸ”ç»†è¯­', 'è±ªçˆ½ç›´æ¥', 'è¯—æ„æµªæ¼«', 'ç§‘æŠ€æ„Ÿ', 'æç¬‘é£è¶£'
            ],
            roleType: [
                'å­¦ç”Ÿ', 'è€å¸ˆ', 'åŒ»ç”Ÿ', 'è‰ºæœ¯å®¶', 'ç§‘å­¦å®¶', 'å†’é™©å®¶',
                'é­”æ³•å¸ˆ', 'æ­¦å£«', 'å•†äºº', 'å¨å¸ˆ', 'éŸ³ä¹å®¶', 'ä½œå®¶',
                'ç¨‹åºå‘˜', 'è®¾è®¡å¸ˆ', 'æ¢é™©å®¶', 'å“²å­¦å®¶', 'å¿ƒç†å’¨è¯¢å¸ˆ', 'å® ç‰©'
            ]
        };

        // å¤´åƒç›¸å…³å‡½æ•°
        const commonEmojis = [
            'ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜Š', 'ğŸ˜‡',
            'ğŸ™‚', 'ğŸ™ƒ', 'ğŸ˜‰', 'ğŸ˜Œ', 'ğŸ˜', 'ğŸ¥°', 'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜™', 'ğŸ˜š',
            'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜', 'ğŸ˜œ', 'ğŸ¤ª', 'ğŸ¤¨', 'ğŸ§', 'ğŸ¤“', 'ğŸ˜', 'ğŸ¤©',
            'ğŸ¥³', 'ğŸ˜', 'ğŸ˜’', 'ğŸ˜', 'ğŸ˜”', 'ğŸ˜Ÿ', 'ğŸ˜•', 'ğŸ™', 'â˜¹ï¸', 'ğŸ˜£',
            'ğŸ˜–', 'ğŸ˜«', 'ğŸ˜©', 'ğŸ¥º', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜¤', 'ğŸ˜ ', 'ğŸ˜¡', 'ğŸ¤¬',
            'ğŸ¤¯', 'ğŸ˜³', 'ğŸ¥µ', 'ğŸ¥¶', 'ğŸ˜±', 'ğŸ˜¨', 'ğŸ˜°', 'ğŸ˜¥', 'ğŸ˜“', 'ğŸ¤—',
            'ğŸ¤”', 'ğŸ¤­', 'ğŸ¤«', 'ğŸ¤¥', 'ğŸ˜¶', 'ğŸ˜', 'ğŸ˜‘', 'ğŸ˜¬', 'ğŸ™„', 'ğŸ˜¯',
            'ğŸ˜¦', 'ğŸ˜§', 'ğŸ˜®', 'ğŸ˜²', 'ğŸ¥±', 'ğŸ˜´', 'ğŸ¤¤', 'ğŸ˜ª', 'ğŸ˜µ', 'ğŸ¤',
            'ğŸ¥´', 'ğŸ¤¢', 'ğŸ¤®', 'ğŸ¤§', 'ğŸ˜·', 'ğŸ¤’', 'ğŸ¤•', 'ğŸ¤‘', 'ğŸ¤ ', 'ğŸ˜ˆ',
            'ğŸ‘¿', 'ğŸ‘¹', 'ğŸ‘º', 'ğŸ¤¡', 'ğŸ’©', 'ğŸ‘»', 'ğŸ’€', 'â˜ ï¸', 'ğŸ‘½', 'ğŸ‘¾',
            'ğŸ¤–', 'ğŸƒ', 'ğŸ˜º', 'ğŸ˜¸', 'ğŸ˜¹', 'ğŸ˜»', 'ğŸ˜¼', 'ğŸ˜½', 'ğŸ™€', 'ğŸ˜¿',
            'ğŸ˜¾', 'ğŸ‘¶', 'ğŸ‘§', 'ğŸ§’', 'ğŸ‘¦', 'ğŸ‘©', 'ğŸ§‘', 'ğŸ‘¨', 'ğŸ‘µ', 'ğŸ§“',
            'ğŸ‘´', 'ğŸ‘²', 'ğŸ‘³', 'ğŸ‘®', 'ğŸ‘·', 'ğŸ’‚', 'ğŸ•µï¸', 'ğŸ‘©â€âš•ï¸', 'ğŸ‘¨â€âš•ï¸', 'ğŸ‘©â€ğŸŒ¾'
        ];
        
        function showEmojiSelector() {
            const emojiGrid = document.getElementById('emojiGrid');
            emojiGrid.innerHTML = '';
            
            commonEmojis.forEach(emoji => {
                const button = document.createElement('button');
                button.className = 'w-10 h-10 text-2xl hover:bg-gray-100 rounded transition';
                button.textContent = emoji;
                button.onclick = () => selectEmoji(emoji);
                emojiGrid.appendChild(button);
            });
            
            document.getElementById('emojiModal').classList.remove('hidden');
            document.getElementById('emojiModal').classList.add('flex');
        }
        
        function hideEmojiSelector() {
            document.getElementById('emojiModal').classList.add('hidden');
            document.getElementById('emojiModal').classList.remove('flex');
        }
        
        function selectEmoji(emoji) {
            document.getElementById('avatarType').value = 'emoji';
            document.getElementById('avatarValue').value = emoji;
            updateAvatarPreview();
            hideEmojiSelector();
        }
        
        function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) { // 5MBé™åˆ¶
                    alert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5MB');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('avatarType').value = 'upload';
                    document.getElementById('avatarValue').value = e.target.result;
                    updateAvatarPreview();
                };
                reader.readAsDataURL(file);
            }
        }
        
        function resetToInitial() {
            document.getElementById('avatarType').value = 'initial';
            document.getElementById('avatarValue').value = '';
            updateAvatarPreview();
        }
        
        // ç”Ÿæˆå¤´åƒHTML
        function generateAvatarHtml(character, sizeClass = 'w-16 h-16') {
            const avatarType = character.avatar_type || 'initial';
            const avatarValue = character.avatar_value;
            const textSize = sizeClass.includes('w-12') ? 'text-xl' : sizeClass.includes('w-8') ? 'text-sm' : 'text-2xl';
            const emojiSize = sizeClass.includes('w-12') ? 'text-xl' : sizeClass.includes('w-8') ? 'text-lg' : 'text-3xl';
            
            if (avatarType === 'emoji' && avatarValue) {
                return `<div class="${sizeClass} bg-gray-100 rounded-full flex items-center justify-center ${emojiSize}">${avatarValue}</div>`;
            } else if (avatarType === 'upload' && avatarValue) {
                return `<div class="${sizeClass} rounded-full overflow-hidden"><img src="${avatarValue}" alt="${character.name}" class="w-full h-full object-cover"></div>`;
            } else {
                // é»˜è®¤ä½¿ç”¨é¦–å­—æ¯å¤´åƒ
                const colors = ['bg-red-400', 'bg-blue-400', 'bg-green-400', 'bg-yellow-400', 'bg-purple-400', 'bg-pink-400', 'bg-indigo-400'];
                const colorIndex = character.id ? character.id % colors.length : Math.floor(Math.random() * colors.length);
                const bgColor = colors[colorIndex];
                return `<div class="${sizeClass} ${bgColor} rounded-full flex items-center justify-center text-white ${textSize} font-bold">${character.name.charAt(0)}</div>`;
            }
        }

        function updateAvatarPreview() {
            const avatarType = document.getElementById('avatarType').value;
            const avatarValue = document.getElementById('avatarValue').value;
            const preview = document.getElementById('avatarPreview');
            const characterName = document.getElementById('characterName').value || 'A';
            
            // åˆ›å»ºä¸´æ—¶è§’è‰²å¯¹è±¡
            const tempCharacter = {
                name: characterName,
                avatar_type: avatarType,
                avatar_value: avatarValue
            };
            
            // ä½¿ç”¨ç»Ÿä¸€çš„å¤´åƒç”Ÿæˆå‡½æ•°
            preview.outerHTML = `<div id="avatarPreview">${generateAvatarHtml(tempCharacter, 'w-16 h-16 text-2xl')}</div>`;
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeTags();
            updateGeneratedPrompt();
            
            // ç›‘å¬è§’è‰²åç§°è¾“å…¥ï¼Œå®æ—¶æ›´æ–°å¤´åƒé¢„è§ˆ
            const nameInput = document.getElementById('characterName');
            if (nameInput) {
                nameInput.addEventListener('input', updateAvatarPreview);
            }
        });

        // åˆå§‹åŒ–æ ‡ç­¾
        function initializeTags() {
            Object.keys(tagOptions).forEach(category => {
                const container = document.getElementById(category + 'Tags');
                tagOptions[category].forEach(tag => {
                    const tagElement = createTagElement(tag, category);
                    container.appendChild(tagElement);
                });
            });
        }

        // åˆ›å»ºæ ‡ç­¾å…ƒç´ 
        function createTagElement(tag, category) {
            const span = document.createElement('span');
            span.className = 'px-3 py-1 bg-gray-100 text-gray-700 rounded-full cursor-pointer hover:bg-indigo-100 hover:text-indigo-700 transition text-sm';
            span.textContent = tag;
            span.onclick = () => toggleTag(tag, category, span);
            return span;
        }

        // åˆ‡æ¢æ ‡ç­¾é€‰æ‹©çŠ¶æ€
        function toggleTag(tag, category, element) {
            const isSelected = selectedTags[category].includes(tag);
            
            if (isSelected) {
                selectedTags[category] = selectedTags[category].filter(t => t !== tag);
                element.className = 'px-3 py-1 bg-gray-100 text-gray-700 rounded-full cursor-pointer hover:bg-indigo-100 hover:text-indigo-700 transition text-sm';
            } else {
                selectedTags[category].push(tag);
                element.className = 'px-3 py-1 bg-indigo-600 text-white rounded-full cursor-pointer transition text-sm';
            }
            
            updateGeneratedPrompt();
        }

        // æ·»åŠ è‡ªå®šä¹‰æ€§æ ¼æ ‡ç­¾
        function addCustomPersonality() {
            const input = document.getElementById('customPersonality');
            const value = input.value.trim();
            
            if (value && !selectedTags.personality.includes(value)) {
                selectedTags.personality.push(value);
                
                // åˆ›å»ºæ–°æ ‡ç­¾å…ƒç´ 
                const container = document.getElementById('personalityTags');
                const tagElement = createTagElement(value, 'personality');
                tagElement.className = 'px-3 py-1 bg-indigo-600 text-white rounded-full cursor-pointer transition text-sm';
                container.appendChild(tagElement);
                
                input.value = '';
                updateGeneratedPrompt();
            }
        }

        // æ›´æ–°ç”Ÿæˆçš„Prompt
        function updateGeneratedPrompt() {
            const { personality, languageStyle, roleType } = selectedTags;
            
            if (personality.length === 0 && languageStyle.length === 0 && roleType.length === 0) {
                document.getElementById('generatedPrompt').textContent = 'é€‰æ‹©æ ‡ç­¾åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ç”Ÿæˆè§’è‰²æç¤ºè¯...';
                return;
            }
            
            let prompt = 'ä½ æ˜¯ä¸€ä¸ªæœ‰ç‹¬ç‰¹æ€§æ ¼çš„ AI è§’è‰²';
            
            if (roleType.length > 0) {
                prompt += `ï¼Œèº«ä»½æ˜¯${roleType.join('ã€')}`;
            }
            
            if (personality.length > 0) {
                prompt += `ï¼Œæ€§æ ¼${personality.join('ã€')}`;
            }
            
            if (languageStyle.length > 0) {
                prompt += `ï¼Œå–œæ¬¢ç”¨${languageStyle.join('ã€')}çš„è¯­æ°”ä¸äººäº¤æµ`;
            }
            
            prompt += 'ã€‚è¯·å§‹ç»ˆä¿æŒè¿™ä¸ªè§’è‰²è®¾å®šï¼Œç”¨ç¬¦åˆè§’è‰²æ€§æ ¼çš„æ–¹å¼å›åº”ç”¨æˆ·çš„æ¯ä¸€å¥è¯ã€‚';
            
            document.getElementById('generatedPrompt').textContent = prompt;
        }

        // åˆ‡æ¢åˆ›å»ºæ¨¡å¼
        function switchMode(mode) {
            currentMode = mode;
            
            const tagModeBtn = document.getElementById('tagModeBtn');
            const customModeBtn = document.getElementById('customModeBtn');
            const aiModeBtn = document.getElementById('aiModeBtn');
            const tagModeDiv = document.getElementById('tagMode');
            const customModeDiv = document.getElementById('customMode');
            const aiModeDiv = document.getElementById('aiMode');
            
            // é‡ç½®æ‰€æœ‰æŒ‰é’®æ ·å¼
            tagModeBtn.className = 'bg-gray-200 text-gray-700 px-4 py-3 rounded-lg font-medium transition';
            customModeBtn.className = 'bg-gray-200 text-gray-700 px-4 py-3 rounded-lg font-medium transition';
            aiModeBtn.className = 'bg-gray-200 text-gray-700 px-4 py-3 rounded-lg font-medium transition';
            
            // éšè—æ‰€æœ‰æ¨¡å¼
            tagModeDiv.classList.add('hidden');
            customModeDiv.classList.add('hidden');
            aiModeDiv.classList.add('hidden');
            
            // æ¿€æ´»é€‰ä¸­çš„æ¨¡å¼
            if (mode === 'tag') {
                tagModeBtn.className = 'bg-indigo-600 text-white px-4 py-3 rounded-lg font-medium transition';
                tagModeDiv.classList.remove('hidden');
            } else if (mode === 'custom') {
                customModeBtn.className = 'bg-indigo-600 text-white px-4 py-3 rounded-lg font-medium transition';
                customModeDiv.classList.remove('hidden');
            } else if (mode === 'ai') {
                aiModeBtn.className = 'bg-indigo-600 text-white px-4 py-3 rounded-lg font-medium transition';
                aiModeDiv.classList.remove('hidden');
            }
        }

        // é¢„è§ˆPromptæ•ˆæœ
        async function previewPrompt() {
            const prompt = currentMode === 'tag' 
                ? document.getElementById('generatedPrompt').textContent
                : document.getElementById('customPrompt').value.trim();
            
            if (!prompt || prompt === 'é€‰æ‹©æ ‡ç­¾åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ç”Ÿæˆè§’è‰²æç¤ºè¯...') {
                showNotification('è¯·å…ˆè®¾ç½®è§’è‰²æç¤ºè¯', 'error');
                return;
            }
            
            try {
                showLoading();
                const response = await fetch('/api/generate-preview', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ system_prompt: prompt })
                });
                
                const result = await response.json();
                if (result.preview) {
                    showPreviewModal(result.preview);
                } else {
                    showNotification('é¢„è§ˆç”Ÿæˆå¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('é¢„è§ˆå¤±è´¥:', error);
                showNotification('é¢„è§ˆå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            } finally {
                hideLoading();
            }
        }

        // æ˜¾ç¤ºé¢„è§ˆæ¨¡æ€æ¡†
        function showPreviewModal(content) {
            document.getElementById('previewContent').textContent = content;
            document.getElementById('previewModal').classList.remove('hidden');
            document.getElementById('previewModal').classList.add('flex');
        }

        // éšè—é¢„è§ˆæ¨¡æ€æ¡†
        function hidePreviewModal() {
            document.getElementById('previewModal').classList.add('hidden');
            document.getElementById('previewModal').classList.remove('flex');
        }

        // è¡¨å•æäº¤
        document.getElementById('characterForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const name = document.getElementById('characterName').value.trim();
            const description = document.getElementById('characterDescription').value.trim();
            
            if (!name) {
                showNotification('è¯·è¾“å…¥è§’è‰²åç§°', 'error');
                return;
            }
            
            let systemPrompt;
            let personality = '';
            
            if (currentMode === 'tag') {
                systemPrompt = document.getElementById('generatedPrompt').textContent;
                if (systemPrompt === 'é€‰æ‹©æ ‡ç­¾åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ç”Ÿæˆè§’è‰²æç¤ºè¯...') {
                    showNotification('è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªæ ‡ç­¾', 'error');
                    return;
                }
                personality = Object.values(selectedTags).flat().join('ã€');
            } else if (currentMode === 'custom') {
                systemPrompt = document.getElementById('customPrompt').value.trim();
                if (!systemPrompt) {
                    showNotification('è¯·è¾“å…¥è‡ªå®šä¹‰Prompt', 'error');
                    return;
                }
                personality = 'è‡ªå®šä¹‰è§’è‰²';
            } else if (currentMode === 'ai') {
                // AIæ¨¡å¼ï¼šæ£€æŸ¥æ˜¯å¦æœ‰ç”Ÿæˆçš„æç¤ºè¯
                const aiEditPrompt = document.getElementById('aiEditPrompt');
                const aiGeneratedPrompt = document.getElementById('aiGeneratedPrompt');
                
                if (aiEditPrompt.value.trim()) {
                    systemPrompt = aiEditPrompt.value.trim();
                } else if (aiGeneratedPrompt.textContent.trim()) {
                    systemPrompt = aiGeneratedPrompt.textContent.trim();
                } else {
                    showNotification('è¯·å…ˆä½¿ç”¨AIç”Ÿæˆè§’è‰²æç¤ºè¯', 'error');
                    return;
                }
                personality = 'AIç”Ÿæˆè§’è‰²';
            }
            
            try {
                showLoading();
                const response = await fetch('/api/create-character', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: name,
                        personality: personality,
                        description: description,
                        system_prompt: systemPrompt
                    })
                });
                
                const result = await response.json();
                if (response.ok) {
                    showNotification('è§’è‰²åˆ›å»ºæˆåŠŸï¼', 'success');
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 1500);
                } else {
                    showNotification(result.error || 'åˆ›å»ºå¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('åˆ›å»ºè§’è‰²å¤±è´¥:', error);
                showNotification('åˆ›å»ºå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            } finally {
                hideLoading();
            }
        });

        // å·¥å…·å‡½æ•°
        function showLoading() {
            document.getElementById('loadingSpinner').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingSpinner').classList.add('hidden');
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            
            notification.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-transform duration-300 translate-x-full`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        // AIæ¨¡å¼ç›¸å…³å‡½æ•°
        async function generateAIPrompt() {
            const userInput = document.getElementById('aiInput').value.trim();
            if (!userInput) {
                showNotification('è¯·è¾“å…¥è§’è‰²æè¿°', 'error');
                return;
            }

            const generateBtn = document.getElementById('generateBtn');
            const originalText = generateBtn.textContent;
            generateBtn.disabled = true;
            generateBtn.textContent = 'ç”Ÿæˆä¸­...';

            try {
                const response = await fetch('/api/generate-character-prompt', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        description: userInput
                    })
                });

                const result = await response.json();
                if (response.ok) {
                    document.getElementById('aiGeneratedPrompt').textContent = result.prompt;
                    document.getElementById('aiResultContainer').classList.remove('hidden');
                    showNotification('AIæç¤ºè¯ç”ŸæˆæˆåŠŸï¼', 'success');
                } else {
                    showNotification(result.error || 'AIç”Ÿæˆå¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('AIç”Ÿæˆå¤±è´¥:', error);
                showNotification('AIç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = originalText;
            }
        }

        function acceptAIPrompt() {
            const generatedPrompt = document.getElementById('aiGeneratedPrompt').textContent;
            document.getElementById('aiEditPrompt').value = generatedPrompt;
            document.getElementById('aiEditContainer').classList.remove('hidden');
            showNotification('å·²æ¥å—AIç”Ÿæˆçš„æç¤ºè¯ï¼Œå¯ä»¥è¿›è¡Œç¼–è¾‘', 'success');
        }

        function editAIPrompt() {
            document.getElementById('aiEditContainer').classList.remove('hidden');
            const generatedPrompt = document.getElementById('aiGeneratedPrompt').textContent;
            if (generatedPrompt && !document.getElementById('aiEditPrompt').value.trim()) {
                document.getElementById('aiEditPrompt').value = generatedPrompt;
            }
        }

        async function regenerateAIPrompt() {
            const userInput = document.getElementById('aiInput').value.trim();
            if (!userInput) {
                showNotification('è¯·è¾“å…¥è§’è‰²æè¿°', 'error');
                return;
            }

            const regenerateBtn = document.querySelector('#aiResultContainer button:last-child');
            const originalText = regenerateBtn.textContent;
            regenerateBtn.disabled = true;
            regenerateBtn.textContent = 'é‡æ–°ç”Ÿæˆä¸­...';

            try {
                const response = await fetch('/api/generate-character-prompt', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        description: userInput
                    })
                });

                const result = await response.json();
                if (response.ok) {
                    document.getElementById('aiGeneratedPrompt').textContent = result.prompt;
                    showNotification('AIæç¤ºè¯é‡æ–°ç”ŸæˆæˆåŠŸï¼', 'success');
                } else {
                    showNotification(result.error || 'AIé‡æ–°ç”Ÿæˆå¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('AIé‡æ–°ç”Ÿæˆå¤±è´¥:', error);
                showNotification('AIé‡æ–°ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            } finally {
                regenerateBtn.disabled = false;
                regenerateBtn.textContent = originalText;
            }
        }

        function clearAIInput() {
            document.getElementById('aiInput').value = '';
            document.getElementById('aiGeneratedPrompt').textContent = '';
            document.getElementById('aiEditPrompt').value = '';
            document.getElementById('aiResultContainer').classList.add('hidden');
            document.getElementById('aiEditContainer').classList.add('hidden');
        }

        function saveAIEdit() {
            const editedPrompt = document.getElementById('aiEditPrompt').value.trim();
            if (!editedPrompt) {
                showNotification('ç¼–è¾‘å†…å®¹ä¸èƒ½ä¸ºç©º', 'error');
                return;
            }
            document.getElementById('aiEditContainer').classList.add('hidden');
            showNotification('æç¤ºè¯ç¼–è¾‘å®Œæˆï¼Œå¯ä»¥åˆ›å»ºè§’è‰²äº†', 'success');
        }

        function cancelAIEdit() {
            document.getElementById('aiEditContainer').classList.add('hidden');
        }

        // AIæ¨¡å¼æŒ‰é’®å‡½æ•°åˆ«å
        function clearAIResult() {
            clearAIInput();
        }

        function acceptAIResult() {
            acceptAIPrompt();
        }

        function editAIResult() {
            editAIPrompt();
        }

        function regenerateAI() {
            regenerateAIPrompt();
        }
    </script>
</body>
</html>