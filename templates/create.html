<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>创建AI角色 - ChatPersona</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-purple-50 to-indigo-100 min-h-screen">
    <!-- 导航栏 -->
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-indigo-600 rounded-full flex items-center justify-center">
                        <span class="text-white font-bold text-sm">CP</span>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-800">ChatPersona</h1>
                </div>
                <div class="flex space-x-4">
                    <a href="/" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg text-sm font-medium transition">
                        ← 返回首页
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主内容区 -->
    <div class="max-w-4xl mx-auto px-4 py-8">
        <div class="text-center mb-8">
            <h2 class="text-4xl font-bold text-gray-800 mb-4">创建你的AI角色</h2>
            <p class="text-gray-600 text-lg">设计独特的人格，让AI拥有自己的个性</p>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-8">
            <form id="characterForm" class="space-y-6">
                <!-- 基本信息 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">角色名称 *</label>
                        <input type="text" id="characterName" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="给你的角色起个名字">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">角色描述</label>
                        <input type="text" id="characterDescription" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="简单描述角色特点">
                    </div>
                </div>
                
                <!-- 头像设置 -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">头像设置</label>
                    <div class="flex items-center space-x-4 mb-3">
                        <div id="avatarPreview" class="w-16 h-16 bg-indigo-400 rounded-full flex items-center justify-center text-white text-2xl font-bold">A</div>
                        <div class="flex space-x-2">
                            <button type="button" onclick="showEmojiSelector()" class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-4 py-2 rounded-lg text-sm font-medium transition">
                                😀 选择表情
                            </button>
                            <button type="button" onclick="document.getElementById('avatarUpload').click()" class="bg-green-100 hover:bg-green-200 text-green-700 px-4 py-2 rounded-lg text-sm font-medium transition">
                                📁 上传图片
                            </button>
                            <button type="button" onclick="resetToInitial()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium transition">
                                🔄 重置为首字母
                            </button>
                        </div>
                    </div>
                    <input type="file" id="avatarUpload" accept="image/*" style="display: none" onchange="handleAvatarUpload(event)">
                    <input type="hidden" id="avatarType" value="initial">
                    <input type="hidden" id="avatarValue">
                    <p class="text-sm text-gray-500">选择表情符号作为头像，或上传自定义图片（最大5MB）</p>
                </div>

                <!-- 创建方式选择 -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-4">创建方式</label>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <button type="button" id="tagModeBtn" onclick="switchMode('tag')" class="bg-indigo-600 text-white px-4 py-3 rounded-lg font-medium transition">
                            🏷️ 标签式配置
                        </button>
                        <button type="button" id="customModeBtn" onclick="switchMode('custom')" class="bg-gray-200 text-gray-700 px-4 py-3 rounded-lg font-medium transition">
                            ✏️ 自定义Prompt
                        </button>
                        <button type="button" id="aiModeBtn" onclick="switchMode('ai')" class="bg-gray-200 text-gray-700 px-4 py-3 rounded-lg font-medium transition">
                            🤖 AI帮我建
                        </button>
                    </div>
                </div>

                <!-- 标签式配置模式 -->
                <div id="tagMode" class="space-y-6">
                    <!-- 性格关键词 -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-3">性格关键词</label>
                        <div class="flex flex-wrap gap-2" id="personalityTags">
                            <!-- 性格标签 -->
                        </div>
                        <div class="mt-3">
                            <input type="text" id="customPersonality" placeholder="或输入自定义性格词汇" class="w-full p-2 border border-gray-300 rounded-lg text-sm">
                            <button type="button" onclick="addCustomPersonality()" class="mt-2 bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded text-sm transition">
                                添加
                            </button>
                        </div>
                    </div>

                    <!-- 语言风格 -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-3">语言风格</label>
                        <div class="flex flex-wrap gap-2" id="languageStyleTags">
                            <!-- 语言风格标签 -->
                        </div>
                    </div>

                    <!-- 角色类型 -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-3">角色类型</label>
                        <div class="flex flex-wrap gap-2" id="roleTypeTags">
                            <!-- 角色类型标签 -->
                        </div>
                    </div>

                    <!-- 生成的Prompt预览 -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">生成的Prompt预览</label>
                        <div id="generatedPrompt" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg min-h-24 text-sm text-gray-700">
                            选择标签后，系统会自动生成角色提示词...
                        </div>
                    </div>
                </div>

                <!-- 自定义Prompt模式 -->
                <div id="customMode" class="space-y-6 hidden">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">自定义系统Prompt *</label>
                        <textarea id="customPrompt" rows="8" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="你是一个有独特性格的 AI 角色，喜欢用「xx」的语气与人交流。请详细描述角色的性格、说话方式、行为特点等..."></textarea>
                        <p class="text-xs text-gray-500 mt-1">提示：详细的角色设定能让AI表现更加生动</p>
                    </div>

                    <!-- Prompt预览按钮 -->
                    <div>
                        <button type="button" onclick="previewPrompt()" class="bg-purple-100 hover:bg-purple-200 text-purple-700 px-4 py-2 rounded-lg font-medium transition">
                            🔍 预览效果
                        </button>
                    </div>
                </div>

                <!-- AI帮我建模式 -->
                <div id="aiMode" class="space-y-6 hidden">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">描述你想要的角色 *</label>
                        <textarea id="aiInput" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="例如：我想要一个温柔善良的大姐姐角色，说话很温柔，喜欢照顾别人，有点天然呆的感觉..."></textarea>
                        <p class="text-xs text-gray-500 mt-1">提示：描述得越详细，AI生成的角色越符合你的期望</p>
                    </div>

                    <div class="flex space-x-4">
                        <button type="button" onclick="generateAIPrompt()" id="generateBtn" class="bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white px-6 py-2 rounded-lg font-medium transition">
                            🤖 AI帮我改
                        </button>
                        <button type="button" onclick="clearAIResult()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg font-medium transition">
                            🗑️ 清空
                        </button>
                    </div>

                    <!-- AI生成结果 -->
                    <div id="aiResultContainer" class="hidden">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">AI生成的系统提示词</label>
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-4 mb-3">
                            <div id="aiGeneratedPrompt" class="text-gray-800 whitespace-pre-wrap"></div>
                        </div>
                        <div class="flex space-x-3">
                            <button type="button" onclick="acceptAIResult()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium transition">
                                ✅ 确认使用
                            </button>
                            <button type="button" onclick="editAIResult()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition">
                                ✏️ 手动修改
                            </button>
                            <button type="button" onclick="regenerateAI()" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-medium transition">
                                🔄 重新生成
                            </button>
                        </div>
                    </div>

                    <!-- 手动编辑区域 -->
                    <div id="aiEditContainer" class="hidden">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">编辑系统提示词</label>
                        <textarea id="aiEditPrompt" rows="8" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"></textarea>
                        <div class="flex space-x-3 mt-3">
                            <button type="button" onclick="saveAIEdit()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium transition">
                                💾 保存修改
                            </button>
                            <button type="button" onclick="cancelAIEdit()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium transition">
                                ❌ 取消编辑
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 提交按钮 -->
                <div class="flex space-x-4 pt-6">
                    <button type="button" onclick="window.location.href='/'" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-3 rounded-lg font-medium transition">
                        取消
                    </button>
                    <button type="submit" class="flex-1 bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white px-6 py-3 rounded-lg font-medium transition">
                        ✨ 创建角色
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Emoji选择器模态框 -->
    <div id="emojiModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 max-h-[80vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4">选择表情头像</h3>
            <div class="grid grid-cols-6 gap-2 mb-4" id="emojiGrid">
                <!-- Emoji选项将通过JavaScript生成 -->
            </div>
            <button onclick="hideEmojiSelector()" class="w-full bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg transition">
                取消
            </button>
        </div>
    </div>

    <!-- 预览模态框 -->
    <div id="previewModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 max-w-lg w-full mx-4">
            <h3 class="text-xl font-bold mb-4">角色预览</h3>
            <div class="bg-gray-50 p-4 rounded-lg mb-4 max-h-64 overflow-y-auto">
                <p id="previewContent" class="text-gray-800">加载中...</p>
            </div>
            <button onclick="hidePreviewModal()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition">
                关闭
            </button>
        </div>
    </div>

    <!-- 加载提示 -->
    <div id="loadingSpinner" class="fixed inset-0 bg-white bg-opacity-80 flex items-center justify-center z-40 hidden">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
            <p class="text-gray-600">处理中...</p>
        </div>
    </div>

    <script>
        let currentMode = 'tag';
        let selectedTags = {
            personality: [],
            languageStyle: [],
            roleType: []
        };

        // 预定义标签
        const tagOptions = {
            personality: [
                '温柔', '热血', '冷静', '活泼', '内向', '外向', '幽默', '严肃',
                '善良', '毒舌', '中二', '成熟', '天真', '理性', '感性', '乐观',
                '悲观', '自信', '害羞', '勇敢', '胆小', '机灵', '呆萌', '高冷'
            ],
            languageStyle: [
                '可爱语气', '正式语气', '方言口音', '古风文雅', '现代潮流',
                '二次元风', '学者风格', '小孩子气', '大姐姐风', '傲娇语气',
                '温柔细语', '豪爽直接', '诗意浪漫', '科技感', '搞笑风趣'
            ],
            roleType: [
                '学生', '老师', '医生', '艺术家', '科学家', '冒险家',
                '魔法师', '武士', '商人', '厨师', '音乐家', '作家',
                '程序员', '设计师', '探险家', '哲学家', '心理咨询师', '宠物'
            ]
        };

        // 头像相关函数
        const commonEmojis = [
            '😀', '😃', '😄', '😁', '😆', '😅', '😂', '🤣', '😊', '😇',
            '🙂', '🙃', '😉', '😌', '😍', '🥰', '😘', '😗', '😙', '😚',
            '😋', '😛', '😝', '😜', '🤪', '🤨', '🧐', '🤓', '😎', '🤩',
            '🥳', '😏', '😒', '😞', '😔', '😟', '😕', '🙁', '☹️', '😣',
            '😖', '😫', '😩', '🥺', '😢', '😭', '😤', '😠', '😡', '🤬',
            '🤯', '😳', '🥵', '🥶', '😱', '😨', '😰', '😥', '😓', '🤗',
            '🤔', '🤭', '🤫', '🤥', '😶', '😐', '😑', '😬', '🙄', '😯',
            '😦', '😧', '😮', '😲', '🥱', '😴', '🤤', '😪', '😵', '🤐',
            '🥴', '🤢', '🤮', '🤧', '😷', '🤒', '🤕', '🤑', '🤠', '😈',
            '👿', '👹', '👺', '🤡', '💩', '👻', '💀', '☠️', '👽', '👾',
            '🤖', '🎃', '😺', '😸', '😹', '😻', '😼', '😽', '🙀', '😿',
            '😾', '👶', '👧', '🧒', '👦', '👩', '🧑', '👨', '👵', '🧓',
            '👴', '👲', '👳', '👮', '👷', '💂', '🕵️', '👩‍⚕️', '👨‍⚕️', '👩‍🌾'
        ];
        
        function showEmojiSelector() {
            const emojiGrid = document.getElementById('emojiGrid');
            emojiGrid.innerHTML = '';
            
            commonEmojis.forEach(emoji => {
                const button = document.createElement('button');
                button.className = 'w-10 h-10 text-2xl hover:bg-gray-100 rounded transition';
                button.textContent = emoji;
                button.onclick = () => selectEmoji(emoji);
                emojiGrid.appendChild(button);
            });
            
            document.getElementById('emojiModal').classList.remove('hidden');
            document.getElementById('emojiModal').classList.add('flex');
        }
        
        function hideEmojiSelector() {
            document.getElementById('emojiModal').classList.add('hidden');
            document.getElementById('emojiModal').classList.remove('flex');
        }
        
        function selectEmoji(emoji) {
            document.getElementById('avatarType').value = 'emoji';
            document.getElementById('avatarValue').value = emoji;
            updateAvatarPreview();
            hideEmojiSelector();
        }
        
        function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) { // 5MB限制
                    alert('图片大小不能超过5MB');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('avatarType').value = 'upload';
                    document.getElementById('avatarValue').value = e.target.result;
                    updateAvatarPreview();
                };
                reader.readAsDataURL(file);
            }
        }
        
        function resetToInitial() {
            document.getElementById('avatarType').value = 'initial';
            document.getElementById('avatarValue').value = '';
            updateAvatarPreview();
        }
        
        // 生成头像HTML
        function generateAvatarHtml(character, sizeClass = 'w-16 h-16') {
            const avatarType = character.avatar_type || 'initial';
            const avatarValue = character.avatar_value;
            const textSize = sizeClass.includes('w-12') ? 'text-xl' : sizeClass.includes('w-8') ? 'text-sm' : 'text-2xl';
            const emojiSize = sizeClass.includes('w-12') ? 'text-xl' : sizeClass.includes('w-8') ? 'text-lg' : 'text-3xl';
            
            if (avatarType === 'emoji' && avatarValue) {
                return `<div class="${sizeClass} bg-gray-100 rounded-full flex items-center justify-center ${emojiSize}">${avatarValue}</div>`;
            } else if (avatarType === 'upload' && avatarValue) {
                return `<div class="${sizeClass} rounded-full overflow-hidden"><img src="${avatarValue}" alt="${character.name}" class="w-full h-full object-cover"></div>`;
            } else {
                // 默认使用首字母头像
                const colors = ['bg-red-400', 'bg-blue-400', 'bg-green-400', 'bg-yellow-400', 'bg-purple-400', 'bg-pink-400', 'bg-indigo-400'];
                const colorIndex = character.id ? character.id % colors.length : Math.floor(Math.random() * colors.length);
                const bgColor = colors[colorIndex];
                return `<div class="${sizeClass} ${bgColor} rounded-full flex items-center justify-center text-white ${textSize} font-bold">${character.name.charAt(0)}</div>`;
            }
        }

        function updateAvatarPreview() {
            const avatarType = document.getElementById('avatarType').value;
            const avatarValue = document.getElementById('avatarValue').value;
            const preview = document.getElementById('avatarPreview');
            const characterName = document.getElementById('characterName').value || 'A';
            
            // 创建临时角色对象
            const tempCharacter = {
                name: characterName,
                avatar_type: avatarType,
                avatar_value: avatarValue
            };
            
            // 使用统一的头像生成函数
            preview.outerHTML = `<div id="avatarPreview">${generateAvatarHtml(tempCharacter, 'w-16 h-16 text-2xl')}</div>`;
        }

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeTags();
            updateGeneratedPrompt();
            
            // 监听角色名称输入，实时更新头像预览
            const nameInput = document.getElementById('characterName');
            if (nameInput) {
                nameInput.addEventListener('input', updateAvatarPreview);
            }
        });

        // 初始化标签
        function initializeTags() {
            Object.keys(tagOptions).forEach(category => {
                const container = document.getElementById(category + 'Tags');
                tagOptions[category].forEach(tag => {
                    const tagElement = createTagElement(tag, category);
                    container.appendChild(tagElement);
                });
            });
        }

        // 创建标签元素
        function createTagElement(tag, category) {
            const span = document.createElement('span');
            span.className = 'px-3 py-1 bg-gray-100 text-gray-700 rounded-full cursor-pointer hover:bg-indigo-100 hover:text-indigo-700 transition text-sm';
            span.textContent = tag;
            span.onclick = () => toggleTag(tag, category, span);
            return span;
        }

        // 切换标签选择状态
        function toggleTag(tag, category, element) {
            const isSelected = selectedTags[category].includes(tag);
            
            if (isSelected) {
                selectedTags[category] = selectedTags[category].filter(t => t !== tag);
                element.className = 'px-3 py-1 bg-gray-100 text-gray-700 rounded-full cursor-pointer hover:bg-indigo-100 hover:text-indigo-700 transition text-sm';
            } else {
                selectedTags[category].push(tag);
                element.className = 'px-3 py-1 bg-indigo-600 text-white rounded-full cursor-pointer transition text-sm';
            }
            
            updateGeneratedPrompt();
        }

        // 添加自定义性格标签
        function addCustomPersonality() {
            const input = document.getElementById('customPersonality');
            const value = input.value.trim();
            
            if (value && !selectedTags.personality.includes(value)) {
                selectedTags.personality.push(value);
                
                // 创建新标签元素
                const container = document.getElementById('personalityTags');
                const tagElement = createTagElement(value, 'personality');
                tagElement.className = 'px-3 py-1 bg-indigo-600 text-white rounded-full cursor-pointer transition text-sm';
                container.appendChild(tagElement);
                
                input.value = '';
                updateGeneratedPrompt();
            }
        }

        // 更新生成的Prompt
        function updateGeneratedPrompt() {
            const { personality, languageStyle, roleType } = selectedTags;
            
            if (personality.length === 0 && languageStyle.length === 0 && roleType.length === 0) {
                document.getElementById('generatedPrompt').textContent = '选择标签后，系统会自动生成角色提示词...';
                return;
            }
            
            let prompt = '你是一个有独特性格的 AI 角色';
            
            if (roleType.length > 0) {
                prompt += `，身份是${roleType.join('、')}`;
            }
            
            if (personality.length > 0) {
                prompt += `，性格${personality.join('、')}`;
            }
            
            if (languageStyle.length > 0) {
                prompt += `，喜欢用${languageStyle.join('、')}的语气与人交流`;
            }
            
            prompt += '。请始终保持这个角色设定，用符合角色性格的方式回应用户的每一句话。';
            
            document.getElementById('generatedPrompt').textContent = prompt;
        }

        // 切换创建模式
        function switchMode(mode) {
            currentMode = mode;
            
            const tagModeBtn = document.getElementById('tagModeBtn');
            const customModeBtn = document.getElementById('customModeBtn');
            const aiModeBtn = document.getElementById('aiModeBtn');
            const tagModeDiv = document.getElementById('tagMode');
            const customModeDiv = document.getElementById('customMode');
            const aiModeDiv = document.getElementById('aiMode');
            
            // 重置所有按钮样式
            tagModeBtn.className = 'bg-gray-200 text-gray-700 px-4 py-3 rounded-lg font-medium transition';
            customModeBtn.className = 'bg-gray-200 text-gray-700 px-4 py-3 rounded-lg font-medium transition';
            aiModeBtn.className = 'bg-gray-200 text-gray-700 px-4 py-3 rounded-lg font-medium transition';
            
            // 隐藏所有模式
            tagModeDiv.classList.add('hidden');
            customModeDiv.classList.add('hidden');
            aiModeDiv.classList.add('hidden');
            
            // 激活选中的模式
            if (mode === 'tag') {
                tagModeBtn.className = 'bg-indigo-600 text-white px-4 py-3 rounded-lg font-medium transition';
                tagModeDiv.classList.remove('hidden');
            } else if (mode === 'custom') {
                customModeBtn.className = 'bg-indigo-600 text-white px-4 py-3 rounded-lg font-medium transition';
                customModeDiv.classList.remove('hidden');
            } else if (mode === 'ai') {
                aiModeBtn.className = 'bg-indigo-600 text-white px-4 py-3 rounded-lg font-medium transition';
                aiModeDiv.classList.remove('hidden');
            }
        }

        // 预览Prompt效果
        async function previewPrompt() {
            const prompt = currentMode === 'tag' 
                ? document.getElementById('generatedPrompt').textContent
                : document.getElementById('customPrompt').value.trim();
            
            if (!prompt || prompt === '选择标签后，系统会自动生成角色提示词...') {
                showNotification('请先设置角色提示词', 'error');
                return;
            }
            
            try {
                showLoading();
                const response = await fetch('/api/generate-preview', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ system_prompt: prompt })
                });
                
                const result = await response.json();
                if (result.preview) {
                    showPreviewModal(result.preview);
                } else {
                    showNotification('预览生成失败', 'error');
                }
            } catch (error) {
                console.error('预览失败:', error);
                showNotification('预览失败，请重试', 'error');
            } finally {
                hideLoading();
            }
        }

        // 显示预览模态框
        function showPreviewModal(content) {
            document.getElementById('previewContent').textContent = content;
            document.getElementById('previewModal').classList.remove('hidden');
            document.getElementById('previewModal').classList.add('flex');
        }

        // 隐藏预览模态框
        function hidePreviewModal() {
            document.getElementById('previewModal').classList.add('hidden');
            document.getElementById('previewModal').classList.remove('flex');
        }

        // 表单提交
        document.getElementById('characterForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const name = document.getElementById('characterName').value.trim();
            const description = document.getElementById('characterDescription').value.trim();
            
            if (!name) {
                showNotification('请输入角色名称', 'error');
                return;
            }
            
            let systemPrompt;
            let personality = '';
            
            if (currentMode === 'tag') {
                systemPrompt = document.getElementById('generatedPrompt').textContent;
                if (systemPrompt === '选择标签后，系统会自动生成角色提示词...') {
                    showNotification('请选择至少一个标签', 'error');
                    return;
                }
                personality = Object.values(selectedTags).flat().join('、');
            } else if (currentMode === 'custom') {
                systemPrompt = document.getElementById('customPrompt').value.trim();
                if (!systemPrompt) {
                    showNotification('请输入自定义Prompt', 'error');
                    return;
                }
                personality = '自定义角色';
            } else if (currentMode === 'ai') {
                // AI模式：检查是否有生成的提示词
                const aiEditPrompt = document.getElementById('aiEditPrompt');
                const aiGeneratedPrompt = document.getElementById('aiGeneratedPrompt');
                
                if (aiEditPrompt.value.trim()) {
                    systemPrompt = aiEditPrompt.value.trim();
                } else if (aiGeneratedPrompt.textContent.trim()) {
                    systemPrompt = aiGeneratedPrompt.textContent.trim();
                } else {
                    showNotification('请先使用AI生成角色提示词', 'error');
                    return;
                }
                personality = 'AI生成角色';
            }
            
            try {
                showLoading();
                const response = await fetch('/api/create-character', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: name,
                        personality: personality,
                        description: description,
                        system_prompt: systemPrompt
                    })
                });
                
                const result = await response.json();
                if (response.ok) {
                    showNotification('角色创建成功！', 'success');
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 1500);
                } else {
                    showNotification(result.error || '创建失败', 'error');
                }
            } catch (error) {
                console.error('创建角色失败:', error);
                showNotification('创建失败，请重试', 'error');
            } finally {
                hideLoading();
            }
        });

        // 工具函数
        function showLoading() {
            document.getElementById('loadingSpinner').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingSpinner').classList.add('hidden');
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            
            notification.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-transform duration-300 translate-x-full`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        // AI模式相关函数
        async function generateAIPrompt() {
            const userInput = document.getElementById('aiInput').value.trim();
            if (!userInput) {
                showNotification('请输入角色描述', 'error');
                return;
            }

            const generateBtn = document.getElementById('generateBtn');
            const originalText = generateBtn.textContent;
            generateBtn.disabled = true;
            generateBtn.textContent = '生成中...';

            try {
                const response = await fetch('/api/generate-character-prompt', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        description: userInput
                    })
                });

                const result = await response.json();
                if (response.ok) {
                    document.getElementById('aiGeneratedPrompt').textContent = result.prompt;
                    document.getElementById('aiResultContainer').classList.remove('hidden');
                    showNotification('AI提示词生成成功！', 'success');
                } else {
                    showNotification(result.error || 'AI生成失败', 'error');
                }
            } catch (error) {
                console.error('AI生成失败:', error);
                showNotification('AI生成失败，请重试', 'error');
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = originalText;
            }
        }

        function acceptAIPrompt() {
            const generatedPrompt = document.getElementById('aiGeneratedPrompt').textContent;
            document.getElementById('aiEditPrompt').value = generatedPrompt;
            document.getElementById('aiEditContainer').classList.remove('hidden');
            showNotification('已接受AI生成的提示词，可以进行编辑', 'success');
        }

        function editAIPrompt() {
            document.getElementById('aiEditContainer').classList.remove('hidden');
            const generatedPrompt = document.getElementById('aiGeneratedPrompt').textContent;
            if (generatedPrompt && !document.getElementById('aiEditPrompt').value.trim()) {
                document.getElementById('aiEditPrompt').value = generatedPrompt;
            }
        }

        async function regenerateAIPrompt() {
            const userInput = document.getElementById('aiInput').value.trim();
            if (!userInput) {
                showNotification('请输入角色描述', 'error');
                return;
            }

            const regenerateBtn = document.querySelector('#aiResultContainer button:last-child');
            const originalText = regenerateBtn.textContent;
            regenerateBtn.disabled = true;
            regenerateBtn.textContent = '重新生成中...';

            try {
                const response = await fetch('/api/generate-character-prompt', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        description: userInput
                    })
                });

                const result = await response.json();
                if (response.ok) {
                    document.getElementById('aiGeneratedPrompt').textContent = result.prompt;
                    showNotification('AI提示词重新生成成功！', 'success');
                } else {
                    showNotification(result.error || 'AI重新生成失败', 'error');
                }
            } catch (error) {
                console.error('AI重新生成失败:', error);
                showNotification('AI重新生成失败，请重试', 'error');
            } finally {
                regenerateBtn.disabled = false;
                regenerateBtn.textContent = originalText;
            }
        }

        function clearAIInput() {
            document.getElementById('aiInput').value = '';
            document.getElementById('aiGeneratedPrompt').textContent = '';
            document.getElementById('aiEditPrompt').value = '';
            document.getElementById('aiResultContainer').classList.add('hidden');
            document.getElementById('aiEditContainer').classList.add('hidden');
        }

        function saveAIEdit() {
            const editedPrompt = document.getElementById('aiEditPrompt').value.trim();
            if (!editedPrompt) {
                showNotification('编辑内容不能为空', 'error');
                return;
            }
            document.getElementById('aiEditContainer').classList.add('hidden');
            showNotification('提示词编辑完成，可以创建角色了', 'success');
        }

        function cancelAIEdit() {
            document.getElementById('aiEditContainer').classList.add('hidden');
        }

        // AI模式按钮函数别名
        function clearAIResult() {
            clearAIInput();
        }

        function acceptAIResult() {
            acceptAIPrompt();
        }

        function editAIResult() {
            editAIPrompt();
        }

        function regenerateAI() {
            regenerateAIPrompt();
        }
    </script>
</body>
</html>