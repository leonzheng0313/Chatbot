<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatSanctuary - å¿ƒçµå°å±‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'sanctuary-blue': '#B5C6E0',
                        'sanctuary-cream': '#FAF4EC',
                        'sanctuary-pink': '#FADADD',
                        'sanctuary-soft': '#E8F4F8'
                    },
                    animation: {
                        'bounce-gentle': 'bounce 1s ease-in-out 3',
                        'typing': 'typing 1.5s ease-in-out infinite',
                        'float': 'float 3s ease-in-out infinite',
                        'fade-in': 'fadeIn 0.8s ease-in-out',
                        'slide-up': 'slideUp 0.6s ease-out',
                        'painting': 'painting 2s ease-in-out infinite',
                        'glow': 'glow 2s ease-in-out infinite alternate'
                    },
                    keyframes: {
                        typing: {
                            '0%, 60%, 100%': { opacity: '1' },
                            '30%': { opacity: '0.4' }
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0px)' },
                            '50%': { transform: 'translateY(-10px)' }
                        },
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(100%)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        },
                        painting: {
                            '0%': { transform: 'rotate(0deg)' },
                            '25%': { transform: 'rotate(10deg)' },
                            '75%': { transform: 'rotate(-10deg)' },
                            '100%': { transform: 'rotate(0deg)' }
                        },
                        glow: {
                            '0%': { boxShadow: '0 0 5px rgba(181, 198, 224, 0.5)' },
                            '100%': { boxShadow: '0 0 20px rgba(181, 198, 224, 0.8)' }
                        }
                    }
                }
            }
        };
    </script>
</head>
<body class="bg-gradient-to-br from-sanctuary-cream via-sanctuary-soft to-sanctuary-blue min-h-screen">
    <!-- å¯¼èˆªæ  -->
    <nav class="bg-white/80 backdrop-blur-sm shadow-lg">
        <div class="max-w-7xl mx-auto px-2 sm:px-4">
            <div class="flex justify-between items-center py-3 sm:py-4">
                <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 bg-gradient-to-r from-sanctuary-blue to-sanctuary-pink rounded-full flex items-center justify-center">
                        <span class="text-white font-bold text-sm">ğŸ </span>
                    </div>
                    <h1 class="text-lg sm:text-2xl font-bold text-gray-800">ChatSanctuary</h1>
                    <span class="text-sm text-gray-500 hidden sm:inline">å¿ƒçµå°å±‹</span>
                </div>
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                    <a href="/" class="bg-gray-100 hover:bg-gray-200 px-3 sm:px-4 py-2 rounded-lg text-xs sm:text-sm font-medium transition text-center">
                        â† è¿”å›é¦–é¡µ
                    </a>
                    <button onclick="showMyGallery()" class="bg-sanctuary-blue hover:bg-sanctuary-blue/80 text-white px-3 sm:px-4 py-2 rounded-lg text-xs sm:text-sm font-medium transition">
                        ğŸ–¼ï¸ æˆ‘çš„å¿ƒæƒ…å›¾å†Œ
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="max-w-6xl mx-auto px-2 sm:px-4 py-4 sm:py-6">
        <!-- Step 1: æƒ…ç»ªæ ‘æ´è¾“å…¥åŒº -->
        <div id="emotionInputSection" class="bg-white/90 backdrop-blur-sm rounded-xl shadow-lg p-4 sm:p-6 mb-4 sm:mb-6 animate-fade-in">
            <div class="text-center mb-6">
                <div class="text-2xl sm:text-3xl font-bold text-gray-800 mb-2">ğŸŒ¸ å¿ƒçµå°å±‹</div>
                <div class="text-sanctuary-blue text-sm sm:text-base mb-4">
                    æ¬¢è¿æ¥åˆ°å¿ƒçµå°å±‹ï¼Œè¿™é‡Œæ˜¯ä½ çš„æƒ…æ„Ÿé¿é£æ¸¯ï½<br>
                    æ— è®ºæ˜¯ä»Šå¤©çš„å°ç¡®ä¸§ï¼Œè¿˜æ˜¯è¯´ä¸å‡ºå£çš„çº ç»“ï¼Œéƒ½å¯ä»¥åœ¨è¿™é‡Œè½»å£°è¯‰è¯´
                </div>
            </div>
            
            <div class="max-w-2xl mx-auto">
                <div class="mb-4">
                    <input id="userNameInput" 
                        placeholder="å‘Šè¯‰æˆ‘ä½ çš„åå­—..." 
                        class="w-full p-3 border-2 border-sanctuary-pink/30 rounded-xl focus:ring-2 focus:ring-sanctuary-pink focus:border-transparent text-sm sm:text-base bg-white/80 backdrop-blur-sm"
                        onkeypress="handleNameKeyPress(event)">
                    <div class="text-xs text-sanctuary-pink mt-1">ğŸ’ è™šæ‹Ÿæœ‹å‹ä»¬æƒ³çŸ¥é“æ€ä¹ˆç§°å‘¼ä½ </div>
                </div>
                <textarea id="emotionInput" 
                    placeholder="åœ¨è¿™é‡Œå€¾è¯‰ä½ çš„å¿ƒå£°..." 
                    class="w-full p-4 border-2 border-sanctuary-blue/30 rounded-xl focus:ring-2 focus:ring-sanctuary-blue focus:border-transparent resize-none h-32 text-sm sm:text-base bg-white/80 backdrop-blur-sm"
                    onkeypress="handleEmotionKeyPress(event)"></textarea>
                
                <div class="mt-3 text-xs sm:text-sm text-gray-500 space-y-1">
                    <div class="font-medium text-sanctuary-blue">ğŸ’­ ä¾‹ï¼š</div>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="setExampleText('æˆ‘ä»Šå¤©æœ‰ç‚¹emo...')" class="bg-sanctuary-pink/30 hover:bg-sanctuary-pink/50 px-3 py-1 rounded-full transition text-xs">
                            æˆ‘ä»Šå¤©æœ‰ç‚¹emo...
                        </button>
                        <button onclick="setExampleText('æˆ‘çº ç»“è¦ä¸è¦æ¢æ–¹å‘')" class="bg-sanctuary-blue/30 hover:bg-sanctuary-blue/50 px-3 py-1 rounded-full transition text-xs">
                            æˆ‘çº ç»“è¦ä¸è¦æ¢æ–¹å‘
                        </button>
                        <button onclick="setExampleText('æœ‰ç‚¹ä¸è¢«ç†è§£çš„æ„Ÿè§‰')" class="bg-sanctuary-cream hover:bg-sanctuary-cream/80 px-3 py-1 rounded-full transition text-xs">
                            æœ‰ç‚¹ä¸è¢«ç†è§£çš„æ„Ÿè§‰
                        </button>
                    </div>
                </div>
                
                <div class="mt-6 text-center">
                    <button onclick="startSanctuarySession()" 
                        class="bg-gradient-to-r from-sanctuary-blue to-sanctuary-pink hover:from-sanctuary-blue/80 hover:to-sanctuary-pink/80 text-white px-6 sm:px-8 py-3 rounded-xl font-medium transition transform hover:scale-105 text-sm sm:text-base shadow-lg">
                        ğŸŒ± å¼€å§‹å¿ƒçµå¯¹è¯
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 2: è™šæ‹Ÿæœ‹å‹é€‰æ‹©ä¸ç¾¤èŠåŒº -->
        <div id="chatSection" class="hidden">
            <!-- å½“å‰å‚ä¸è§’è‰²æ˜¾ç¤º -->
            <div class="bg-white/90 backdrop-blur-sm rounded-xl shadow-lg p-3 sm:p-4 mb-4 sm:mb-6">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-base sm:text-lg font-semibold text-gray-800">ğŸ¤— é™ªä¼´ä½ çš„è™šæ‹Ÿæœ‹å‹</h3>
                    <button onclick="showCharacterSelector()" class="bg-sanctuary-blue/20 hover:bg-sanctuary-blue/30 text-sanctuary-blue px-3 sm:px-4 py-2 rounded-lg text-xs sm:text-sm font-medium transition">
                        ğŸ‘¥ é€‰æ‹©æœ‹å‹
                    </button>
                </div>
                <div id="selectedCharactersDisplay" class="flex flex-wrap gap-2 sm:gap-3">
                    <div class="text-gray-500 text-sm">è¯·é€‰æ‹©è¦é™ªä¼´ä½ çš„è™šæ‹Ÿæœ‹å‹</div>
                </div>
            </div>

            <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
            <div class="bg-white/90 backdrop-blur-sm rounded-xl shadow-lg mb-4 sm:mb-6 h-[60vh] sm:h-[500px]">
                <div class="p-3 sm:p-4 border-b border-gray-200">
                    <h3 class="text-base sm:text-lg font-semibold text-gray-800">ğŸ’¬ å¿ƒçµå¯¹è¯ç©ºé—´</h3>
                    <div class="text-xs text-sanctuary-blue mt-1">è™šæ‹Ÿæœ‹å‹ä»¬åœ¨è¿™é‡Œé™ªä¼´ä½ ï¼Œä¸€èµ·æ¢è®¨å’Œç†è§£</div>
                </div>
                <div id="chatMessages" class="p-3 sm:p-4 h-[calc(60vh-80px)] sm:h-80 overflow-y-auto">
                    <div id="chatWelcomeMessage" class="text-center text-gray-500 text-sm py-8">
                        <div class="mb-4">
                            <div class="text-lg mb-2">ğŸŒ¸ å¿ƒçµå¯¹è¯å³å°†å¼€å§‹</div>
                            <div class="text-gray-400 mb-4">é€‰æ‹©è™šæ‹Ÿæœ‹å‹åï¼Œä»–ä»¬ä¼šé™ªä¼´ä½ ä¸€èµ·æ¢ç´¢å†…å¿ƒ~</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å¯¹è¯æ§åˆ¶åŒº -->
            <div class="bg-white/90 backdrop-blur-sm rounded-xl shadow-lg p-3 sm:p-4">
                <div class="text-center">
                    <div class="text-sanctuary-blue text-sm mb-3" id="statusText">
                        ğŸ’­ è™šæ‹Ÿæœ‹å‹ä»¬å‡†å¤‡ä¸ºä½ ç”Ÿæˆä¸€å¹…ç”»...
                    </div>
                    <div class="flex flex-wrap gap-2 justify-center">
                        <button id="restartButton" onclick="clearSanctuaryChat()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm transition hidden">
                            é‡æ–°å¼€å§‹
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 3 & 4: å›¾åƒç”Ÿæˆä¸å±•ç¤ºæ¨¡æ€æ¡† -->
    <div id="imageGenerationModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50 p-2 sm:p-4">
        <div class="bg-white rounded-xl p-4 sm:p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto animate-slide-up">
            <!-- ç”Ÿæˆä¸­çŠ¶æ€ -->
            <div id="generatingState" class="text-center py-8">
                <div class="text-6xl mb-4 animate-painting">ğŸ¨</div>
                <div class="text-xl font-semibold text-gray-800 mb-2">æ­£åœ¨ä¸ºä½ ç”»ç”»ä¸­...</div>
                <div class="text-sanctuary-blue text-sm mb-4">è™šæ‹Ÿæœ‹å‹ä»¬æ­£åœ¨ç”¨å¿ƒä¸ºä½ åˆ›ä½œ</div>
                <div class="w-full bg-gray-200 rounded-full h-2 mb-4">
                    <div id="progressBar" class="bg-gradient-to-r from-sanctuary-blue to-sanctuary-pink h-2 rounded-full transition-all duration-1000" style="width: 0%"></div>
                </div>
                <div id="generatingText" class="text-xs text-gray-500">åˆ†ææƒ…ç»ªå†…å®¹...</div>
            </div>

            <!-- ç”Ÿæˆå®ŒæˆçŠ¶æ€ -->
            <div id="generatedState" class="hidden">
                <div class="text-center mb-6">
                    <div class="text-xl font-semibold text-gray-800 mb-2">ğŸ è¿™æ˜¯æˆ‘ä»¬å…±åŒä¸ºä½ ç”»çš„</div>
                    <div class="text-sanctuary-blue text-sm" id="aiCollaborationText"></div>
                </div>
                
                <div class="bg-gradient-to-br from-sanctuary-cream to-sanctuary-soft rounded-xl p-4 mb-6">
                    <div id="generatedImageContainer" class="text-center mb-4">
                        <!-- ç”Ÿæˆçš„å›¾åƒå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                    
                    <div class="text-center mb-4">
                        <div class="text-lg font-semibold text-gray-800 mb-2">
                            ğŸ å›¾åï¼š<span id="imageTitle"></span>
                        </div>
                        <div class="text-xs text-gray-500 mb-3 hidden">
                            ğŸ¨ ç”»é¢æè¿°ï¼š<span id="imagePrompt"></span>
                        </div>
                    </div>
                    
                    <div class="space-y-3" id="aiMessages">
                        <!-- è™šæ‹Ÿæœ‹å‹èµ è¯­å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                </div>
                
                <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3">
                    <button onclick="saveToGallery()" class="flex-1 bg-sanctuary-blue hover:bg-sanctuary-blue/80 text-white px-4 py-2 rounded-lg transition text-sm sm:text-base">
                        ğŸ’¾ æ”¶è—åˆ°å›¾å†Œ
                    </button>
                    <button onclick="generateMemoryCard()" class="flex-1 bg-sanctuary-pink hover:bg-sanctuary-pink/80 text-white px-4 py-2 rounded-lg transition text-sm sm:text-base">
                        ğŸ“„ ç”Ÿæˆçºªå¿µå¡ç‰‡
                    </button>
                    <button onclick="closeImageModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg transition text-sm sm:text-base">
                        å…³é—­
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- è§’è‰²é€‰æ‹©æ¨¡æ€æ¡† -->
    <div id="characterSelectorModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50 p-2 sm:p-4">
        <div class="bg-white rounded-xl p-4 sm:p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg sm:text-xl font-bold mb-4">é€‰æ‹©é™ªä¼´ä½ çš„è™šæ‹Ÿæœ‹å‹</h3>
            <div id="charactersList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4 mb-6">
                <!-- è§’è‰²åˆ—è¡¨å°†åŠ¨æ€åŠ è½½ -->
            </div>
            <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3">
                <button onclick="hideCharacterSelector()" class="flex-1 bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg transition text-sm sm:text-base">
                    å–æ¶ˆ
                </button>
                <button onclick="confirmCharacterSelection()" class="flex-1 bg-sanctuary-blue hover:bg-sanctuary-blue/80 text-white px-4 py-2 rounded-lg transition text-sm sm:text-base">
                    ç¡®è®¤é€‰æ‹©
                </button>
            </div>
        </div>
    </div>

    <!-- æˆ‘çš„å¿ƒæƒ…å›¾å†Œæ¨¡æ€æ¡† -->
    <div id="galleryModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50 p-2 sm:p-4">
        <div class="bg-white rounded-xl p-4 sm:p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg sm:text-xl font-bold">ğŸ–¼ï¸ æˆ‘çš„å¿ƒæƒ…å›¾å†Œ</h3>
                <button onclick="hideGallery()" class="text-gray-500 hover:text-gray-700 text-xl">&times;</button>
            </div>
            <div id="galleryContent" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- å›¾å†Œå†…å®¹å°†åŠ¨æ€åŠ è½½ -->
            </div>
        </div>
    </div>

    <!-- å›¾ç‰‡è¯¦æƒ…æŸ¥çœ‹æ¨¡æ€æ¡† -->
    <div id="imageDetailModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-[60] p-2 sm:p-4">
        <div class="bg-white rounded-xl p-4 sm:p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg sm:text-xl font-bold">ğŸ¨ å¿ƒæƒ…ç”»ä½œè¯¦æƒ…</h3>
                <button onclick="hideImageDetail()" class="text-gray-500 hover:text-gray-700 text-xl">&times;</button>
            </div>
            <div id="imageDetailContent">
                <!-- å›¾ç‰‡è¯¦æƒ…å†…å®¹å°†åŠ¨æ€åŠ è½½ -->
            </div>
        </div>
    </div>

    <!-- åŠ è½½æç¤º -->
    <div id="loadingSpinner" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center z-40 hidden">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-sanctuary-blue mx-auto mb-4"></div>
            <p class="text-gray-600">è™šæ‹Ÿæœ‹å‹ä»¬æ­£åœ¨æ€è€ƒä¸­...</p>
        </div>
    </div>

    <script>
        let allCharacters = [];
        let selectedCharacterIds = [];
        let chatHistory = [];
        let currentEmotion = '';
        let userName = '';
        let isTyping = false;
        let sessionId = generateSessionId();
        let conversationRounds = 0;
        let maxRounds = 3; // åŠ¨æ€è®¡ç®—çš„å¯¹è¯è½®æ¬¡ï¼Œæ ¹æ®è™šæ‹Ÿæœ‹å‹æ•°é‡è°ƒæ•´

        // æ ¹æ®é€‰æ‹©çš„è™šæ‹Ÿæœ‹å‹æ•°é‡åŠ¨æ€è®¡ç®—å¯¹è¯è½®æ¬¡
        function calculateMaxRounds(characterCount) {
            if (characterCount <= 0) return 2;
            // 1ä¸ªè™šæ‹Ÿæœ‹å‹ï¼š6è½®ï¼Œ2ä¸ªè™šæ‹Ÿæœ‹å‹ï¼š5è½®ï¼Œ3ä¸ªè™šæ‹Ÿæœ‹å‹ï¼š4è½®ï¼Œä»¥æ­¤ç±»æ¨
            // ä½†æœ€å°‘ä¿è¯2è½®å¯¹è¯
            const rounds = Math.max(2, 7 - characterCount);
            return rounds;
        }
        let savedImages = []; // å°†ä»æœåŠ¡å™¨åŠ è½½

        // ç”Ÿæˆä¼šè¯ID
        function generateSessionId() {
            return 'sanctuary_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadCharacters();
            loadSelectedCharacters();
            loadSanctuaryGallery();
        });
        
        // ä»æœåŠ¡å™¨åŠ è½½å¿ƒæƒ…å›¾å†Œ
        async function loadSanctuaryGallery() {
            try {
                const response = await fetch('/api/sanctuary/gallery');
                if (response.ok) {
                    const data = await response.json();
                    savedImages = data.images || [];
                } else {
                    console.error('åŠ è½½å¿ƒæƒ…å›¾å†Œå¤±è´¥:', response.status);
                    savedImages = [];
                }
            } catch (error) {
                console.error('åŠ è½½å¿ƒæƒ…å›¾å†Œå‡ºé”™:', error);
                savedImages = [];
            }
        }

        // è®¾ç½®ç¤ºä¾‹æ–‡æœ¬
        function setExampleText(text) {
            document.getElementById('emotionInput').value = text;
        }

        // å¤„ç†ç”¨æˆ·åè¾“å…¥å›è½¦é”®
        function handleNameKeyPress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                document.getElementById('emotionInput').focus();
            }
        }

        // å¤„ç†æƒ…ç»ªè¾“å…¥å›è½¦é”®
        function handleEmotionKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                startSanctuarySession();
            }
        }

        // å¼€å§‹å¿ƒçµå¯¹è¯ä¼šè¯
        function startSanctuarySession() {
            const emotionText = document.getElementById('emotionInput').value.trim();
            const userNameText = document.getElementById('userNameInput').value.trim();
            
            if (!emotionText) {
                showNotification('è¯·å…ˆåˆ†äº«ä½ çš„å¿ƒå£°', 'error');
                return;
            }
            
            currentEmotion = emotionText;
            userName = userNameText || 'æœ‹å‹'; // å¦‚æœæ²¡æœ‰è¾“å…¥åå­—ï¼Œé»˜è®¤ç§°å‘¼ä¸º"æœ‹å‹"
            
            // éšè—è¾“å…¥åŒºï¼Œæ˜¾ç¤ºèŠå¤©åŒº
            document.getElementById('emotionInputSection').classList.add('hidden');
            document.getElementById('chatSection').classList.remove('hidden');
            
            // å¦‚æœæ²¡æœ‰é€‰æ‹©è§’è‰²ï¼Œè‡ªåŠ¨æ˜¾ç¤ºè§’è‰²é€‰æ‹©å™¨
            if (selectedCharacterIds.length === 0) {
                showCharacterSelector();
            } else {
                // å¼€å§‹å¯¹è¯
                initializeSanctuaryChat();
            }
        }

        // åˆå§‹åŒ–å¿ƒçµå¯¹è¯
        function initializeSanctuaryChat() {
            // æ¸…ç©ºèŠå¤©è®°å½•
            chatHistory = [];
            conversationRounds = 0;
            
            // ç¡®ä¿å¯¹è¯è½®æ¬¡æ ¹æ®å½“å‰é€‰æ‹©çš„è™šæ‹Ÿæœ‹å‹æ•°é‡æ­£ç¡®è®¾ç½®
            maxRounds = calculateMaxRounds(selectedCharacterIds.length);
            
            // æ·»åŠ ç”¨æˆ·çš„åˆå§‹æƒ…ç»ªè¡¨è¾¾
            addMessageToChat('ä½ ', currentEmotion, 'user');
            
            // å¼€å§‹è™šæ‹Ÿæœ‹å‹å›å¤
            setTimeout(() => {
                startVirtualFriendsDiscussion();
            }, 1000);
        }
        
        // ç»§ç»­è®¨è®ºåŠŸèƒ½
        function continueDiscussion() {
            if (isTyping) {
                showNotification('è™šæ‹Ÿæœ‹å‹ä»¬è¿˜åœ¨æ€è€ƒä¸­ï¼Œè¯·ç¨ç­‰...', 'info');
                return;
            }
            
            if (conversationRounds >= maxRounds) {
                showNotification('è®¨è®ºå·²ç»å¾ˆæ·±å…¥äº†ï¼Œè®©æˆ‘ä»¬ç”Ÿæˆä¸€å¹…ç”»æ¥æ€»ç»“å§', 'info');
                setTimeout(() => {
                    showImageGenerationPrompt();
                }, 1000);
                return;
            }
            
            startAIDiscussion();
        }

        // å¼€å§‹è™šæ‹Ÿæœ‹å‹è®¨è®º - æµå¼è¿”å›
        async function startVirtualFriendsDiscussion() {
            if (selectedCharacterIds.length === 0) {
                showNotification('è¯·å…ˆé€‰æ‹©è™šæ‹Ÿæœ‹å‹', 'error');
                return;
            }
            
            isTyping = true;
            
            try {
                // é€ä¸ªè§’è‰²è¿›è¡Œå¯¹è¯ï¼Œå®ç°æµå¼æ•ˆæœ
                for (let i = 0; i < selectedCharacterIds.length; i++) {
                    const characterId = selectedCharacterIds[i];
                    const character = allCharacters.find(c => c.id === characterId);
                    
                    if (!character) continue;
                    
                    // æ˜¾ç¤ºå½“å‰è§’è‰²çš„è¾“å…¥æŒ‡ç¤ºå™¨
                    showSingleTypingIndicator(characterId);
                    
                    try {
                        const response = await fetch('/api/sanctuary/discuss', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                character_ids: [characterId], // å•ä¸ªè§’è‰²
                                emotion: currentEmotion,
                                chat_history: chatHistory,
                                session_id: sessionId,
                                round: conversationRounds,
                                user_name: userName
                            })
                        });
                        
                        const result = await response.json();
                        
                        // ç§»é™¤å½“å‰è§’è‰²çš„è¾“å…¥æŒ‡ç¤ºå™¨
                        removeSingleTypingIndicator(characterId);
                        
                        // æ£€æŸ¥æ˜¯å¦æœ‰å®‰å…¨è­¦å‘Š
                        if (result.security_warning) {
                            showNotification(result.message || 'æ£€æµ‹åˆ°ä¸å®‰å…¨çš„è¾“å…¥å†…å®¹ï¼Œè¯·é‡æ–°è¾“å…¥', 'error');
                            // é‡ç½®åˆ°æƒ…ç»ªè¾“å…¥é˜¶æ®µ
                            clearSanctuaryChat();
                            return;
                        }
                        
                        if (result.responses && result.responses.length > 0) {
                            const characterResponse = result.responses[0];
                            
                            // ç«‹å³æ˜¾ç¤ºAIå“åº”ï¼Œé¿å…ç©ºç™½æœŸ
                            addMessageToChat(
                                characterResponse.character_name,
                                characterResponse.message,
                                'character',
                                characterResponse.character_id
                            );
                        } else if (result.error) {
                            showNotification(result.error, 'error');
                        }
                    } catch (error) {
                        console.error(`è§’è‰² ${character.name} å›å¤å¤±è´¥:`, error);
                        removeSingleTypingIndicator(characterId);
                        // ç»§ç»­ä¸‹ä¸€ä¸ªè§’è‰²ï¼Œä¸ä¸­æ–­æ•´ä¸ªæµç¨‹
                    }
                    
                    // è§’è‰²é—´çš„é—´éš”
                    if (i < selectedCharacterIds.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 2000));
                    }
                }
                
                conversationRounds++;
                
                // æ£€æŸ¥æ˜¯å¦åº”è¯¥è§¦å‘å›¾åƒç”Ÿæˆ
                if (conversationRounds >= maxRounds) {
                    setTimeout(() => {
                        showImageGenerationPrompt();
                    }, 2000);
                } else {
                    // è‡ªåŠ¨ç»§ç»­ä¸‹ä¸€è½®è®¨è®º
                    setTimeout(() => {
                        startVirtualFriendsDiscussion();
                    }, 2000 + Math.random() * 3000); // 2-5ç§’åè‡ªåŠ¨ç»§ç»­ï¼Œè®©è®¨è®ºæ›´æµç•…
                }
            } catch (error) {
                console.error('è™šæ‹Ÿæœ‹å‹è®¨è®ºå¤±è´¥:', error);
                showNotification('è¿æ¥å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            } finally {
                isTyping = false;
            }
        }

        // æ˜¾ç¤ºå›¾åƒç”Ÿæˆæç¤º
        function showImageGenerationPrompt() {
            const characterNames = selectedCharacterIds.map(id => {
                const character = allCharacters.find(c => c.id === id);
                return character ? character.name : 'è™šæ‹Ÿæœ‹å‹';
            }).join('ã€');
            
            const userDisplayName = userName || 'æœ‹å‹';
            const promptMessage = `ğŸ¨ ${characterNames}åä¸‹æ¥è®¤çœŸè®¨è®ºäº†${userDisplayName}çš„è¯ï¼Œä»–ä»¬è¯´ï¼šå¦‚æœèƒ½æŠŠè¿™ç§æ„Ÿè§‰å˜æˆä¸€å¹…ç”»ï¼Œé‚£ä¹Ÿè®¸${userDisplayName}ä¼šæ„Ÿè§‰è½»ä¸€ç‚¹â€¦ æ‰€ä»¥â€”â€”è¿™æ˜¯æˆ‘ä»¬å…±åŒä¸º${userDisplayName}ç”»çš„ã€‚`;
            
            addMessageToChat('ç³»ç»Ÿ', promptMessage, 'system');
            
            // è‡ªåŠ¨è§¦å‘å›¾åƒç”Ÿæˆ
            setTimeout(() => {
                triggerImageGeneration();
            }, 2000);
        }

        // è§¦å‘å›¾åƒç”Ÿæˆ
        function triggerImageGeneration() {
            document.getElementById('imageGenerationModal').classList.remove('hidden');
            document.getElementById('imageGenerationModal').classList.add('flex');
            
            generateHealingImage();
        }

        // ç”Ÿæˆæ²»æ„ˆå›¾åƒ
        async function generateHealingImage() {
            const progressBar = document.getElementById('progressBar');
            const generatingText = document.getElementById('generatingText');
            
            const characterNames = selectedCharacterIds.map(id => {
                const character = allCharacters.find(c => c.id === id);
                return character ? character.name : 'è™šæ‹Ÿæœ‹å‹';
            }).join('ã€');
            
            const userDisplayName = userName || 'æœ‹å‹';
            const steps = [
                { progress: 20, text: `ğŸ ${characterNames}æ­£åœ¨ä¸º${userDisplayName}ç”»ç”»ä¸­...` },
                { progress: 40, text: `ğŸ’­ ç†è§£${userDisplayName}çš„å†…å¿ƒæ„Ÿå—...` },
                { progress: 60, text: 'ğŸ¨ æ„æ€æ²»æ„ˆçš„ç”»é¢...' },
                { progress: 80, text: 'âœ¨ ç”¨å¿ƒç»˜åˆ¶æ¯ä¸€ç¬”...' },
                { progress: 100, text: `ğŸŒ¸ å®Œæˆäº†ä¸“å±äº${userDisplayName}çš„ç”»ä½œ...` }
            ];
            
            // æ¨¡æ‹Ÿè¿›åº¦
            for (let step of steps) {
                await new Promise(resolve => setTimeout(resolve, 1000));
                progressBar.style.width = step.progress + '%';
                generatingText.textContent = step.text;
            }
            
            try {
                const response = await fetch('/api/sanctuary/generate-image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        emotion: currentEmotion,
                        chat_history: chatHistory,
                        character_ids: selectedCharacterIds,
                        session_id: sessionId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    displayGeneratedImage(result);
                } else {
                    showNotification('å›¾åƒç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                    closeImageModal();
                }
            } catch (error) {
                console.error('å›¾åƒç”Ÿæˆå¤±è´¥:', error);
                showNotification('ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                closeImageModal();
            }
        }

        // æ˜¾ç¤ºç”Ÿæˆçš„å›¾åƒ
        function displayGeneratedImage(result) {
            document.getElementById('generatingState').classList.add('hidden');
            document.getElementById('generatedState').classList.remove('hidden');
            
            // æ›´æ–°çŠ¶æ€æ–‡å­—
            document.getElementById('statusText').textContent = 'ğŸ¨ è™šæ‹Ÿæœ‹å‹ä»¬å·²ç»ä¸ºä½ åšäº†ä¸€å¹…ç”»';
            
            // æ˜¾ç¤ºé‡æ–°å¼€å§‹æŒ‰é’®
            document.getElementById('restartButton').classList.remove('hidden');
            
            // è®¾ç½®åä½œæ–‡æœ¬
            const characterNames = selectedCharacterIds.map(id => {
                const character = allCharacters.find(c => c.id === id);
                return character ? character.name : 'è™šæ‹Ÿæœ‹å‹';
            }).join('ã€');
            
            document.getElementById('aiCollaborationText').textContent = 
                `${characterNames}ç”¨å¿ƒä¸ºä½ åˆ›ä½œäº†è¿™å¹…ç”»`;
            
            // æ˜¾ç¤ºå›¾åƒ
            const imageContainer = document.getElementById('generatedImageContainer');
            imageContainer.innerHTML = `
                <img src="${result.image_url}" alt="${result.title}" 
                     class="max-w-full h-auto rounded-lg shadow-lg mx-auto animate-fade-in" 
                     style="max-height: 300px;">
            `;
            
            // è®¾ç½®æ ‡é¢˜å’Œæç¤ºè¯
            document.getElementById('imageTitle').textContent = result.title;
            document.getElementById('imagePrompt').textContent = result.prompt;
            
            // æ˜¾ç¤ºè™šæ‹Ÿæœ‹å‹èµ è¯­
            const aiMessagesContainer = document.getElementById('aiMessages');
            aiMessagesContainer.innerHTML = '<div class="text-sm font-medium text-sanctuary-blue mb-3">ğŸ—¨ï¸ è™šæ‹Ÿæœ‹å‹èµ è¯­ï¼š</div>';
            
            if (result.ai_messages) {
                result.ai_messages.forEach(msg => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'bg-white/50 rounded-lg p-3 text-sm mb-2';
                    messageDiv.innerHTML = `
                        <div class="font-medium text-sanctuary-blue mb-1">- ${msg.character_name}ï¼š</div>
                        <div class="text-gray-700 italic pl-2">"${msg.message}"</div>
                    `;
                    aiMessagesContainer.appendChild(messageDiv);
                });
            }
            
            // ä¿å­˜åˆ°å½“å‰ä¼šè¯
            window.currentGeneratedImage = result;
        }

        // ä¿å­˜åˆ°å›¾å†Œï¼ˆå›¾åƒå·²åœ¨ç”Ÿæˆæ—¶è‡ªåŠ¨ä¿å­˜åˆ°æ•°æ®åº“ï¼‰
        function saveToGallery() {
            if (window.currentGeneratedImage) {
                // é‡æ–°åŠ è½½å›¾å†Œä»¥æ˜¾ç¤ºæœ€æ–°ä¿å­˜çš„å›¾åƒ
                loadSanctuaryGallery().then(() => {
                    showNotification('å·²ä¿å­˜åˆ°å¿ƒæƒ…å›¾å†Œ', 'success');
                });
            }
        }

        // ç”Ÿæˆçºªå¿µå¡ç‰‡
        function generateMemoryCard() {
            if (window.currentGeneratedImage) {
                const cardData = {
                    image: window.currentGeneratedImage,
                    originalEmotion: currentEmotion,
                    aiMessages: window.currentGeneratedImage.ai_messages,
                    createdAt: new Date().toLocaleString('zh-CN')
                };
                
                // åˆ›å»ºçºªå¿µå¡ç‰‡HTML
                const cardHtml = `
                    <div class="bg-white p-6 rounded-xl shadow-lg max-w-md mx-auto">
                        <div class="text-center mb-4">
                            <h3 class="text-lg font-bold text-gray-800 mb-2">ğŸ’ å¿ƒçµçºªå¿µå¡ç‰‡</h3>
                            <div class="text-xs text-gray-500">${cardData.createdAt}</div>
                        </div>
                        
                        <div class="mb-4">
                            <img src="${cardData.image.image_url}" alt="${cardData.image.title}" class="w-full h-40 object-cover rounded-lg">
                        </div>
                        
                        <div class="mb-4">
                             <div class="text-sm font-medium text-blue-600 mb-2">ğŸŒ¸ åŸå§‹å¿ƒå£°ï¼š</div>
                             <div class="text-xs text-gray-600 bg-gray-50 p-2 rounded italic">"${cardData.originalEmotion}"</div>
                         </div>
                         
                         <div class="mb-4">
                             <div class="text-sm font-medium text-blue-600 mb-2">ğŸ å›¾åï¼š${cardData.image.title}</div>
                         </div>
                         
                         <div>
                             <div class="text-sm font-medium text-blue-600 mb-2">ğŸ’Œ è™šæ‹Ÿæœ‹å‹èµ è¯­ï¼š</div>
                            ${cardData.aiMessages ? cardData.aiMessages.map(msg => 
                                `<div class="text-xs text-gray-600 mb-1">- ${msg.character_name}ï¼š'${msg.message}'</div>`
                            ).join('') : ''}
                        </div>
                    </div>
                `;
                
                // åˆ›å»ºæ–°çª—å£æ˜¾ç¤ºçºªå¿µå¡ç‰‡
                const newWindow = window.open('', '_blank', 'width=400,height=600');
                newWindow.document.write(`
                    <html>
                        <head>
                            <title>å¿ƒçµçºªå¿µå¡ç‰‡</title>
                            <script src="https://cdn.tailwindcss.com"><\/script>
                        </head>
                        <body class="bg-gray-100 p-4">
                            ${cardHtml}
                            <div class="text-center mt-4">
                                 <button onclick="window.print()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm transition">ğŸ–¨ï¸ æ‰“å°ä¿å­˜</button>
                             </div>
                        </body>
                    </html>
                `);
                newWindow.document.close();
                
                showNotification('çºªå¿µå¡ç‰‡å·²ç”Ÿæˆ', 'success');
            }
        }

        // å…³é—­å›¾åƒæ¨¡æ€æ¡†
        function closeImageModal() {
            document.getElementById('imageGenerationModal').classList.add('hidden');
            document.getElementById('imageGenerationModal').classList.remove('flex');
            
            // é‡ç½®çŠ¶æ€
            document.getElementById('generatingState').classList.remove('hidden');
            document.getElementById('generatedState').classList.add('hidden');
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('generatingText').textContent = 'åˆ†ææƒ…ç»ªå†…å®¹...';
        }

        // æ˜¾ç¤ºæˆ‘çš„å›¾å†Œ
        function showMyGallery() {
            const galleryContent = document.getElementById('galleryContent');
            galleryContent.innerHTML = '';
            
            if (savedImages.length === 0) {
                galleryContent.innerHTML = `
                    <div class="col-span-full text-center py-8 text-gray-500">
                        <div class="text-4xl mb-2">ğŸ–¼ï¸</div>
                        <div>è¿˜æ²¡æœ‰ä¿å­˜çš„å¿ƒæƒ…ç”»ä½œ</div>
                        <div class="text-sm mt-2">å¼€å§‹ä¸€æ¬¡å¿ƒçµå¯¹è¯ï¼Œåˆ›ä½œä½ çš„ç¬¬ä¸€å¹…ç”»å§</div>
                    </div>
                `;
            } else {
                savedImages.forEach((image, index) => {
                    const imageCard = document.createElement('div');
                    imageCard.className = 'bg-white rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition cursor-pointer';
                    imageCard.onclick = () => showImageDetail(image);
                    imageCard.innerHTML = `
                        <img src="${image.image_url}" alt="${image.title}" class="w-full h-40 object-cover">
                        <div class="p-3">
                            <div class="font-semibold text-sm mb-1">${image.title}</div>
                            <div class="text-xs text-gray-500 mb-2">${new Date(image.created_at).toLocaleDateString()}</div>
                            <div class="text-xs text-gray-600 line-clamp-2">${image.original_emotion}</div>
                            <div class="text-xs text-sanctuary-blue mt-2">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</div>
                        </div>
                    `;
                    galleryContent.appendChild(imageCard);
                });
            }
            
            document.getElementById('galleryModal').classList.remove('hidden');
            document.getElementById('galleryModal').classList.add('flex');
        }

        // éšè—å›¾å†Œ
        function hideGallery() {
            document.getElementById('galleryModal').classList.add('hidden');
            document.getElementById('galleryModal').classList.remove('flex');
        }

        // æ˜¾ç¤ºå›¾ç‰‡è¯¦æƒ…
        function showImageDetail(image) {
            const detailContent = document.getElementById('imageDetailContent');
            
            detailContent.innerHTML = `
                <div class="text-center mb-6">
                    <img src="${image.image_url}" alt="${image.title}" class="w-full max-h-80 object-contain rounded-lg shadow-lg mx-auto">
                </div>
                
                <div class="space-y-4">
                    <div>
                        <h4 class="text-lg font-semibold text-gray-800 mb-2">ğŸ¨ ${image.title}</h4>
                        <div class="text-sm text-gray-500">${new Date(image.created_at).toLocaleString('zh-CN')}</div>
                    </div>
                    
                    <div>
                        <div class="text-sm font-medium text-sanctuary-blue mb-2">ğŸŒ¸ åŸå§‹å¿ƒå£°ï¼š</div>
                        <div class="text-sm text-gray-700 bg-sanctuary-cream/50 p-3 rounded-lg italic">"${image.original_emotion}"</div>
                    </div>
                    
                    ${image.ai_messages ? `
                        <div>
                            <div class="text-sm font-medium text-sanctuary-blue mb-2">ğŸ’Œ è™šæ‹Ÿæœ‹å‹èµ è¯­ï¼š</div>
                            <div class="space-y-2">
                                ${image.ai_messages.map(msg => `
                                    <div class="bg-white/80 rounded-lg p-3 text-sm">
                                        <div class="font-medium text-sanctuary-blue mb-1">- ${msg.character_name}ï¼š</div>
                                        <div class="text-gray-700 italic pl-2">"${msg.message}"</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
                
                <div class="flex flex-col space-y-3 mt-6">
                    <button onclick="backToGallery()" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg transition text-sm border">
                        â†©ï¸ è¿”å›å¿ƒæƒ…å›¾å†Œ
                    </button>
                    <button onclick="generateMemoryCardFromImage('${image.id}')" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition text-sm font-medium">
                        ğŸ“„ ç”Ÿæˆçºªå¿µå¡ç‰‡
                    </button>
                    <button onclick="deleteImageFromGallery(${image.id})" class="w-full bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition text-sm">
                        ğŸ—‘ï¸ åˆ é™¤è¿™å¹…ç”»
                    </button>
                    <button onclick="hideImageDetail()" class="w-full bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition text-sm">
                        å…³é—­
                    </button>
                </div>
            `;
            
            // å…ˆå…³é—­å›¾å†Œå¼¹çª—
            hideGallery();
            
            // æ˜¾ç¤ºè¯¦æƒ…å¼¹çª—
            document.getElementById('imageDetailModal').classList.remove('hidden');
            document.getElementById('imageDetailModal').classList.add('flex');
        }

        // éšè—å›¾ç‰‡è¯¦æƒ…
        function hideImageDetail() {
            document.getElementById('imageDetailModal').classList.add('hidden');
            document.getElementById('imageDetailModal').classList.remove('flex');
        }
        
        // ä»å›¾å†Œåˆ é™¤å›¾åƒ
        async function deleteImageFromGallery(imageId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™å¹…å¿ƒæƒ…ç”»ä½œå—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/sanctuary/gallery/${imageId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showNotification('ç”»ä½œå·²åˆ é™¤', 'success');
                    hideImageDetail();
                    // é‡æ–°åŠ è½½å›¾å†Œ
                    await loadSanctuaryGallery();
                    showMyGallery();
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤å›¾åƒå‡ºé”™:', error);
                showNotification('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }
        
        // è¿”å›å›¾å†Œ
        function backToGallery() {
            hideImageDetail();
            showMyGallery();
        }

        // è¿”å›å¿ƒæƒ…å›¾å†Œ
        function backToGallery() {
            hideImageDetail();
            showMyGallery();
        }

        // ä»å›¾å†Œå›¾ç‰‡ç”Ÿæˆçºªå¿µå¡ç‰‡
        function generateMemoryCardFromImage(imageId) {
            const image = savedImages.find(img => img.id == imageId);
            if (image) {
                const cardData = {
                    image: image,
                    originalEmotion: image.original_emotion,
                    aiMessages: image.ai_messages,
                    createdAt: new Date(image.created_at).toLocaleString('zh-CN')
                };
                
                // åˆ›å»ºçºªå¿µå¡ç‰‡HTML
                const cardHtml = `
                    <div class="bg-white p-6 rounded-xl shadow-lg max-w-md mx-auto">
                        <div class="text-center mb-4">
                            <h3 class="text-lg font-bold text-gray-800 mb-2">ğŸ’ å¿ƒçµçºªå¿µå¡ç‰‡</h3>
                            <div class="text-xs text-gray-500">${cardData.createdAt}</div>
                        </div>
                        
                        <div class="mb-4">
                            <img src="${cardData.image.image_url}" alt="${cardData.image.title}" class="w-full h-40 object-cover rounded-lg">
                        </div>
                        
                        <div class="mb-4">
                             <div class="text-sm font-medium text-blue-600 mb-2">ğŸŒ¸ åŸå§‹å¿ƒå£°ï¼š</div>
                             <div class="text-xs text-gray-600 bg-gray-50 p-2 rounded italic">"${cardData.originalEmotion}"</div>
                         </div>
                         
                         <div class="mb-4">
                             <div class="text-sm font-medium text-blue-600 mb-2">ğŸ å›¾åï¼š${cardData.image.title}</div>
                         </div>
                         
                         <div>
                             <div class="text-sm font-medium text-blue-600 mb-2">ğŸ’Œ è™šæ‹Ÿæœ‹å‹èµ è¯­ï¼š</div>
                            ${cardData.aiMessages ? cardData.aiMessages.map(msg => 
                                `<div class="text-xs text-gray-600 mb-1">- ${msg.character_name}ï¼š'${msg.message}'</div>`
                            ).join('') : ''}
                        </div>
                    </div>
                `;
                
                // åˆ›å»ºæ–°çª—å£æ˜¾ç¤ºçºªå¿µå¡ç‰‡
                const newWindow = window.open('', '_blank', 'width=400,height=600');
                newWindow.document.write(`
                    <html>
                        <head>
                            <title>å¿ƒçµçºªå¿µå¡ç‰‡</title>
                            <script src="https://cdn.tailwindcss.com"><\/script>
                        </head>
                        <body class="bg-gray-100 p-4">
                            ${cardHtml}
                            <div class="text-center mt-4">
                                 <button onclick="window.print()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm transition">ğŸ–¨ï¸ æ‰“å°ä¿å­˜</button>
                             </div>
                        </body>
                    </html>
                `);
                newWindow.document.close();
                
                showNotification('çºªå¿µå¡ç‰‡å·²ç”Ÿæˆ', 'success');
            }
        }

        // æ¸…ç©ºèŠå¤©å¹¶é‡æ–°å¼€å§‹
        function clearSanctuaryChat() {
            chatHistory = [];
            conversationRounds = 0;
            currentEmotion = '';
            sessionId = generateSessionId();
            
            // æ¸…ç©ºå·²é€‰æ‹©çš„è™šæ‹Ÿæœ‹å‹ï¼Œå¼ºåˆ¶é‡æ–°é€‰æ‹©
            selectedCharacterIds = [];
            sessionStorage.removeItem('sanctuarySelectedCharacters');
            updateSelectedCharactersDisplay();
            
            document.getElementById('chatSection').classList.add('hidden');
            document.getElementById('emotionInputSection').classList.remove('hidden');
            document.getElementById('emotionInput').value = '';
            document.getElementById('chatMessages').innerHTML = `
                <div id="chatWelcomeMessage" class="text-center text-gray-500 text-sm py-8">
                    <div class="mb-4">
                        <div class="text-lg mb-2">ğŸŒ¸ å¿ƒçµå¯¹è¯å³å°†å¼€å§‹</div>
                        <div class="text-gray-400 mb-4">é€‰æ‹©è™šæ‹Ÿæœ‹å‹åï¼Œä»–ä»¬ä¼šé™ªä¼´ä½ ä¸€èµ·æ¢ç´¢å†…å¿ƒ~</div>
                    </div>
                </div>
            `;
            document.getElementById('generateImageBtn').classList.add('hidden');
            
            // éšè—é‡æ–°å¼€å§‹æŒ‰é’®
            document.getElementById('restartButton').classList.add('hidden');
            
            // é‡ç½®çŠ¶æ€æ–‡å­—
            document.getElementById('statusText').textContent = 'ğŸ’­ è™šæ‹Ÿæœ‹å‹ä»¬å‡†å¤‡ä¸ºä½ ç”Ÿæˆä¸€å¹…ç”»...';
            
            // å…³é—­å›¾åƒæ¨¡æ€æ¡†
            closeImageModal();
        }

        // èŠå¤©è¾“å…¥åŠŸèƒ½å·²ç§»é™¤ï¼Œæ”¹ä¸ºå®Œå…¨è‡ªåŠ¨çš„è™šæ‹Ÿæœ‹å‹è®¨è®ºæ¨¡å¼

        // ä»¥ä¸‹æ˜¯ä»åŸchat.htmlå¤ç”¨çš„å‡½æ•°ï¼Œéœ€è¦é€‚é…sanctuaryä¸»é¢˜
        
        // åŠ è½½æ‰€æœ‰è§’è‰²
        async function loadCharacters() {
            try {
                const response = await fetch('/api/characters');
                allCharacters = await response.json();
            } catch (error) {
                console.error('åŠ è½½è§’è‰²å¤±è´¥:', error);
                showNotification('åŠ è½½è§’è‰²å¤±è´¥', 'error');
            }
        }

        // ä»sessionStorageåŠ è½½å·²é€‰æ‹©çš„è§’è‰²
        function loadSelectedCharacters() {
            const stored = sessionStorage.getItem('sanctuarySelectedCharacters');
            if (stored) {
                selectedCharacterIds = JSON.parse(stored);
                // æ ¹æ®æ¢å¤çš„è§’è‰²æ•°é‡æ›´æ–°å¯¹è¯è½®æ¬¡
                maxRounds = calculateMaxRounds(selectedCharacterIds.length);
                updateSelectedCharactersDisplay();
            }
        }

        // æ˜¾ç¤ºè§’è‰²é€‰æ‹©å™¨
        async function showCharacterSelector() {
            if (allCharacters.length === 0) {
                await loadCharacters();
            }
            
            const charactersList = document.getElementById('charactersList');
            charactersList.innerHTML = '';
            
            allCharacters.forEach(character => {
                const characterCard = createCharacterSelectorCard(character);
                charactersList.appendChild(characterCard);
            });
            
            document.getElementById('characterSelectorModal').classList.remove('hidden');
            document.getElementById('characterSelectorModal').classList.add('flex');
        }

        // ç”Ÿæˆå¤´åƒHTML
        function generateAvatarHtml(character, sizeClass = 'w-16 h-16') {
            const avatarType = character.avatar_type || 'initial';
            const avatarValue = character.avatar_value;
            const textSize = sizeClass.includes('w-12') ? 'text-xl' : sizeClass.includes('w-8') ? 'text-sm' : sizeClass.includes('w-6') ? 'text-xs' : 'text-base';
            const emojiSize = sizeClass.includes('w-12') ? 'text-xl' : sizeClass.includes('w-8') ? 'text-lg' : sizeClass.includes('w-6') ? 'text-sm' : 'text-2xl';
            const marginClass = sizeClass.includes('w-6') ? 'mb-0' : 'mb-2';
            
            if (avatarType === 'emoji' && avatarValue) {
                return `<div class="${sizeClass} bg-gray-100 rounded-full flex items-center justify-center mx-auto ${marginClass} ${emojiSize}">${avatarValue}</div>`;
            } else if (avatarType === 'upload' && avatarValue) {
                return `<div class="${sizeClass} rounded-full mx-auto ${marginClass} overflow-hidden"><img src="${avatarValue}" alt="${character.name}" class="w-full h-full object-cover"></div>`;
            } else {
                // é»˜è®¤ä½¿ç”¨é¦–å­—æ¯å¤´åƒï¼ˆç»Ÿä¸€ä½¿ç”¨ç´«è‰²èƒŒæ™¯ï¼‰
                return `<div class="${sizeClass} bg-indigo-400 rounded-full flex items-center justify-center mx-auto ${marginClass} text-white ${textSize} font-bold">${character.name.charAt(0)}</div>`;
            }
        }

        // åˆ›å»ºè§’è‰²é€‰æ‹©å¡ç‰‡
        function createCharacterSelectorCard(character) {
            const isSelected = selectedCharacterIds.includes(character.id);
            const card = document.createElement('div');
            card.className = `border-2 rounded-lg p-4 cursor-pointer transition ${
                isSelected ? 'border-sanctuary-blue bg-sanctuary-blue/10' : 'border-gray-200 hover:border-sanctuary-blue/50'
            }`;
            
            const avatarHtml = generateAvatarHtml(character, 'w-12 h-12');
            
            card.innerHTML = `
                <div class="text-center">
                    ${avatarHtml}
                    <h4 class="font-semibold text-gray-800 whitespace-nowrap overflow-hidden text-ellipsis" title="${character.name}">${character.name}</h4>
                    <p class="text-sm text-sanctuary-blue mb-1 whitespace-nowrap overflow-hidden text-ellipsis" title="${character.personality}">${character.personality}</p>
                    <p class="text-xs text-gray-600 whitespace-nowrap overflow-hidden text-ellipsis" title="${character.description}">${character.description}</p>
                    ${isSelected ? '<div class="mt-2 text-sanctuary-blue text-sm">âœ“ å·²é€‰æ‹©</div>' : ''}
                </div>
            `;
            
            card.onclick = () => toggleCharacterSelection(character.id, card);
            return card;
        }

        // åˆ‡æ¢è§’è‰²é€‰æ‹©çŠ¶æ€
        function toggleCharacterSelection(characterId, cardElement) {
            const isSelected = selectedCharacterIds.includes(characterId);
            
            if (isSelected) {
                selectedCharacterIds = selectedCharacterIds.filter(id => id !== characterId);
                cardElement.className = 'border-2 rounded-lg p-4 cursor-pointer transition border-gray-200 hover:border-sanctuary-blue/50';
                cardElement.querySelector('.mt-2')?.remove();
            } else {
                selectedCharacterIds.push(characterId);
                cardElement.className = 'border-2 rounded-lg p-4 cursor-pointer transition border-sanctuary-blue bg-sanctuary-blue/10';
                const selectedDiv = document.createElement('div');
                selectedDiv.className = 'mt-2 text-sanctuary-blue text-sm';
                selectedDiv.textContent = 'âœ“ å·²é€‰æ‹©';
                cardElement.querySelector('.text-center').appendChild(selectedDiv);
            }
        }

        // ç¡®è®¤è§’è‰²é€‰æ‹©
        function confirmCharacterSelection() {
            if (selectedCharacterIds.length === 0) {
                showNotification('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè™šæ‹Ÿæœ‹å‹', 'error');
                return;
            }
            
            // æ ¹æ®é€‰æ‹©çš„è™šæ‹Ÿæœ‹å‹æ•°é‡åŠ¨æ€æ›´æ–°å¯¹è¯è½®æ¬¡
            maxRounds = calculateMaxRounds(selectedCharacterIds.length);
            console.log(`é€‰æ‹©äº†${selectedCharacterIds.length}ä¸ªè™šæ‹Ÿæœ‹å‹ï¼Œè®¾ç½®å¯¹è¯è½®æ¬¡ä¸º${maxRounds}è½®`);
            
            sessionStorage.setItem('sanctuarySelectedCharacters', JSON.stringify(selectedCharacterIds));
            updateSelectedCharactersDisplay();
            hideCharacterSelector();
            
            // å¦‚æœæ˜¯åœ¨æƒ…ç»ªè¾“å…¥åé€‰æ‹©è§’è‰²ï¼Œè‡ªåŠ¨å¼€å§‹å¯¹è¯
            if (currentEmotion) {
                initializeSanctuaryChat();
            }
        }

        // éšè—è§’è‰²é€‰æ‹©å™¨
        function hideCharacterSelector() {
            document.getElementById('characterSelectorModal').classList.add('hidden');
            document.getElementById('characterSelectorModal').classList.remove('flex');
        }

        // æ›´æ–°å·²é€‰æ‹©è§’è‰²æ˜¾ç¤º
        function updateSelectedCharactersDisplay() {
            const display = document.getElementById('selectedCharactersDisplay');
            
            if (selectedCharacterIds.length === 0) {
                display.innerHTML = '<div class="text-gray-500 text-sm">è¯·é€‰æ‹©è¦é™ªä¼´ä½ çš„è™šæ‹Ÿæœ‹å‹</div>';
                return;
            }
            
            display.innerHTML = '';
            selectedCharacterIds.forEach(id => {
                const character = allCharacters.find(c => c.id === id);
                if (character) {
                    const characterChip = document.createElement('div');
                    characterChip.className = 'flex items-center space-x-2 bg-sanctuary-blue/20 text-sanctuary-blue px-3 py-1 rounded-full text-sm';
                    
                    const avatarHtml = generateAvatarHtml(character, 'w-6 h-6').replace('mb-2', 'mb-0');
                    
                    characterChip.innerHTML = `
                        ${avatarHtml}
                        <span class="whitespace-nowrap overflow-hidden text-ellipsis" title="${character.name}">${character.name}</span>
                    `;
                    display.appendChild(characterChip);
                }
            });
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
        function addMessageToChat(sender, message, type, characterId = null) {
            const chatMessages = document.getElementById('chatMessages');
            
            const welcomeMessage = document.getElementById('chatWelcomeMessage');
            if (welcomeMessage) {
                welcomeMessage.remove();
            }
            
            const messageDiv = document.createElement('div');
            
            if (type === 'user') {
                messageDiv.className = 'flex items-start space-x-3 animate-fade-in mb-4 justify-end';
                messageDiv.innerHTML = `
                    <div class="bg-gradient-to-r from-sanctuary-blue to-sanctuary-pink text-white p-3 rounded-lg max-w-xs sm:max-w-sm md:max-w-md lg:max-w-lg shadow-lg">
                        <div class="font-medium text-sm mb-1">${sender}</div>
                        <div class="break-words">${message}</div>
                    </div>
                    <div class="w-8 h-8 bg-gradient-to-r from-gray-400 to-gray-500 rounded-full flex items-center justify-center text-white text-sm font-bold">
                        ä½ 
                    </div>
                `;
            } else if (type === 'system') {
                messageDiv.className = 'flex justify-center mb-4 animate-fade-in';
                messageDiv.innerHTML = `
                    <div class="bg-sanctuary-cream/80 backdrop-blur-sm text-sanctuary-blue p-4 rounded-xl max-w-md text-center border border-sanctuary-blue/20 shadow-lg">
                        <div class="break-words">${message}</div>
                    </div>
                `;
            } else {
                messageDiv.className = 'flex items-start animate-fade-in mb-4';
                
                const character = allCharacters.find(c => c.id === characterId);
                let avatarHtml;
                if (character) {
                    avatarHtml = generateAvatarHtml(character, 'w-8 h-8');
                } else {
                    avatarHtml = `<div class="w-8 h-8 bg-sanctuary-blue rounded-full flex items-center justify-center text-white text-sm font-bold">${sender.charAt(0)}</div>`;
                }
                
                messageDiv.innerHTML = `
                    <div class="flex-shrink-0 mr-3">
                        ${avatarHtml}
                    </div>
                    <div class="bg-white/80 backdrop-blur-sm p-3 rounded-lg max-w-xs sm:max-w-sm md:max-w-md lg:max-w-lg shadow-lg border border-sanctuary-blue/10 animate-glow">
                        <div class="font-medium text-sm mb-1 text-sanctuary-blue">${sender}</div>
                        <div class="break-words text-gray-700">${message}</div>
                    </div>
                `;
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // æ·»åŠ åˆ°èŠå¤©å†å²
            if (type !== 'system') {
                chatHistory.push({
                    sender: sender,
                    message: message,
                    type: type,
                    character_id: characterId,
                    timestamp: new Date().toISOString()
                });
            }
        }

        // æ˜¾ç¤ºè¾“å…¥æŒ‡ç¤ºå™¨
        function showTypingIndicators() {
            selectedCharacterIds.forEach((id, index) => {
                setTimeout(() => {
                    showSingleTypingIndicator(id);
                }, index * 500);
            });
        }

        // æ˜¾ç¤ºå•ä¸ªè§’è‰²çš„è¾“å…¥æŒ‡ç¤ºå™¨
        function showSingleTypingIndicator(characterId) {
            const character = allCharacters.find(c => c.id === characterId);
            if (character) {
                const typingDiv = document.createElement('div');
                typingDiv.className = 'flex items-start mb-4 typing-indicator';
                typingDiv.id = `typing-${characterId}`;
                
                const avatarHtml = generateAvatarHtml(character, 'w-8 h-8');
                
                typingDiv.innerHTML = `
                    <div class="flex-shrink-0 mr-3">
                        ${avatarHtml}
                    </div>
                    <div class="bg-white/80 backdrop-blur-sm p-3 rounded-lg shadow-lg border border-sanctuary-blue/10">
                        <div class="font-medium text-sm mb-1 text-sanctuary-blue">${character.name}</div>
                        <div class="flex space-x-1">
                            <div class="w-2 h-2 bg-sanctuary-blue rounded-full animate-bounce"></div>
                            <div class="w-2 h-2 bg-sanctuary-blue rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                            <div class="w-2 h-2 bg-sanctuary-blue rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                        </div>
                    </div>
                `;
                
                document.getElementById('chatMessages').appendChild(typingDiv);
                document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
            }
        }

        // ç§»é™¤è¾“å…¥æŒ‡ç¤ºå™¨
        function removeTypingIndicators() {
            document.querySelectorAll('.typing-indicator').forEach(indicator => {
                indicator.remove();
            });
        }

        // ç§»é™¤å•ä¸ªè§’è‰²çš„è¾“å…¥æŒ‡ç¤ºå™¨
        function removeSingleTypingIndicator(characterId) {
            const typingIndicator = document.getElementById(`typing-${characterId}`);
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg animate-slide-up ${
                type === 'error' ? 'bg-red-500 text-white' :
                type === 'success' ? 'bg-green-500 text-white' :
                'bg-sanctuary-blue text-white'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    </script>
</body>
</html>