<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatPersona - æˆ‘çš„AIäººæ ¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'bounce-slow': 'bounce 2s infinite',
                        'pulse-slow': 'pulse 3s infinite'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gradient-to-br from-purple-50 to-indigo-100 min-h-screen">
    <!-- å¯¼èˆªæ  -->
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-indigo-600 rounded-full flex items-center justify-center">
                        <span class="text-white font-bold text-sm">CP</span>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-800">ChatPersona</h1>
                </div>
                <div class="flex space-x-4">
                    <button onclick="showApiKeyModal()" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg text-sm font-medium transition">
                        ğŸ”‘ APIè®¾ç½®
                    </button>
                    <a href="/undercover" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition">
                        ğŸ­ è°æ˜¯å§åº•
                    </a>
                    <a href="/sanctuary" class="bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition">
                        ğŸ  å¿ƒçµå°å±‹
                    </a>
                    <a href="/chat" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition">
                        ğŸ’¬ å¼€å§‹èŠå¤©
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="max-w-7xl mx-auto px-4 py-8">
        <div class="text-center mb-8">
            <h2 class="text-4xl font-bold text-gray-800 mb-4">æˆ‘çš„AIäººæ ¼</h2>
            <p class="text-gray-600 text-lg">åˆ›å»ºç‹¬ç‰¹çš„AIè§’è‰²ï¼Œå¼€å¯å¤šå…ƒåŒ–å¯¹è¯ä½“éªŒ</p>
        </div>

        <!-- åŠŸèƒ½ä»‹ç»åŒºåŸŸ - å¹¶æ’å¸ƒå±€ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- æ¸¸æˆåŠŸèƒ½ä»‹ç» -->
            <div class="bg-gradient-to-r from-red-50 to-orange-50 rounded-xl p-6 border border-red-200">
                <div class="flex flex-col h-full">
                    <div class="flex-1">
                        <h3 class="text-xl font-bold text-gray-800 mb-2">ğŸ­ Persona Undercover</h3>
                        <p class="text-gray-600 mb-4 text-sm">ä½“éªŒAIäººæ ¼æ¨ç†æ¸¸æˆï¼è®©ä½ çš„AIè§’è‰²å‚ä¸"è°æ˜¯å§åº•"ï¼Œé€šè¿‡ä¸åŒçš„äººæ ¼é£æ ¼å’Œè¯­è¨€ç‰¹ç‚¹è¿›è¡Œæ¨ç†ä¸è¯†åˆ«ã€‚</p>
                        <div class="flex flex-wrap gap-2 mb-4">
                            <span class="bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs">ğŸ§  æ™ºèƒ½æ¨ç†</span>
                            <span class="bg-orange-100 text-orange-800 px-2 py-1 rounded-full text-xs">ğŸ¨ äººæ ¼é£æ ¼</span>
                            <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs">ğŸ•µï¸ èº«ä»½éšè—</span>
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs">ğŸ¯ å¤šè½®å¯¹è¯</span>
                        </div>
                    </div>
                    <div class="mt-4">
                        <a href="/undercover" class="inline-flex items-center space-x-2 bg-gradient-to-r from-red-500 to-orange-600 hover:from-red-600 hover:to-orange-700 text-white px-4 py-2 rounded-lg font-semibold transition transform hover:scale-105 shadow-lg text-sm">
                            <span class="text-lg">ğŸ®</span>
                            <span>ç«‹å³ä½“éªŒ</span>
                        </a>
                    </div>
                </div>
            </div>

            <!-- ChatSanctuaryåŠŸèƒ½ä»‹ç» -->
            <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl p-6 border border-blue-200">
                <div class="flex flex-col h-full">
                    <div class="flex-1">
                        <h3 class="text-xl font-bold text-gray-800 mb-2">ğŸŒ¸ ChatSanctuaryï¼šå¿ƒçµå°å±‹</h3>
                        <p class="text-gray-600 mb-4 text-sm">AIé™ªä¼´å¼æƒ…ç»ªç–—æ„ˆå¹³å°ã€‚åˆ†äº«ä½ çš„å¿ƒå£°ï¼Œè®©AIæœ‹å‹ä»¬é™ªä¼´ä½ æ¢ç´¢å†…å¿ƒï¼Œæœ€ç»ˆä¸ºä½ åˆ›ä½œä¸“å±çš„æ²»æ„ˆç”»ä½œã€‚</p>
                        <div class="flex flex-wrap gap-2 mb-4">
                            <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs">ğŸ’ æƒ…ç»ªé™ªä¼´</span>
                            <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded-full text-xs">ğŸ¨ å›¾åƒç–—æ„ˆ</span>
                            <span class="bg-pink-100 text-pink-800 px-2 py-1 rounded-full text-xs">ğŸ¤— å…±æƒ…å¯¹è¯</span>
                            <span class="bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full text-xs">ğŸ–¼ï¸ å¿ƒæƒ…å›¾å†Œ</span>
                        </div>
                    </div>
                    <div class="mt-4">
                        <a href="/sanctuary" class="inline-flex items-center space-x-2 bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white px-4 py-2 rounded-lg font-semibold transition transform hover:scale-105 shadow-lg text-sm">
                            <span class="text-lg">ğŸ </span>
                            <span>è¿›å…¥å°å±‹</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- è§’è‰²ç½‘æ ¼ -->
        <div id="charactersGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- è§’è‰²å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
        </div>

        <!-- åˆ›å»ºæ–°è§’è‰²æŒ‰é’® -->
        <div class="mt-8 text-center">
            <a href="/create" class="inline-flex items-center space-x-2 bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white px-8 py-4 rounded-xl text-lg font-medium transition transform hover:scale-105 shadow-lg">
                <span class="text-2xl">âœ¨</span>
                <span>åˆ›å»ºæ–°è§’è‰²</span>
            </a>
        </div>
    </div>

    <!-- API Key è®¾ç½®æ¨¡æ€æ¡† -->
    <div id="apiKeyModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold mb-4">API Key è®¾ç½®</h3>
            <p class="text-gray-600 text-sm mb-4">ä½ å¯ä»¥è¾“å…¥è‡ªå·±çš„ç™¾ç‚¼ Keyï¼Œæˆ–ä½¿ç”¨é»˜è®¤é€šç”¨ Key ä½“éªŒåŠŸèƒ½ã€‚</p>
            <input type="password" id="apiKeyInput" placeholder="è¾“å…¥ä½ çš„é˜¿é‡Œäº‘ç™¾ç‚¼API Key" class="w-full p-3 border rounded-lg mb-4 focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
            <div class="flex space-x-3">
                <button onclick="hideApiKeyModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg transition">
                    å–æ¶ˆ
                </button>
                <button onclick="saveApiKey()" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition">
                    ä¿å­˜
                </button>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘è§’è‰²æ¨¡æ€æ¡† -->
    <div id="editCharacterModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4">ç¼–è¾‘è§’è‰²</h3>
            <form id="editCharacterForm">
                <input type="hidden" id="editCharacterId">
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">è§’è‰²åç§°</label>
                    <input type="text" id="editCharacterName" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" required>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">å¤´åƒè®¾ç½®</label>
                    <div class="flex items-center space-x-4 mb-3">
                        <div id="editAvatarPreview" class="w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center text-xl">ğŸ‘¤</div>
                        <div class="flex space-x-2">
                            <button type="button" onclick="showEmojiSelector()" class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1 rounded text-sm transition">
                                ğŸ˜€ é€‰æ‹©è¡¨æƒ…
                            </button>
                            <button type="button" onclick="document.getElementById('editAvatarUpload').click()" class="bg-green-100 hover:bg-green-200 text-green-700 px-3 py-1 rounded text-sm transition">
                                ğŸ“ ä¸Šä¼ å›¾ç‰‡
                            </button>
                            <button type="button" onclick="resetToInitial()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded text-sm transition">
                                ğŸ”„ é‡ç½®
                            </button>
                        </div>
                    </div>
                    <input type="file" id="editAvatarUpload" accept="image/*" style="display: none" onchange="handleAvatarUpload(event)">
                    <input type="hidden" id="editAvatarType" value="initial">
                    <input type="hidden" id="editAvatarValue">
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">è§’è‰²æè¿°</label>
                    <textarea id="editCharacterDescription" rows="3" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" required></textarea>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">æ€§æ ¼ç‰¹ç‚¹</label>
                    <input type="text" id="editCharacterPersonality" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" required>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ç³»ç»Ÿæç¤ºè¯</label>
                    <textarea id="editCharacterPrompt" rows="8" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="è¾“å…¥è§’è‰²çš„ç³»ç»Ÿæç¤ºè¯..." required></textarea>
                </div>
                
                <div class="flex space-x-3">
                    <button type="button" onclick="hideEditModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg transition">
                        å–æ¶ˆ
                    </button>
                    <button type="button" onclick="deleteCharacter()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition">
                        åˆ é™¤è§’è‰²
                    </button>
                    <button type="submit" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition">
                        ä¿å­˜ä¿®æ”¹
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Emojié€‰æ‹©å™¨æ¨¡æ€æ¡† -->
    <div id="emojiModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 max-h-[80vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4">é€‰æ‹©è¡¨æƒ…å¤´åƒ</h3>
            <div class="grid grid-cols-6 gap-2 mb-4" id="emojiGrid">
                <!-- Emojié€‰é¡¹å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
            </div>
            <button onclick="hideEmojiSelector()" class="w-full bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg transition">
                å–æ¶ˆ
            </button>
        </div>
    </div>

    <!-- åŠ è½½æç¤º -->
    <div id="loadingSpinner" class="fixed inset-0 bg-white bg-opacity-80 flex items-center justify-center z-40">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
            <p class="text-gray-600">åŠ è½½ä¸­...</p>
        </div>
    </div>

    <script>
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadCharacters();
            
            // ç›‘å¬è§’è‰²åç§°è¾“å…¥ï¼Œå®æ—¶æ›´æ–°å¤´åƒé¢„è§ˆ
            const nameInput = document.getElementById('editCharacterName');
            if (nameInput) {
                nameInput.addEventListener('input', updateAvatarPreview);
            }
        });

        // åŠ è½½è§’è‰²åˆ—è¡¨
        async function loadCharacters() {
            try {
                const response = await fetch('/api/characters');
                const characters = await response.json();
                displayCharacters(characters);
            } catch (error) {
                console.error('åŠ è½½è§’è‰²å¤±è´¥:', error);
                showNotification('åŠ è½½è§’è‰²å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
            } finally {
                hideLoading();
            }
        }

        // æ˜¾ç¤ºè§’è‰²åˆ—è¡¨
        function displayCharacters(characters) {
            const grid = document.getElementById('charactersGrid');
            grid.innerHTML = '';

            characters.forEach(character => {
                const characterCard = createCharacterCard(character);
                grid.appendChild(characterCard);
            });
        }

        // åˆ›å»ºè§’è‰²å¡ç‰‡
        function createCharacterCard(character) {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-xl shadow-lg p-6 hover:shadow-xl hover:ring-2 hover:ring-indigo-400 transition transform hover:scale-105 cursor-pointer';
            
            // ç”Ÿæˆå¤´åƒHTML
            const avatarHtml = generateAvatarHtml(character);
            
            card.innerHTML = `
                <div class="text-center">
                    ${avatarHtml}
                    <h3 class="text-xl font-bold text-gray-800 mb-2">${character.name}</h3>
                    <p class="text-indigo-600 text-sm font-medium mb-2">${character.personality}</p>
                    <p class="text-gray-600 text-sm mb-4">${character.description}</p>
                    <div class="flex space-x-2 mb-2">
                        <button onclick="selectCharacterForChat(${character.id})" class="flex-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 px-3 py-2 rounded-lg text-sm font-medium transition">
                            é€‰æ‹©èŠå¤©
                        </button>
                        <button onclick="previewCharacter(${character.id})" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-lg text-sm font-medium transition">
                            é¢„è§ˆ
                        </button>
                    </div>
                    <button onclick="editCharacter(${character.id})" class="w-full bg-yellow-100 hover:bg-yellow-200 text-yellow-700 px-3 py-2 rounded-lg text-sm font-medium transition">
                        âœï¸ ç¼–è¾‘è§’è‰²
                    </button>
                </div>
            `;
            
            return card;
        }

        // é€‰æ‹©è§’è‰²è¿›è¡ŒèŠå¤©
        function selectCharacterForChat(characterId) {
            // å°†è§’è‰²IDå­˜å‚¨åˆ°sessionStorageï¼Œç„¶åè·³è½¬åˆ°èŠå¤©é¡µé¢
            let selectedCharacters = JSON.parse(sessionStorage.getItem('selectedCharacters') || '[]');
            if (!selectedCharacters.includes(characterId)) {
                selectedCharacters.push(characterId);
                sessionStorage.setItem('selectedCharacters', JSON.stringify(selectedCharacters));
            }
            window.location.href = '/chat';
        }

        // é¢„è§ˆè§’è‰²
        async function previewCharacter(characterId) {
            try {
                showLoading();
                const response = await fetch('/api/characters');
                const characters = await response.json();
                const character = characters.find(c => c.id === characterId);
                
                if (character) {
                    const previewResponse = await fetch('/api/generate-preview', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            system_prompt: character.system_prompt
                        })
                    });
                    
                    const result = await previewResponse.json();
                    if (result.preview) {
                        showPreviewModal(character.name, result.preview);
                    } else {
                        showNotification('é¢„è§ˆç”Ÿæˆå¤±è´¥', 'error');
                    }
                }
            } catch (error) {
                console.error('é¢„è§ˆå¤±è´¥:', error);
                showNotification('é¢„è§ˆå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            } finally {
                hideLoading();
            }
        }

        // æ˜¾ç¤ºé¢„è§ˆæ¨¡æ€æ¡†
        function showPreviewModal(characterName, preview) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-lg w-full mx-4">
                    <h3 class="text-xl font-bold mb-4">${characterName} çš„é¢„è§ˆ</h3>
                    <div class="bg-gray-50 p-4 rounded-lg mb-4">
                        <p class="text-gray-800">${preview}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition">
                        å…³é—­
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // API Key ç›¸å…³å‡½æ•°
        function showApiKeyModal() {
            document.getElementById('apiKeyModal').classList.remove('hidden');
            document.getElementById('apiKeyModal').classList.add('flex');
        }

        function hideApiKeyModal() {
            document.getElementById('apiKeyModal').classList.add('hidden');
            document.getElementById('apiKeyModal').classList.remove('flex');
        }

        async function saveApiKey() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            if (!apiKey) {
                showNotification('è¯·è¾“å…¥API Key', 'error');
                return;
            }

            try {
                const response = await fetch('/api/set-api-key', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ api_key: apiKey })
                });

                const result = await response.json();
                if (response.ok) {
                    showNotification('API Key è®¾ç½®æˆåŠŸ', 'success');
                    hideApiKeyModal();
                    document.getElementById('apiKeyInput').value = '';
                } else {
                    showNotification(result.error || 'API Key è®¾ç½®å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('è®¾ç½®API Keyå¤±è´¥:', error);
                showNotification('è®¾ç½®å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }

        // ç”Ÿæˆå¤´åƒHTML
        function generateAvatarHtml(character, sizeClass = 'w-16 h-16') {
            const avatarType = character.avatar_type || 'initial';
            const avatarValue = character.avatar_value;
            const textSize = sizeClass.includes('w-12') ? 'text-xl' : 'text-2xl';
            const emojiSize = sizeClass.includes('w-12') ? 'text-xl' : 'text-3xl';
            
            if (avatarType === 'emoji' && avatarValue) {
                return `<div class="${sizeClass} bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4 ${emojiSize}">${avatarValue}</div>`;
            } else if (avatarType === 'upload' && avatarValue) {
                return `<div class="${sizeClass} rounded-full mx-auto mb-4 overflow-hidden"><img src="${avatarValue}" alt="${character.name}" class="w-full h-full object-cover"></div>`;
            } else {
                // é»˜è®¤ä½¿ç”¨é¦–å­—æ¯å¤´åƒ
                const colors = ['bg-red-400', 'bg-blue-400', 'bg-green-400', 'bg-yellow-400', 'bg-purple-400', 'bg-pink-400', 'bg-indigo-400'];
                const colorIndex = character.id ? character.id % colors.length : Math.floor(Math.random() * colors.length);
                const bgColor = colors[colorIndex];
                return `<div class="${sizeClass} ${bgColor} rounded-full flex items-center justify-center mx-auto mb-4 text-white ${textSize} font-bold">${character.name.charAt(0)}</div>`;
            }
        }

        // å¤´åƒç›¸å…³å‡½æ•°
        const commonEmojis = [
            'ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜Š', 'ğŸ˜‡',
            'ğŸ™‚', 'ğŸ™ƒ', 'ğŸ˜‰', 'ğŸ˜Œ', 'ğŸ˜', 'ğŸ¥°', 'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜™', 'ğŸ˜š',
            'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜', 'ğŸ˜œ', 'ğŸ¤ª', 'ğŸ¤¨', 'ğŸ§', 'ğŸ¤“', 'ğŸ˜', 'ğŸ¤©',
            'ğŸ¥³', 'ğŸ˜', 'ğŸ˜’', 'ğŸ˜', 'ğŸ˜”', 'ğŸ˜Ÿ', 'ğŸ˜•', 'ğŸ™', 'â˜¹ï¸', 'ğŸ˜£',
            'ğŸ˜–', 'ğŸ˜«', 'ğŸ˜©', 'ğŸ¥º', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜¤', 'ğŸ˜ ', 'ğŸ˜¡', 'ğŸ¤¬',
            'ğŸ¤¯', 'ğŸ˜³', 'ğŸ¥µ', 'ğŸ¥¶', 'ğŸ˜±', 'ğŸ˜¨', 'ğŸ˜°', 'ğŸ˜¥', 'ğŸ˜“', 'ğŸ¤—',
            'ğŸ¤”', 'ğŸ¤­', 'ğŸ¤«', 'ğŸ¤¥', 'ğŸ˜¶', 'ğŸ˜', 'ğŸ˜‘', 'ğŸ˜¬', 'ğŸ™„', 'ğŸ˜¯',
            'ğŸ˜¦', 'ğŸ˜§', 'ğŸ˜®', 'ğŸ˜²', 'ğŸ¥±', 'ğŸ˜´', 'ğŸ¤¤', 'ğŸ˜ª', 'ğŸ˜µ', 'ğŸ¤',
            'ğŸ¥´', 'ğŸ¤¢', 'ğŸ¤®', 'ğŸ¤§', 'ğŸ˜·', 'ğŸ¤’', 'ğŸ¤•', 'ğŸ¤‘', 'ğŸ¤ ', 'ğŸ˜ˆ',
            'ğŸ‘¿', 'ğŸ‘¹', 'ğŸ‘º', 'ğŸ¤¡', 'ğŸ’©', 'ğŸ‘»', 'ğŸ’€', 'â˜ ï¸', 'ğŸ‘½', 'ğŸ‘¾',
            'ğŸ¤–', 'ğŸƒ', 'ğŸ˜º', 'ğŸ˜¸', 'ğŸ˜¹', 'ğŸ˜»', 'ğŸ˜¼', 'ğŸ˜½', 'ğŸ™€', 'ğŸ˜¿',
            'ğŸ˜¾', 'ğŸ‘¶', 'ğŸ‘§', 'ğŸ§’', 'ğŸ‘¦', 'ğŸ‘©', 'ğŸ§‘', 'ğŸ‘¨', 'ğŸ‘µ', 'ğŸ§“',
            'ğŸ‘´', 'ğŸ‘²', 'ğŸ‘³', 'ğŸ‘®', 'ğŸ‘·', 'ğŸ’‚', 'ğŸ•µï¸', 'ğŸ‘©â€âš•ï¸', 'ğŸ‘¨â€âš•ï¸', 'ğŸ‘©â€ğŸŒ¾'
        ];
        
        function showEmojiSelector() {
            const emojiGrid = document.getElementById('emojiGrid');
            emojiGrid.innerHTML = '';
            
            commonEmojis.forEach(emoji => {
                const button = document.createElement('button');
                button.className = 'w-10 h-10 text-2xl hover:bg-gray-100 rounded transition';
                button.textContent = emoji;
                button.onclick = () => selectEmoji(emoji);
                emojiGrid.appendChild(button);
            });
            
            document.getElementById('emojiModal').classList.remove('hidden');
            document.getElementById('emojiModal').classList.add('flex');
        }
        
        function hideEmojiSelector() {
            document.getElementById('emojiModal').classList.add('hidden');
            document.getElementById('emojiModal').classList.remove('flex');
        }
        
        function selectEmoji(emoji) {
            document.getElementById('editAvatarType').value = 'emoji';
            document.getElementById('editAvatarValue').value = emoji;
            updateAvatarPreview();
            hideEmojiSelector();
        }
        
        function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) { // 5MBé™åˆ¶
                    showNotification('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5MB', 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('editAvatarType').value = 'upload';
                    document.getElementById('editAvatarValue').value = e.target.result;
                    updateAvatarPreview();
                };
                reader.readAsDataURL(file);
            }
        }
        
        function resetToInitial() {
            document.getElementById('editAvatarType').value = 'initial';
            document.getElementById('editAvatarValue').value = '';
            updateAvatarPreview();
        }
        
        function updateAvatarPreview() {
            const avatarType = document.getElementById('editAvatarType').value;
            const avatarValue = document.getElementById('editAvatarValue').value;
            const preview = document.getElementById('editAvatarPreview');
            const characterName = document.getElementById('editCharacterName').value || 'A';
            
            // åˆ›å»ºä¸´æ—¶è§’è‰²å¯¹è±¡
            const tempCharacter = {
                name: characterName,
                avatar_type: avatarType,
                avatar_value: avatarValue
            };
            
            // ä½¿ç”¨ç»Ÿä¸€çš„å¤´åƒç”Ÿæˆå‡½æ•°
            const avatarHtml = generateAvatarHtml(tempCharacter, 'w-12 h-12').replace('mx-auto mb-4', '');
            preview.outerHTML = `<div id="editAvatarPreview">${avatarHtml}</div>`;
        }

        // ç¼–è¾‘è§’è‰²ç›¸å…³å‡½æ•°
        async function editCharacter(characterId) {
            try {
                const response = await fetch(`/api/characters/${characterId}`);
                const character = await response.json();
                
                if (response.ok) {
                    console.log('è·å–åˆ°çš„è§’è‰²æ•°æ®:', character);
                    // å¡«å……ç¼–è¾‘è¡¨å•
                    document.getElementById('editCharacterId').value = character.id;
                    document.getElementById('editCharacterName').value = character.name || '';
                    document.getElementById('editCharacterDescription').value = character.description || '';
                    document.getElementById('editCharacterPersonality').value = character.personality || '';
                    document.getElementById('editCharacterPrompt').value = character.system_prompt || '';
                    
                    // è®¾ç½®å¤´åƒä¿¡æ¯
                    document.getElementById('editAvatarType').value = character.avatar_type || 'initial';
                    document.getElementById('editAvatarValue').value = character.avatar_value || '';
                    updateAvatarPreview();
                    
                    // æ˜¾ç¤ºç¼–è¾‘æ¨¡æ€æ¡†
                    document.getElementById('editCharacterModal').classList.remove('hidden');
                    document.getElementById('editCharacterModal').classList.add('flex');
                } else {
                    showNotification('è·å–è§’è‰²ä¿¡æ¯å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('Error fetching character:', error);
                showNotification('è·å–è§’è‰²ä¿¡æ¯å¤±è´¥', 'error');
            }
        }

        function hideEditModal() {
            document.getElementById('editCharacterModal').classList.add('hidden');
            document.getElementById('editCharacterModal').classList.remove('flex');
        }

        // å¤„ç†ç¼–è¾‘è¡¨å•æäº¤
        document.getElementById('editCharacterForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const characterId = document.getElementById('editCharacterId').value;
            const formData = {
                name: document.getElementById('editCharacterName').value.trim(),
                description: document.getElementById('editCharacterDescription').value.trim(),
                personality: document.getElementById('editCharacterPersonality').value.trim(),
                system_prompt: document.getElementById('editCharacterPrompt').value.trim(),
                avatar_type: document.getElementById('editAvatarType').value,
                avatar_value: document.getElementById('editAvatarValue').value
            };
            
            if (!formData.name || !formData.description || !formData.personality || !formData.system_prompt) {
                showNotification('è¯·å¡«å†™æ‰€æœ‰å­—æ®µ', 'error');
                return;
            }
            
            try {
                const response = await fetch(`/api/characters/${characterId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                if (response.ok) {
                    showNotification('è§’è‰²æ›´æ–°æˆåŠŸ', 'success');
                    hideEditModal();
                    loadCharacters(); // é‡æ–°åŠ è½½è§’è‰²åˆ—è¡¨
                } else {
                    showNotification(result.error || 'æ›´æ–°å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('Error updating character:', error);
                showNotification('æ›´æ–°å¤±è´¥', 'error');
            }
        });

        async function deleteCharacter() {
            const characterId = document.getElementById('editCharacterId').value;
            console.log('åˆ é™¤è§’è‰²ID:', characterId);
            
            if (!characterId) {
                showNotification('æœªæ‰¾åˆ°è§’è‰²ID', 'error');
                return;
            }
            
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè§’è‰²å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/characters/${characterId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                if (response.ok) {
                    showNotification('è§’è‰²åˆ é™¤æˆåŠŸ', 'success');
                    hideEditModal();
                    loadCharacters(); // é‡æ–°åŠ è½½è§’è‰²åˆ—è¡¨
                } else {
                    showNotification(result.error || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('Error deleting character:', error);
                showNotification('åˆ é™¤å¤±è´¥', 'error');
            }
        }

        // å·¥å…·å‡½æ•°
        function showLoading() {
            document.getElementById('loadingSpinner').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingSpinner').classList.add('hidden');
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            
            notification.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-transform duration-300 translate-x-full`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // åŠ¨ç”»æ˜¾ç¤º
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html>