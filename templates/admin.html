<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å‘˜é¢æ¿ - ChatPersona</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f6fa;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem 2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            opacity: 0.9;
        }

        .nav-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .nav-btn {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 500;
            transition: background 0.3s ease;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .container {
            max-width: 1400px; /* å¢åŠ å®¹å™¨æœ€å¤§å®½åº¦ */
            margin: 2rem auto;
            padding: 0 1rem;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .container {
                padding: 0 1rem;
            }
            
            th:last-child, td:last-child {
                width: 240px;
                min-width: 240px;
            }
            
            td:last-child .btn {
                padding: 0.25rem 0.5rem;
                font-size: 0.7rem;
                margin-right: 0.2rem;
            }
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 10px 10px 0 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .tab {
            flex: 1;
            padding: 1rem 2rem;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: #666;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active:hover {
            background: white;
        }

        .tab-content {
            background: white;
            padding: 2rem;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            min-height: 500px;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        .section-title {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 0.5rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 1rem;
            opacity: 0.9;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid #e1e5e9;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 1000px; /* ç¡®ä¿è¡¨æ ¼æœ‰è¶³å¤Ÿçš„æœ€å°å®½åº¦ */
        }

        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e1e5e9;
            white-space: nowrap; /* é˜²æ­¢æ–‡å­—æ¢è¡Œ */
        }

        /* æ“ä½œåˆ—ç‰¹æ®Šæ ·å¼ */
        th:last-child, td:last-child {
            width: 280px; /* å›ºå®šæ“ä½œåˆ—å®½åº¦ */
            min-width: 280px;
            white-space: nowrap;
        }

        /* ç”¨æˆ·ååˆ— */
        th:nth-child(2), td:nth-child(2) {
            min-width: 120px;
        }

        /* é‚®ç®±åˆ— */
        th:nth-child(3), td:nth-child(3) {
            min-width: 180px;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .btn {
            padding: 0.4rem 0.8rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            margin-right: 0.3rem;
            margin-bottom: 0.2rem;
            transition: all 0.3s ease;
            display: inline-block;
            white-space: nowrap;
        }

        /* æ“ä½œåˆ—ä¸­çš„æŒ‰é’®ç»„ */
        td:last-child .btn {
            padding: 0.3rem 0.6rem;
            font-size: 0.75rem;
            margin-right: 0.25rem;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .role-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .role-admin {
            background: #d1ecf1;
            color: #0c5460;
        }

        .role-user {
            background: #e2e3e5;
            color: #383d41;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #333;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e1e5e9;
        }

        .modal-title {
            font-size: 1.3rem;
            color: #333;
            margin: 0;
        }

        .close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .close:hover {
            color: #333;
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid #c33;
        }

        .success-message {
            background: #efe;
            color: #363;
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid #363;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 2rem 0;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #667eea;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 1rem;
            }

            .tabs {
                flex-direction: column;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .nav-buttons {
                flex-direction: column;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ç®¡ç†å‘˜é¢æ¿</h1>
        <p>ç³»ç»Ÿç®¡ç†å’Œç”¨æˆ·ç®¡ç†</p>
        <div class="nav-buttons">
            <a href="/" class="nav-btn">è¿”å›é¦–é¡µ</a>
            <a href="/logout" class="nav-btn">é€€å‡ºç™»å½•</a>
        </div>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="showTab('overview')">æ¦‚è§ˆ</button>
            <button class="tab" onclick="showTab('characters')">è§’è‰²ç®¡ç†</button>
            <button class="tab" onclick="showTab('users')">ç”¨æˆ·ç®¡ç†</button>
            <button class="tab" onclick="showTab('models')">æ¨¡å‹é…ç½®</button>
            <button class="tab" onclick="showTab('api')">APIé…ç½®</button>
        </div>

        <div class="tab-content">
            <!-- æ¦‚è§ˆæ ‡ç­¾é¡µ -->
            <div id="overview" class="tab-pane active">
                <h2 class="section-title">ç³»ç»Ÿæ¦‚è§ˆ</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalUsers">-</div>
                        <div class="stat-label">æ€»ç”¨æˆ·æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="activeUsers">-</div>
                        <div class="stat-label">æ´»è·ƒç”¨æˆ·</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalAccess">-</div>
                        <div class="stat-label">æ€»è®¿é—®æ¬¡æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalModelCalls">-</div>
                        <div class="stat-label">æ€»æ¨¡å‹è°ƒç”¨</div>
                    </div>
                </div>
            </div>

            <!-- è§’è‰²ç®¡ç†æ ‡ç­¾é¡µ -->
            <div id="characters" class="tab-pane">
                <h2 class="section-title">è§’è‰²ç®¡ç†</h2>
                <div class="loading" id="charactersLoading"></div>
                <div class="table-container">
                    <table id="charactersTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>å¤´åƒ</th>
                                <th>è§’è‰²åç§°</th>
                                <th>æ€§æ ¼</th>
                                <th>ç±»å‹</th>
                                <th>åˆ›å»ºè€…</th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="charactersTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ç”¨æˆ·ç®¡ç†æ ‡ç­¾é¡µ -->
            <div id="users" class="tab-pane">
                <h2 class="section-title">ç”¨æˆ·ç®¡ç†</h2>
                <div class="loading" id="usersLoading"></div>
                <div class="table-container">
                    <table id="usersTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>ç”¨æˆ·å</th>
                                <th>é‚®ç®±</th>
                                <th>è§’è‰²</th>
                                <th>çŠ¶æ€</th>
                                <th>è®¿é—®æ¬¡æ•°</th>
                                <th>æ¨¡å‹è°ƒç”¨</th>
                                <th>æ³¨å†Œæ—¶é—´</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- æ¨¡å‹é…ç½®æ ‡ç­¾é¡µ -->
            <div id="models" class="tab-pane">
                <h2 class="section-title">æ¨¡å‹é…ç½®</h2>
                <div class="form-group">
                    <button class="btn btn-primary" onclick="showAddModelModal()">æ·»åŠ æ–°é…ç½®</button>
                </div>
                <div class="loading" id="modelsLoading"></div>
                <div class="table-container">
                    <table id="modelsTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>é…ç½®åç§°</th>
                                <th>LLMæ¨¡å‹</th>
                                <th>å®‰å…¨æ£€æµ‹æ¨¡å‹</th>
                                <th>ç”Ÿå›¾æ¨¡å‹</th>
                                <th>æ˜¯å¦é»˜è®¤</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="modelsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- APIé…ç½®æ ‡ç­¾é¡µ -->
            <div id="api" class="tab-pane">
                <h2 class="section-title">APIé…ç½®</h2>
                <div class="form-group">
                    <label for="adminApiKey">é˜¿é‡Œäº‘ç™¾ç‚¼APIå¯†é’¥</label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="password" id="adminApiKey" placeholder="è¯·è¾“å…¥APIå¯†é’¥" style="flex: 1; padding: 0.75rem; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem;">
                        <button type="button" class="btn btn-primary" onclick="toggleApiKeyVisibility()">æ˜¾ç¤º</button>
                        <button type="button" class="btn btn-primary" onclick="saveApiKey()">ä¿å­˜</button>
                    </div>
                    <small style="color: #666; margin-top: 0.5rem; display: block;">ç®¡ç†å‘˜é»˜è®¤APIå¯†é’¥ï¼Œç”¨äºç³»ç»Ÿçº§åˆ«çš„æ¨¡å‹è°ƒç”¨</small>
                </div>
                <div id="apiMessage" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘ç”¨æˆ·æ¨¡æ€æ¡† -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ç¼–è¾‘ç”¨æˆ·</h3>
                <button class="close" onclick="closeModal('editUserModal')">&times;</button>
            </div>
            <form id="editUserForm">
                <div id="editUserMessage" style="display: none;"></div>
                <input type="hidden" id="editUserId">
                <div class="form-group">
                    <label for="editUserEmail">é‚®ç®±</label>
                    <input type="email" id="editUserEmail" required>
                </div>
                <div class="form-group">
                    <label for="editUserRole">è§’è‰²</label>
                    <select id="editUserRole" required>
                        <option value="user">æ™®é€šç”¨æˆ·</option>
                        <option value="admin">ç®¡ç†å‘˜</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editUserActive">çŠ¶æ€</label>
                    <select id="editUserActive" required>
                        <option value="1">å¯ç”¨</option>
                        <option value="0">ç¦ç”¨</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">ä¿å­˜æ›´æ”¹</button>
            </form>
        </div>
    </div>

    <!-- é‡ç½®å¯†ç æ¨¡æ€æ¡† -->
    <div id="resetPasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">é‡ç½®å¯†ç </h3>
                <button class="close" onclick="closeModal('resetPasswordModal')">&times;</button>
            </div>
            <form id="resetPasswordForm">
                <div id="resetPasswordMessage" style="display: none;"></div>
                <input type="hidden" id="resetUserId">
                <div class="form-group">
                    <label for="newPassword">æ–°å¯†ç </label>
                    <input type="password" id="newPassword" required>
                </div>
                <button type="submit" class="btn btn-danger">é‡ç½®å¯†ç </button>
            </form>
        </div>
    </div>

    <!-- æ·»åŠ æ¨¡å‹é…ç½®æ¨¡æ€æ¡† -->
    <div id="addModelModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">æ·»åŠ æ¨¡å‹é…ç½®</h3>
                <button class="close" onclick="closeModal('addModelModal')">&times;</button>
            </div>
            <form id="addModelForm">
                <div id="addModelMessage" style="display: none;"></div>
                <div class="form-group">
                    <label for="configName">é…ç½®åç§°</label>
                    <input type="text" id="configName" required>
                </div>
                <div class="form-group">
                    <label for="llmModel">LLMæ¨¡å‹</label>
                    <input type="text" id="llmModel" placeholder="ä¾‹å¦‚: qwen-plus" required>
                </div>
                <div class="form-group">
                    <label for="securityModel">å®‰å…¨æ£€æµ‹æ¨¡å‹</label>
                    <input type="text" id="securityModel" placeholder="ä¾‹å¦‚: deepseek-v3" required>
                </div>
                <div class="form-group">
                    <label for="imageModel">ç”Ÿå›¾æ¨¡å‹</label>
                    <input type="text" id="imageModel" placeholder="ä¾‹å¦‚: wanx2.1-t2i-turbo" required>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="isDefault"> è®¾ä¸ºé»˜è®¤é…ç½®
                    </label>
                </div>
                <button type="submit" class="btn btn-primary">æ·»åŠ é…ç½®</button>
            </form>
        </div>
    </div>

    <!-- ç¼–è¾‘æ¨¡å‹é…ç½®æ¨¡æ€æ¡† -->
    <div id="editModelModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ç¼–è¾‘æ¨¡å‹é…ç½®</h3>
                <button class="close" onclick="closeModal('editModelModal')">&times;</button>
            </div>
            <form id="editModelForm">
                <div id="editModelMessage" style="display: none;"></div>
                <input type="hidden" id="editConfigId">
                <div class="form-group">
                    <label for="editConfigName">é…ç½®åç§°</label>
                    <input type="text" id="editConfigName" required>
                </div>
                <div class="form-group">
                    <label for="editLlmModel">LLMæ¨¡å‹</label>
                    <input type="text" id="editLlmModel" placeholder="ä¾‹å¦‚: qwen-plus" required>
                </div>
                <div class="form-group">
                    <label for="editSecurityModel">å®‰å…¨æ£€æµ‹æ¨¡å‹</label>
                    <input type="text" id="editSecurityModel" placeholder="ä¾‹å¦‚: deepseek-v3" required>
                </div>
                <div class="form-group">
                    <label for="editImageModel">ç”Ÿå›¾æ¨¡å‹</label>
                    <input type="text" id="editImageModel" placeholder="ä¾‹å¦‚: wanx2.1-t2i-turbo" required>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="editIsDefault"> è®¾ä¸ºé»˜è®¤é…ç½®
                    </label>
                </div>
                <button type="submit" class="btn btn-primary">ä¿å­˜ä¿®æ”¹</button>
            </form>
        </div>
    </div>

    <!-- ç¼–è¾‘è§’è‰²æ¨¡æ€æ¡† -->
    <div id="editCharacterModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ç¼–è¾‘è§’è‰²</h3>
                <button class="close" onclick="closeModal('editCharacterModal')">&times;</button>
            </div>
            <form id="editCharacterForm">
                <div id="editCharacterMessage" style="display: none;"></div>
                <input type="hidden" id="editCharacterId">
                <div class="form-group">
                    <label for="editCharacterName">è§’è‰²åç§°</label>
                    <input type="text" id="editCharacterName" required>
                </div>
                <div class="form-group">
                    <label for="editCharacterPersonality">æ€§æ ¼æ ‡ç­¾</label>
                    <input type="text" id="editCharacterPersonality" required>
                </div>
                <div class="form-group">
                    <label for="editCharacterDescription">è§’è‰²æè¿°</label>
                    <textarea id="editCharacterDescription" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label for="editCharacterSystemPrompt">ç³»ç»Ÿæç¤ºè¯</label>
                    <textarea id="editCharacterSystemPrompt" rows="4" required></textarea>
                </div>
                <div class="form-group">
                    <label>å¤´åƒè®¾ç½®</label>
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
                        <div id="editAvatarPreview" style="width: 64px; height: 64px; background: #6366f1; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: bold;">A</div>
                        <div style="display: flex; gap: 8px;">
                            <button type="button" onclick="showEditEmojiSelector()" style="background: #dbeafe; color: #1d4ed8; border: none; padding: 8px 12px; border-radius: 6px; font-size: 12px; cursor: pointer;">ğŸ˜€ é€‰æ‹©è¡¨æƒ…</button>
                            <button type="button" onclick="document.getElementById('editAvatarUpload').click()" style="background: #dcfce7; color: #166534; border: none; padding: 8px 12px; border-radius: 6px; font-size: 12px; cursor: pointer;">ğŸ“ ä¸Šä¼ å›¾ç‰‡</button>
                            <button type="button" onclick="resetEditToInitial()" style="background: #f3f4f6; color: #374151; border: none; padding: 8px 12px; border-radius: 6px; font-size: 12px; cursor: pointer;">ğŸ”„ é‡ç½®</button>
                        </div>
                    </div>
                    <input type="file" id="editAvatarUpload" accept="image/*" style="display: none" onchange="handleEditAvatarUpload(event)">
                    <input type="hidden" id="editAvatarType" value="initial">
                    <input type="hidden" id="editAvatarValue">
                    <p style="font-size: 12px; color: #6b7280; margin: 0;">é€‰æ‹©è¡¨æƒ…ç¬¦å·ä½œä¸ºå¤´åƒï¼Œæˆ–ä¸Šä¼ è‡ªå®šä¹‰å›¾ç‰‡ï¼ˆæœ€å¤§5MBï¼‰</p>
                </div>
                <button type="submit" class="btn btn-primary">ä¿å­˜ä¿®æ”¹</button>
                <button type="button" class="btn btn-danger" onclick="deleteCharacter()">åˆ é™¤è§’è‰²</button>
            </form>
        </div>
    </div>

    <!-- è¡¨æƒ…é€‰æ‹©å™¨æ¨¡æ€æ¡† -->
    <div id="editEmojiModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">é€‰æ‹©è¡¨æƒ…ç¬¦å·</h3>
                <button class="close" onclick="hideEditEmojiSelector()">&times;</button>
            </div>
            <div style="padding: 20px;">
                <div id="editEmojiGrid" style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 8px; max-height: 300px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>

    <script>
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadOverviewStats();
            loadCharacters();
            loadUsers();
            loadModelConfigs();
            loadApiConfig();
            
            // è®¾ç½®é»˜è®¤APIå¯†é’¥
            const adminApiKey = document.getElementById('adminApiKey');
            if (!adminApiKey.value) {
                adminApiKey.value = 'sk-8963ec64f16a4bd8a9a91221d6049f20';
            }
            
            // ç›‘å¬è§’è‰²åç§°è¾“å…¥ï¼Œå®æ—¶æ›´æ–°å¤´åƒé¢„è§ˆ
            const editNameInput = document.getElementById('editCharacterName');
            if (editNameInput) {
                editNameInput.addEventListener('input', updateEditAvatarPreview);
            }
        });

        // æ ‡ç­¾é¡µåˆ‡æ¢
        function showTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µ
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µ
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // æ ¹æ®æ ‡ç­¾é¡µåŠ è½½å¯¹åº”æ•°æ®
            if (tabName === 'characters') {
                loadCharacters();
            } else if (tabName === 'users') {
                loadUsers();
            } else if (tabName === 'models') {
                loadModelConfigs();
            }
        }

        // åŠ è½½æ¦‚è§ˆç»Ÿè®¡
        async function loadOverviewStats() {
            try {
                const response = await fetch('/api/admin/users');
                if (response.ok) {
                    const data = await response.json();
                    const users = data.users || [];
                    
                    document.getElementById('totalUsers').textContent = users.length;
                    document.getElementById('activeUsers').textContent = users.filter(u => u.is_active).length;
                    document.getElementById('totalAccess').textContent = users.reduce((sum, u) => sum + (u.access_count || 0), 0);
                    document.getElementById('totalModelCalls').textContent = users.reduce((sum, u) => sum + (u.model_calls || 0), 0);
                }
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
            }
        }

        // åŠ è½½è§’è‰²åˆ—è¡¨
        async function loadCharacters() {
            const loading = document.getElementById('charactersLoading');
            const tbody = document.getElementById('charactersTableBody');
            
            loading.style.display = 'block';
            
            try {
                const response = await fetch('/api/admin/characters');
                if (response.ok) {
                    const data = await response.json();
                    const characters = data.characters || [];
                    
                    tbody.innerHTML = '';
                    characters.forEach(character => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${character.id}</td>
                            <td>
                                <div style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: #f0f0f0;">
                                    ${generateAvatarHtml(character.avatar_type, character.avatar_value)}
                                </div>
                            </td>
                            <td>${character.name}</td>
                            <td>${character.personality}</td>
                            <td><span class="status-badge ${character.is_default ? 'status-active' : 'status-inactive'}">${character.is_default ? 'é»˜è®¤è§’è‰²' : 'ç”¨æˆ·è§’è‰²'}</span></td>
                            <td>${character.creator || 'ç³»ç»Ÿ'}</td>
                            <td>${character.created_at ? new Date(character.created_at).toLocaleDateString() : '-'}</td>
                            <td>
                                <button class="btn btn-primary" onclick="editCharacter(${character.id})">ç¼–è¾‘</button>
                                ${!character.is_default ? `<button class="btn btn-danger" onclick="confirmDeleteCharacter(${character.id})">åˆ é™¤</button>` : ''}
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('åŠ è½½è§’è‰²åˆ—è¡¨å¤±è´¥:', error);
            } finally {
                loading.style.display = 'none';
            }
        }

        // ç”Ÿæˆå¤´åƒHTML
        function generateAvatarHtml(avatarType, avatarValue) {
            if (avatarType === 'emoji' && avatarValue) {
                return `<span style="font-size: 20px;">${avatarValue}</span>`;
            } else if (avatarType === 'upload' && avatarValue) {
                return `<img src="${avatarValue}" alt="å¤´åƒ" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
            } else {
                return `<span style="font-size: 16px; color: #999;">?</span>`;
            }
        }

        // ç¼–è¾‘è§’è‰²
        async function editCharacter(characterId) {
            try {
                const response = await fetch(`/api/admin/characters/${characterId}`);
                if (response.ok) {
                    const character = await response.json();
                    
                    document.getElementById('editCharacterId').value = character.id;
                    document.getElementById('editCharacterName').value = character.name;
                    document.getElementById('editCharacterPersonality').value = character.personality;
                    document.getElementById('editCharacterDescription').value = character.description;
                    document.getElementById('editCharacterSystemPrompt').value = character.system_prompt;
                    document.getElementById('editAvatarType').value = character.avatar_type || 'initial';
                    document.getElementById('editAvatarValue').value = character.avatar_value || '';
                    
                    // æ›´æ–°å¤´åƒé¢„è§ˆ
                    updateEditAvatarPreview();
                    
                    document.getElementById('editCharacterModal').style.display = 'block';
                }
            } catch (error) {
                console.error('è·å–è§’è‰²ä¿¡æ¯å¤±è´¥:', error);
                showMessage('editCharacterMessage', 'è·å–è§’è‰²ä¿¡æ¯å¤±è´¥', 'error');
            }
        }

        // ç¡®è®¤åˆ é™¤è§’è‰²
        function confirmDeleteCharacter(characterId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè§’è‰²å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                deleteCharacterById(characterId);
            }
        }

        // åˆ é™¤è§’è‰²
        async function deleteCharacter() {
            const characterId = document.getElementById('editCharacterId').value;
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè§’è‰²å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                await deleteCharacterById(characterId);
            }
        }

        // åˆ é™¤è§’è‰²ï¼ˆé€šç”¨å‡½æ•°ï¼‰
        async function deleteCharacterById(characterId) {
            try {
                const response = await fetch(`/api/admin/characters/${characterId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showMessage('editCharacterMessage', 'è§’è‰²åˆ é™¤æˆåŠŸ', 'success');
                    closeModal('editCharacterModal');
                    loadCharacters();
                } else {
                    const result = await response.json();
                    showMessage('editCharacterMessage', result.error || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤è§’è‰²å¤±è´¥:', error);
                showMessage('editCharacterMessage', 'åˆ é™¤å¤±è´¥', 'error');
            }
        }

        // åŠ è½½ç”¨æˆ·åˆ—è¡¨
        async function loadUsers() {
            const loading = document.getElementById('usersLoading');
            const tbody = document.getElementById('usersTableBody');
            
            loading.style.display = 'block';
            
            try {
                const response = await fetch('/api/admin/users');
                if (response.ok) {
                    const data = await response.json();
                    const users = data.users || [];
                    
                    tbody.innerHTML = '';
                    users.forEach(user => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${user.id}</td>
                            <td>${user.username}</td>
                            <td>${user.email || '-'}</td>
                            <td><span class="role-badge role-${user.role}">${user.role === 'admin' ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·'}</span></td>
                            <td><span class="status-badge status-${user.is_active ? 'active' : 'inactive'}">${user.is_active ? 'å¯ç”¨' : 'ç¦ç”¨'}</span></td>
                            <td>${user.access_count || 0}</td>
                            <td>${user.model_calls || 0}</td>
                            <td>${new Date(user.created_at).toLocaleDateString()}</td>
                            <td>
                                <button class="btn btn-primary" onclick="editUser(${user.id})">ç¼–è¾‘</button>
                                <button class="btn btn-warning" onclick="resetPassword(${user.id})">é‡ç½®å¯†ç </button>
                                ${user.role !== 'admin' ? `<button class="btn btn-danger" onclick="deleteUser(${user.id}, '${user.username}')">åˆ é™¤</button>` : ''}
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
            } finally {
                loading.style.display = 'none';
            }
        }

        // åŠ è½½æ¨¡å‹é…ç½®
        async function loadModelConfigs() {
            const loading = document.getElementById('modelsLoading');
            const tbody = document.getElementById('modelsTableBody');
            
            loading.style.display = 'block';
            
            try {
                const response = await fetch('/api/admin/model-config');
                if (response.ok) {
                    const data = await response.json();
                    const configs = data.configs || [];
                    
                    tbody.innerHTML = '';
                    configs.forEach(config => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${config.id}</td>
                            <td>${config.name}</td>
                            <td>${config.llm_model}</td>
                            <td>${config.security_model}</td>
                            <td>${config.image_model}</td>
                            <td><span class="status-badge status-${config.is_default ? 'active' : 'inactive'}">${config.is_default ? 'æ˜¯' : 'å¦'}</span></td>
                            <td>
                                <button class="btn btn-primary" onclick="editModelConfig(${config.id})">ç¼–è¾‘</button>
                                ${!config.is_default ? `<button class="btn btn-success" onclick="setDefaultConfig(${config.id})">è®¾ä¸ºé»˜è®¤</button>` : ''}
                                ${!config.is_default ? `<button class="btn btn-danger" onclick="deleteModelConfig(${config.id})">åˆ é™¤</button>` : ''}
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('åŠ è½½æ¨¡å‹é…ç½®å¤±è´¥:', error);
            } finally {
                loading.style.display = 'none';
            }
        }

        // ç¼–è¾‘ç”¨æˆ·
        function editUser(userId) {
            // è·å–ç”¨æˆ·ä¿¡æ¯å¹¶å¡«å……è¡¨å•
            fetch(`/api/admin/users`)
                .then(response => response.json())
                .then(data => {
                    const user = data.users.find(u => u.id === userId);
                    if (user) {
                        document.getElementById('editUserId').value = user.id;
                        document.getElementById('editUserEmail').value = user.email || '';
                        document.getElementById('editUserRole').value = user.role;
                        document.getElementById('editUserActive').value = user.is_active ? '1' : '0';
                        document.getElementById('editUserModal').style.display = 'block';
                    }
                });
        }

        // é‡ç½®å¯†ç 
        function resetPassword(userId) {
            document.getElementById('resetUserId').value = userId;
            document.getElementById('resetPasswordModal').style.display = 'block';
        }

        // åˆ é™¤ç”¨æˆ·å‡½æ•°
        function deleteUser(userId, username) {
            // ç¬¬ä¸€æ¬¡ç¡®è®¤
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ç”¨æˆ· "${username}" å—ï¼Ÿ\n\næ­¤æ“ä½œå°†ä¼šï¼š\n- åˆ é™¤è¯¥ç”¨æˆ·çš„æ‰€æœ‰èŠå¤©è®°å½•\n- åˆ é™¤è¯¥ç”¨æˆ·åˆ›å»ºçš„æ‰€æœ‰è§’è‰²\n- æ°¸ä¹…åˆ é™¤è¯¥ç”¨æˆ·è´¦æˆ·\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
                return;
            }
            
            // ç¬¬äºŒæ¬¡ç¡®è®¤
            const confirmText = prompt(`è¯·è¾“å…¥ç”¨æˆ·å "${username}" æ¥ç¡®è®¤åˆ é™¤æ“ä½œï¼š`);
            if (confirmText !== username) {
                if (confirmText !== null) { // ç”¨æˆ·æ²¡æœ‰å–æ¶ˆ
                    alert('ç”¨æˆ·åä¸åŒ¹é…ï¼Œåˆ é™¤æ“ä½œå·²å–æ¶ˆã€‚');
                }
                return;
            }
            
            // æ‰§è¡Œåˆ é™¤
            performDeleteUser(userId, username);
        }
        
        // æ‰§è¡Œåˆ é™¤ç”¨æˆ·æ“ä½œ
        async function performDeleteUser(userId, username) {
            try {
                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`ç”¨æˆ· "${username}" åˆ é™¤æˆåŠŸï¼`);
                    loadUsers(); // é‡æ–°åŠ è½½ç”¨æˆ·åˆ—è¡¨
                } else {
                    alert(`åˆ é™¤å¤±è´¥ï¼š${data.error}`);
                }
            } catch (error) {
                console.error('åˆ é™¤ç”¨æˆ·å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // æ˜¾ç¤ºæ·»åŠ æ¨¡å‹é…ç½®æ¨¡æ€æ¡†
        function showAddModelModal() {
            document.getElementById('addModelModal').style.display = 'block';
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // è®¾ç½®é»˜è®¤é…ç½®
        async function setDefaultConfig(configId) {
            try {
                const response = await fetch('/api/admin/model-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        set_default: configId
                    })
                });
                
                if (response.ok) {
                    loadModelConfigs();
                }
            } catch (error) {
                console.error('è®¾ç½®é»˜è®¤é…ç½®å¤±è´¥:', error);
            }
        }

        // ç¼–è¾‘æ¨¡å‹é…ç½®
        function editModelConfig(configId) {
            // è·å–é…ç½®ä¿¡æ¯å¹¶å¡«å……è¡¨å•
            fetch('/api/admin/model-config')
                .then(response => response.json())
                .then(data => {
                    const config = data.configs.find(c => c.id === configId);
                    if (config) {
                        document.getElementById('editConfigId').value = config.id;
                        document.getElementById('editConfigName').value = config.name;
                        document.getElementById('editLlmModel').value = config.llm_model;
                        document.getElementById('editSecurityModel').value = config.security_model;
                        document.getElementById('editImageModel').value = config.image_model;
                        document.getElementById('editIsDefault').checked = config.is_default;
                        document.getElementById('editModelModal').style.display = 'block';
                    }
                });
        }

        // åˆ é™¤æ¨¡å‹é…ç½®
        async function deleteModelConfig(configId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¨¡å‹é…ç½®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/model-config/${configId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                if (data.success) {
                    loadModelConfigs();
                } else {
                    alert(data.error || 'åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                console.error('åˆ é™¤é…ç½®å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // ç¼–è¾‘ç”¨æˆ·è¡¨å•æäº¤
        document.getElementById('editUserForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const userId = document.getElementById('editUserId').value;
            const email = document.getElementById('editUserEmail').value;
            const role = document.getElementById('editUserRole').value;
            const isActive = document.getElementById('editUserActive').value === '1';
            const messageDiv = document.getElementById('editUserMessage');
            
            messageDiv.style.display = 'none';
            
            try {
                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: email,
                        role: role,
                        is_active: isActive
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    messageDiv.className = 'success-message';
                    messageDiv.textContent = 'ç”¨æˆ·ä¿¡æ¯æ›´æ–°æˆåŠŸ';
                    messageDiv.style.display = 'block';
                    loadUsers();
                    setTimeout(() => closeModal('editUserModal'), 1500);
                } else {
                    messageDiv.className = 'error-message';
                    messageDiv.textContent = data.error || 'æ›´æ–°å¤±è´¥';
                    messageDiv.style.display = 'block';
                }
            } catch (error) {
                messageDiv.className = 'error-message';
                messageDiv.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
                messageDiv.style.display = 'block';
            }
        });

        // é‡ç½®å¯†ç è¡¨å•æäº¤
        document.getElementById('resetPasswordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const userId = document.getElementById('resetUserId').value;
            const newPassword = document.getElementById('newPassword').value;
            const messageDiv = document.getElementById('resetPasswordMessage');
            
            messageDiv.style.display = 'none';
            
            try {
                const response = await fetch(`/api/admin/users/${userId}/reset-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        new_password: newPassword
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    messageDiv.className = 'success-message';
                    messageDiv.textContent = 'å¯†ç é‡ç½®æˆåŠŸ';
                    messageDiv.style.display = 'block';
                    setTimeout(() => closeModal('resetPasswordModal'), 1500);
                } else {
                    messageDiv.className = 'error-message';
                    messageDiv.textContent = data.error || 'é‡ç½®å¤±è´¥';
                    messageDiv.style.display = 'block';
                }
            } catch (error) {
                messageDiv.className = 'error-message';
                messageDiv.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
                messageDiv.style.display = 'block';
            }
        });

        // æ·»åŠ æ¨¡å‹é…ç½®è¡¨å•æäº¤
        document.getElementById('addModelForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const name = document.getElementById('configName').value;
            const llmModel = document.getElementById('llmModel').value;
            const securityModel = document.getElementById('securityModel').value;
            const imageModel = document.getElementById('imageModel').value;
            const isDefault = document.getElementById('isDefault').checked;
            const messageDiv = document.getElementById('addModelMessage');
            
            messageDiv.style.display = 'none';
            
            try {
                const response = await fetch('/api/admin/model-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: name,
                        llm_model: llmModel,
                        security_model: securityModel,
                        image_model: imageModel,
                        is_default: isDefault
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    messageDiv.className = 'success-message';
                    messageDiv.textContent = 'é…ç½®æ·»åŠ æˆåŠŸ';
                    messageDiv.style.display = 'block';
                    loadModelConfigs();
                    setTimeout(() => closeModal('addModelModal'), 1500);
                } else {
                    messageDiv.className = 'error-message';
                    messageDiv.textContent = data.error || 'æ·»åŠ å¤±è´¥';
                    messageDiv.style.display = 'block';
                }
            } catch (error) {
                messageDiv.className = 'error-message';
                messageDiv.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
                messageDiv.style.display = 'block';
            }
        });

        // ç¼–è¾‘è§’è‰²è¡¨å•æäº¤
        document.getElementById('editCharacterForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const characterId = document.getElementById('editCharacterId').value;
            const name = document.getElementById('editCharacterName').value;
            const personality = document.getElementById('editCharacterPersonality').value;
            const description = document.getElementById('editCharacterDescription').value;
            const systemPrompt = document.getElementById('editCharacterSystemPrompt').value;
            const avatarType = document.getElementById('editAvatarType').value;
            const avatarValue = document.getElementById('editAvatarValue').value;
            const messageDiv = document.getElementById('editCharacterMessage');
            
            messageDiv.style.display = 'none';
            
            if (!name || !personality || !description || !systemPrompt) {
                messageDiv.className = 'error-message';
                messageDiv.textContent = 'è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ';
                messageDiv.style.display = 'block';
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/characters/${characterId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: name,
                        personality: personality,
                        description: description,
                        system_prompt: systemPrompt,
                        avatar_type: avatarType,
                        avatar_value: avatarValue
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    messageDiv.className = 'success-message';
                    messageDiv.textContent = 'è§’è‰²æ›´æ–°æˆåŠŸ';
                    messageDiv.style.display = 'block';
                    loadCharacters();
                    setTimeout(() => closeModal('editCharacterModal'), 1500);
                } else {
                    messageDiv.className = 'error-message';
                    messageDiv.textContent = data.error || 'æ›´æ–°å¤±è´¥';
                    messageDiv.style.display = 'block';
                }
            } catch (error) {
                messageDiv.className = 'error-message';
                messageDiv.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
                messageDiv.style.display = 'block';
            }
        });

        // ç¼–è¾‘æ¨¡å‹é…ç½®è¡¨å•æäº¤
        document.getElementById('editModelForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const configId = document.getElementById('editConfigId').value;
            const name = document.getElementById('editConfigName').value;
            const llmModel = document.getElementById('editLlmModel').value;
            const securityModel = document.getElementById('editSecurityModel').value;
            const imageModel = document.getElementById('editImageModel').value;
            const isDefault = document.getElementById('editIsDefault').checked;
            const messageDiv = document.getElementById('editModelMessage');
            
            messageDiv.style.display = 'none';
            
            try {
                const response = await fetch(`/api/admin/model-config/${configId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: name,
                        llm_model: llmModel,
                        security_model: securityModel,
                        image_model: imageModel,
                        is_default: isDefault
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    messageDiv.className = 'success-message';
                    messageDiv.textContent = 'é…ç½®ä¿®æ”¹æˆåŠŸ';
                    messageDiv.style.display = 'block';
                    loadModelConfigs();
                    setTimeout(() => closeModal('editModelModal'), 1500);
                } else {
                    messageDiv.className = 'error-message';
                    messageDiv.textContent = data.error || 'ä¿®æ”¹å¤±è´¥';
                    messageDiv.style.display = 'block';
                }
            } catch (error) {
                messageDiv.className = 'error-message';
                messageDiv.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
                messageDiv.style.display = 'block';
            }
        });

        // APIé…ç½®ç›¸å…³å‡½æ•°
        function toggleApiKeyVisibility() {
            const apiKeyInput = document.getElementById('adminApiKey');
            const toggleBtn = event.target;
            
            if (apiKeyInput.type === 'password') {
                apiKeyInput.type = 'text';
                toggleBtn.textContent = 'éšè—';
            } else {
                apiKeyInput.type = 'password';
                toggleBtn.textContent = 'æ˜¾ç¤º';
            }
        }

        async function saveApiKey() {
            const apiKey = document.getElementById('adminApiKey').value;
            const messageDiv = document.getElementById('apiMessage');
            
            if (!apiKey.trim()) {
                messageDiv.className = 'error-message';
                messageDiv.textContent = 'è¯·è¾“å…¥APIå¯†é’¥';
                messageDiv.style.display = 'block';
                return;
            }
            
            messageDiv.style.display = 'none';
            
            try {
                const response = await fetch('/api/admin/api-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        api_key: apiKey
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    messageDiv.className = 'success-message';
                    messageDiv.textContent = 'APIå¯†é’¥ä¿å­˜æˆåŠŸ';
                    messageDiv.style.display = 'block';
                } else {
                    messageDiv.className = 'error-message';
                    messageDiv.textContent = data.error || 'ä¿å­˜å¤±è´¥';
                    messageDiv.style.display = 'block';
                }
            } catch (error) {
                messageDiv.className = 'error-message';
                messageDiv.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
                messageDiv.style.display = 'block';
            }
        }

        async function loadApiConfig() {
            try {
                const response = await fetch('/api/admin/api-config');
                const data = await response.json();
                
                if (data.success && data.api_key) {
                    document.getElementById('adminApiKey').value = data.api_key;
                }
            } catch (error) {
                console.error('åŠ è½½APIé…ç½®å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(elementId, message, type) {
            const messageDiv = document.getElementById(elementId);
            if (messageDiv) {
                messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
                messageDiv.textContent = message;
                messageDiv.style.display = 'block';
            }
        }

        // å¤´åƒç›¸å…³å‡½æ•°
        const commonEmojis = [
            'ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜Š', 'ğŸ˜‡',
            'ğŸ™‚', 'ğŸ™ƒ', 'ğŸ˜‰', 'ğŸ˜Œ', 'ğŸ˜', 'ğŸ¥°', 'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜™', 'ğŸ˜š',
            'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜', 'ğŸ˜œ', 'ğŸ¤ª', 'ğŸ¤¨', 'ğŸ§', 'ğŸ¤“', 'ğŸ˜', 'ğŸ¤©',
            'ğŸ¥³', 'ğŸ˜', 'ğŸ˜’', 'ğŸ˜', 'ğŸ˜”', 'ğŸ˜Ÿ', 'ğŸ˜•', 'ğŸ™', 'â˜¹ï¸', 'ğŸ˜£',
            'ğŸ˜–', 'ğŸ˜«', 'ğŸ˜©', 'ğŸ¥º', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜¤', 'ğŸ˜ ', 'ğŸ˜¡', 'ğŸ¤¬',
            'ğŸ¤¯', 'ğŸ˜³', 'ğŸ¥µ', 'ğŸ¥¶', 'ğŸ˜±', 'ğŸ˜¨', 'ğŸ˜°', 'ğŸ˜¥', 'ğŸ˜“', 'ğŸ¤—',
            'ğŸ¤”', 'ğŸ¤­', 'ğŸ¤«', 'ğŸ¤¥', 'ğŸ˜¶', 'ğŸ˜', 'ğŸ˜‘', 'ğŸ˜¬', 'ğŸ™„', 'ğŸ˜¯',
            'ğŸ˜¦', 'ğŸ˜§', 'ğŸ˜®', 'ğŸ˜²', 'ğŸ¥±', 'ğŸ˜´', 'ğŸ¤¤', 'ğŸ˜ª', 'ğŸ˜µ', 'ğŸ¤',
            'ğŸ¥´', 'ğŸ¤¢', 'ğŸ¤®', 'ğŸ¤§', 'ğŸ˜·', 'ğŸ¤’', 'ğŸ¤•', 'ğŸ¤‘', 'ğŸ¤ ', 'ğŸ˜ˆ',
            'ğŸ‘¿', 'ğŸ‘¹', 'ğŸ‘º', 'ğŸ¤¡', 'ğŸ’©', 'ğŸ‘»', 'ğŸ’€', 'â˜ ï¸', 'ğŸ‘½', 'ğŸ‘¾',
            'ğŸ¤–', 'ğŸƒ', 'ğŸ˜º', 'ğŸ˜¸', 'ğŸ˜¹', 'ğŸ˜»', 'ğŸ˜¼', 'ğŸ˜½', 'ğŸ™€', 'ğŸ˜¿',
            'ğŸ˜¾', 'ğŸ‘¶', 'ğŸ‘§', 'ğŸ§’', 'ğŸ‘¦', 'ğŸ‘©', 'ğŸ§‘', 'ğŸ‘¨', 'ğŸ‘µ', 'ğŸ§“',
            'ğŸ‘´', 'ğŸ‘²', 'ğŸ‘³', 'ğŸ‘®', 'ğŸ‘·', 'ğŸ’‚', 'ğŸ•µï¸', 'ğŸ‘©â€âš•ï¸', 'ğŸ‘¨â€âš•ï¸', 'ğŸ‘©â€ğŸŒ¾'
        ];
        
        function showEditEmojiSelector() {
            const emojiGrid = document.getElementById('editEmojiGrid');
            emojiGrid.innerHTML = '';
            
            commonEmojis.forEach(emoji => {
                const button = document.createElement('button');
                button.style.cssText = 'width: 40px; height: 40px; font-size: 24px; border: none; background: none; cursor: pointer; border-radius: 4px; transition: background-color 0.2s;';
                button.textContent = emoji;
                button.onmouseover = () => button.style.backgroundColor = '#f3f4f6';
                button.onmouseout = () => button.style.backgroundColor = 'transparent';
                button.onclick = () => selectEditEmoji(emoji);
                emojiGrid.appendChild(button);
            });
            
            document.getElementById('editEmojiModal').style.display = 'flex';
        }
        
        function hideEditEmojiSelector() {
            document.getElementById('editEmojiModal').style.display = 'none';
        }
        
        function selectEditEmoji(emoji) {
            document.getElementById('editAvatarType').value = 'emoji';
            document.getElementById('editAvatarValue').value = emoji;
            updateEditAvatarPreview();
            hideEditEmojiSelector();
        }
        
        function handleEditAvatarUpload(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) { // 5MBé™åˆ¶
                    alert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5MB');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('editAvatarType').value = 'upload';
                    document.getElementById('editAvatarValue').value = e.target.result;
                    updateEditAvatarPreview();
                };
                reader.readAsDataURL(file);
            }
        }
        
        function resetEditToInitial() {
            document.getElementById('editAvatarType').value = 'initial';
            document.getElementById('editAvatarValue').value = '';
            updateEditAvatarPreview();
        }
        
        function updateEditAvatarPreview() {
            const avatarType = document.getElementById('editAvatarType').value;
            const avatarValue = document.getElementById('editAvatarValue').value;
            const preview = document.getElementById('editAvatarPreview');
            const characterName = document.getElementById('editCharacterName').value || 'A';
            
            if (avatarType === 'emoji' && avatarValue) {
                preview.style.cssText = 'width: 64px; height: 64px; background: #f3f4f6; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 32px;';
                preview.textContent = avatarValue;
            } else if (avatarType === 'upload' && avatarValue) {
                preview.style.cssText = 'width: 64px; height: 64px; border-radius: 50%; overflow: hidden; display: flex; align-items: center; justify-content: center;';
                preview.innerHTML = `<img src="${avatarValue}" alt="å¤´åƒ" style="width: 100%; height: 100%; object-fit: cover;">`;
            } else {
                // é»˜è®¤ä½¿ç”¨é¦–å­—æ¯å¤´åƒ
                preview.style.cssText = 'width: 64px; height: 64px; background: #6366f1; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: bold;';
                preview.textContent = characterName.charAt(0);
            }
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
    </script>
</body>
</html>